<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Vue-Router api | 王小明</title><meta name="keywords" content="vue3"><meta name="author" content="Decade W"><meta name="copyright" content="Decade W"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="vue-router api 阅读">
<meta property="og:type" content="article">
<meta property="og:title" content="Vue-Router api">
<meta property="og:url" content="http://blog.decade.run/2021/05/09/Vue-Router-api/index.html">
<meta property="og:site_name" content="王小明">
<meta property="og:description" content="vue-router api 阅读">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://blog.decade.run/img/coverimg/vue.jpg">
<meta property="article:published_time" content="2021-05-09T12:33:58.000Z">
<meta property="article:modified_time" content="2021-05-17T17:33:02.093Z">
<meta property="article:author" content="Decade W">
<meta property="article:tag" content="learn">
<meta property="article:tag" content="vueRouter">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://blog.decade.run/img/coverimg/vue.jpg"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="http://blog.decade.run/2021/05/09/Vue-Router-api/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Vue-Router api',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-05-18 01:33:02'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="王小明" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">57</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">20</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">17</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tag</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/coverimg/vue.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">王小明</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tag</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Vue-Router api</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-05-09T12:33:58.000Z" title="发表于 2021-05-09 20:33:58">2021-05-09</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-05-17T17:33:02.093Z" title="更新于 2021-05-18 01:33:02">2021-05-18</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/vueRouter/">vueRouter</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Vue-Router api"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="API-参考"><a href="#API-参考" class="headerlink" title="API 参考"></a>API 参考</h2><h3 id="router-link-Props"><a href="#router-link-Props" class="headerlink" title="router-link Props"></a>router-link Props</h3><h4 id="to"><a href="#to" class="headerlink" title="to"></a>to</h4><ul>
<li><p>类型 :  <code>RouteLocationRaw</code></p>
</li>
<li><p>详细内容</p>
<p>表示目标路由的链接, 当被点击后, 内部会立刻把 <code>to</code> 的值传到 <code>router.push()</code>, 所以这个值可以是一个 <code>string</code> 或者是描述目标位置的对象</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 字符串 --&gt;</span><br><span class="line">&lt;router-link to=&quot;/home&quot;&gt;Home&lt;/router-link&gt;</span><br><span class="line">&lt;!-- 渲染结果 --&gt;</span><br><span class="line">&lt;a href=&quot;/home&quot;&gt;Home&lt;/a&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- 使用 v-bind 的 JS 表达式 --&gt;</span><br><span class="line">&lt;router-link :to=&quot;&#x27;/home&#x27;&quot;&gt;Home&lt;/router-link&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- 同上 --&gt;</span><br><span class="line">&lt;router-link :to=&quot;&#123; path: &#x27;/home&#x27; &#125;&quot;&gt;Home&lt;/router-link&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- 命名的路由 --&gt;</span><br><span class="line">&lt;router-link :to=&quot;&#123; name: &#x27;user&#x27;, params: &#123; userId: &#x27;123&#x27; &#125;&#125;&quot;&gt;User&lt;/router-link&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- 带查询参数，下面的结果为 `/register?plan=private` --&gt;</span><br><span class="line">&lt;router-link :to=&quot;&#123; path: &#x27;/register&#x27;, query: &#123; plan: &#x27;private&#x27; &#125;&#125;&quot;&gt;</span><br><span class="line">  Register</span><br><span class="line">&lt;/router-link&gt;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="replace"><a href="#replace" class="headerlink" title="replace"></a>replace</h4><ul>
<li><p>类型:  <code>boolean</code></p>
</li>
<li><p>默认值:  <code>false</code></p>
</li>
<li><p>详细内容</p>
<p>设置 <code>replace</code> 属性的话, 当点击时, 会调用 <code>router.replace()</code>, 而不是 <code>router.push()</code>, 所以导航后不会留下历史记录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;router-link to=&quot;/abc&quot; replace&gt;&lt;/router-link&gt;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="active-class"><a href="#active-class" class="headerlink" title="active-class"></a>active-class</h4><ul>
<li><p>类型:  <code>string</code></p>
</li>
<li><p>默认值:  <code>&quot;router-link-active&quot;</code> 或者全局 <code>linkActiveClass</code> </p>
</li>
<li><p>详细内容</p>
<p>链接激活时，应用于渲染的 <code>&lt;a&gt;</code> 的 class</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;router-link to=&quot;/&quot; active-class=&quot;myActiveClass&quot;&gt;customLink&lt;/router-link&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> router = createRouter(&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="attr">linkActiveClass</span>: <span class="string">&#x27;customLinkActiveClass&#x27;</span>, <span class="comment">// 全局自定义 </span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="aria-current-value"><a href="#aria-current-value" class="headerlink" title="aria-current-value"></a>aria-current-value</h4><ul>
<li><p>类型  <code>&#39;page&#39; | &#39;step&#39; | &#39;location&#39; | &#39;date&#39; | &#39;time&#39; | &#39;true&#39; | &#39;false&#39;</code></p>
</li>
<li><p>默认值:  <code>&#39;page&#39;</code></p>
</li>
<li><p>详细内容</p>
<p>当链接激活时, 传递给属性 <code>aria-current</code> 的值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;router-link to=&quot;/&quot; active-class=&quot;myActiveClass&quot;&gt;customLink&lt;/router-link&gt;</span><br><span class="line">&lt;!-- 相当于 --&gt;</span><br><span class="line">&lt;a href=&quot;/&quot; class=&quot;myActiveClass router-link-exact-active&quot; aria-current=&quot;page&quot;&gt;customLink&lt;/a&gt;</span><br><span class="line"></span><br><span class="line">&lt;router-link to=&quot;/&quot; aria-current-value=&quot;step&quot;&gt;customLink&lt;/router-link&gt;</span><br><span class="line">&lt;!-- 相当于 --&gt;</span><br><span class="line">&lt;a href=&quot;/&quot; class=&quot;router-link-active router-link-exact-active&quot; aria-current=&quot;step&quot;&gt;customLink&lt;/a&gt;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="costom"><a href="#costom" class="headerlink" title="costom"></a>costom</h4><ul>
<li><p>类型:  <code>boolean</code></p>
</li>
<li><p>默认值:  <code>false</code></p>
</li>
<li><p>详细内容</p>
<p><code>&lt;router-link&gt;</code> 是否应该将其内容包裹在 <code>&lt;a&gt;</code> 元素中, 在使用 <code>v-slot</code> 创建自定义 RouterLink 时很有用, 默认情况下, <code>&lt;router-link&gt;</code> 会将其内容包裹在 <code>&lt;a&gt;</code> 元素中, 即使使用 <code>v-slot</code> 也是如此, 传递<code>自定义的</code> prop, 可以去除这种行为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;router-link</span><br><span class="line">    to=&quot;/home&quot;</span><br><span class="line">    custom</span><br><span class="line">    v-slot=&quot;&#123; route, navigate&#125;&quot;</span><br><span class="line">  &gt;</span><br><span class="line">    &lt;li</span><br><span class="line">      @click=&quot;navigate&quot;</span><br><span class="line">    &gt;</span><br><span class="line">    &#123;&#123; route.fullPath &#125;&#125;</span><br><span class="line">    &lt;/li&gt;</span><br><span class="line">  &lt;/router-link&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- 相当于 --&gt;</span><br><span class="line">&lt;li&gt;/home&lt;/li&gt;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="exact-active-class"><a href="#exact-active-class" class="headerlink" title="exact-active-class"></a>exact-active-class</h4><ul>
<li><p>类型:  <code>string</code></p>
</li>
<li><p>默认值:  <code>&quot;router-link-exact-active&quot;</code> 全局 <code>linkExactActiveClass</code></p>
</li>
<li><p>详细内容</p>
<p>链接精准激活时, 应用于渲染的 <code>&lt;a&gt;</code> 的 class</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;router-link to=&quot;/&quot; exact-active-class=&quot;exactActiveClass&quot;&gt;xxx&lt;/router-link&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> router = createRouter(&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="attr">linkExactActiveClass</span>: <span class="string">&#x27;linkExactActiveClass&#x27;</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>渲染成</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/&quot;</span> <span class="attr">class</span>=<span class="string">&quot;router-link-active exactActiveClass&quot;</span> <span class="attr">aria-current</span>=<span class="string">&quot;page&quot;</span>&gt;</span>customLink<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="router-link-的-v-slot"><a href="#router-link-的-v-slot" class="headerlink" title="router-link   的   v-slot"></a>router-link   的   v-slot</h3><p><code>&lt;router-link&gt;</code> 通过一个作用域插槽暴露底层的定制能力, 这是一个更高阶的 API, 主要面向库作者, 但也可以为开发者提供便利, 大多数情况下用在一个类似 <em>NavLink</em> 这样的组件里</p>
<blockquote>
<p>注意</p>
<p>记得把 <code>custom</code> 配置传递给 <code>&lt;router-link&gt;</code>, 以防止它将内容包裹在 <code>&lt;a&gt;</code> 元素内</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;router-link</span><br><span class="line">  to=&quot;/about&quot;</span><br><span class="line">  custom</span><br><span class="line">  v-slot=&quot;&#123; href, route, navigate, isActive, isExactActive &#125;&quot;</span><br><span class="line">&gt;</span><br><span class="line">  &lt;NavLink :active=&quot;isActive&quot; :href=&quot;href&quot; @click=&quot;navigate&quot;&gt;</span><br><span class="line">    &#123;&#123; route.fullPath &#125;&#125;</span><br><span class="line">  &lt;/NavLink&gt;</span><br><span class="line">&lt;/router-link&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>href</code>：解析后的 URL, 将会作为一个 <code>&lt;a&gt;</code> 元素的 <code>href</code> 属性, 如果什么都没提供, 则它会包含 <code>base</code></li>
<li><code>route</code>：解析后的规范化的地址</li>
<li><code>navigate</code>：触发导航的函数,  <strong>会在必要时自动阻止事件</strong>, 和 <code>router-link</code> 一样, 例如：<code>ctrl</code> 或者 <code>cmd</code> + 点击仍然会被 <code>navigate</code> 忽略</li>
<li><code>isActive</code>：如果需要应用 active class, 则为 <code>true</code>, 允许应用一个任意的 class</li>
<li><code>isExactActive</code>：如果需要应用 exact active class，则为 <code>true</code>, 允许应用一个任意的 class</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;router-link</span><br><span class="line">  to=&quot;/about&quot;</span><br><span class="line">  custom</span><br><span class="line">  v-slot=&quot;&#123; route, navigate, href&#125;&quot;</span><br><span class="line">&gt;</span><br><span class="line">  &lt;a</span><br><span class="line">    :href=&quot;href&quot;</span><br><span class="line">    target=&quot;_blank&quot;</span><br><span class="line">  &gt;</span><br><span class="line">  &#123;&#123; route.fullPath &#125;&#125;</span><br><span class="line">  &lt;/a&gt;</span><br><span class="line">&lt;/router-link&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>提示</p>
<p>如果你在 <code>a</code> 元素上添加一个 <code>target=&quot;_blank&quot;</code>, 你必须省略 <code>@click=&quot;navigate&quot;</code> 的处理</p>
</blockquote>
<h3 id="router-link-源码"><a href="#router-link-源码" class="headerlink" title="router-link 源码"></a>router-link 源码</h3><p><code>src/RouterLink.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// router-link props</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> RouterLinkOptions &#123;</span><br><span class="line">  <span class="attr">to</span>: RouteLocationRaw <span class="comment">// 跳转</span></span><br><span class="line">  replace?: <span class="built_in">boolean</span> <span class="comment">// 是否启用 router.replace 代替 router.push</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// router-link props</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> RouterLinkProps <span class="keyword">extends</span> RouterLinkOptions &#123;</span><br><span class="line">  custom?: <span class="built_in">boolean</span> <span class="comment">// 是否用户自定义 </span></span><br><span class="line">  activeClass?: <span class="built_in">string</span> <span class="comment">// 激活路由的样式</span></span><br><span class="line">  exactActiveClass?: <span class="built_in">string</span> <span class="comment">// 精确路由的激活样式</span></span><br><span class="line">  ariaCurrentValue?: <span class="comment">// a标签上的 aria-current的值</span></span><br><span class="line">    | <span class="string">&#x27;page&#x27;</span></span><br><span class="line">    | <span class="string">&#x27;step&#x27;</span></span><br><span class="line">    | <span class="string">&#x27;location&#x27;</span></span><br><span class="line">    | <span class="string">&#x27;date&#x27;</span></span><br><span class="line">    | <span class="string">&#x27;time&#x27;</span></span><br><span class="line">    | <span class="string">&#x27;true&#x27;</span></span><br><span class="line">    | <span class="string">&#x27;false&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> UseLinkOptions = VueUseOptions&lt;RouterLinkOptions&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// useLink hook</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">useLink</span>(<span class="params">props: UseLinkOptions</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> router = inject(routerKey)! <span class="comment">// 获取 router 这个router 就是 我们调用 createRouter生成的那个router</span></span><br><span class="line">  <span class="keyword">const</span> currentRoute = inject(routeLocationKey)! <span class="comment">// 获取当前路由</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> route = computed(<span class="function">() =&gt;</span> router.resolve(unref(props.to))) <span class="comment">// 计算属性 计算route</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 计算属性 route 在 record 中的index</span></span><br><span class="line">  <span class="keyword">const</span> activeRecordIndex = computed&lt;<span class="built_in">number</span>&gt;(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> &#123; matched &#125; = route.value</span><br><span class="line">    <span class="keyword">let</span> &#123; length &#125; = matched</span><br><span class="line">    <span class="keyword">const</span> routeMatched: RouteRecord | <span class="literal">undefined</span> = matched[length - <span class="number">1</span>]</span><br><span class="line">    <span class="keyword">let</span> currentMatched = currentRoute.matched</span><br><span class="line">    <span class="keyword">if</span> (!routeMatched || !currentMatched.length) <span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line">    <span class="keyword">let</span> index = currentMatched.findIndex(</span><br><span class="line">      isSameRouteRecord.bind(<span class="literal">null</span>, routeMatched)</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">if</span> (index &gt; -<span class="number">1</span>) <span class="keyword">return</span> index</span><br><span class="line">    <span class="comment">// possible parent record</span></span><br><span class="line">    <span class="keyword">let</span> parentRecordPath = getOriginalPath(</span><br><span class="line">      matched[length - <span class="number">2</span>] <span class="keyword">as</span> RouteRecord | <span class="literal">undefined</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="comment">// we are dealing with nested routes</span></span><br><span class="line">      length &gt; <span class="number">1</span> &amp;&amp;</span><br><span class="line">        <span class="comment">// if the parent and matched route have the same path, this link is</span></span><br><span class="line">        <span class="comment">// referring to the empty child. Or we currently are on a different</span></span><br><span class="line">        <span class="comment">// child of the same parent</span></span><br><span class="line">        getOriginalPath(routeMatched) === parentRecordPath &amp;&amp;</span><br><span class="line">        <span class="comment">// avoid comparing the child with its parent</span></span><br><span class="line">        currentMatched[currentMatched.length - <span class="number">1</span>].path !== parentRecordPath</span><br><span class="line">        ? currentMatched.findIndex(</span><br><span class="line">            isSameRouteRecord.bind(<span class="literal">null</span>, matched[length - <span class="number">2</span>])</span><br><span class="line">          )</span><br><span class="line">        : index</span><br><span class="line">    )</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 计算属性 是否是 active</span></span><br><span class="line">  <span class="keyword">const</span> isActive = computed&lt;<span class="built_in">boolean</span>&gt;(</span><br><span class="line">    <span class="function">() =&gt;</span></span><br><span class="line">      activeRecordIndex.value &gt; -<span class="number">1</span> &amp;&amp;</span><br><span class="line">      includesParams(currentRoute.params, route.value.params)</span><br><span class="line">  )</span><br><span class="line">  <span class="comment">// 计算属性 是否是 exactActive</span></span><br><span class="line">  <span class="keyword">const</span> isExactActive = computed&lt;<span class="built_in">boolean</span>&gt;(</span><br><span class="line">    <span class="function">() =&gt;</span></span><br><span class="line">      activeRecordIndex.value &gt; -<span class="number">1</span> &amp;&amp;</span><br><span class="line">      activeRecordIndex.value === currentRoute.matched.length - <span class="number">1</span> &amp;&amp;</span><br><span class="line">      isSameRouteLocationParams(currentRoute.params, route.value.params)</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 跳转的方法 navigate</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">navigate</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    e: MouseEvent = &#123;&#125; <span class="keyword">as</span> MouseEvent</span></span></span><br><span class="line"><span class="params"><span class="function">  </span>): <span class="title">Promise</span>&lt;<span class="title">void</span> | <span class="title">NavigationFailure</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (guardEvent(e))</span><br><span class="line">      <span class="keyword">return</span> router[unref(props.replace) ? <span class="string">&#x27;replace&#x27;</span> : <span class="string">&#x27;push&#x27;</span>](unref(props.to))</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    route,</span><br><span class="line">    <span class="attr">href</span>: computed(<span class="function">() =&gt;</span> route.value.href),</span><br><span class="line">    isActive,</span><br><span class="line">    isExactActive,</span><br><span class="line">    navigate,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// routerLink 组件</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> RouterLinkImpl = <span class="comment">/*#__PURE__*/</span> defineComponent(&#123;</span><br><span class="line">  <span class="comment">// 组件名称</span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;RouterLink&#x27;</span>,</span><br><span class="line">  <span class="comment">// 传入的props</span></span><br><span class="line">  <span class="attr">props</span>: &#123;</span><br><span class="line">    <span class="attr">to</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: [<span class="built_in">String</span>, <span class="built_in">Object</span>] <span class="keyword">as</span> PropType&lt;RouteLocationRaw&gt;,</span><br><span class="line">      required: <span class="literal">true</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">replace</span>: <span class="built_in">Boolean</span>,</span><br><span class="line">    <span class="attr">activeClass</span>: <span class="built_in">String</span>,</span><br><span class="line">    <span class="comment">// inactiveClass: String,</span></span><br><span class="line">    <span class="attr">exactActiveClass</span>: <span class="built_in">String</span>,</span><br><span class="line">    <span class="attr">custom</span>: <span class="built_in">Boolean</span>,</span><br><span class="line">    <span class="attr">ariaCurrentValue</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="built_in">String</span> <span class="keyword">as</span> PropType&lt;RouterLinkProps[<span class="string">&#x27;ariaCurrentValue&#x27;</span>]&gt;,</span><br><span class="line">      <span class="keyword">default</span>: <span class="string">&#x27;page&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">setup</span>(<span class="params">props, &#123; slots &#125;</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> link = reactive(useLink(props)) <span class="comment">// 返回的link 包含 route href isActive isExactActive navigate</span></span><br><span class="line">    <span class="keyword">const</span> &#123; options &#125; = inject(routerKey)! <span class="comment">// 取出 route的options , 这里的options 就是我们 调用 createRouter传入的那个对象</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算属性 元素的class</span></span><br><span class="line">    <span class="keyword">const</span> elClass = computed(<span class="function">() =&gt;</span> (&#123;</span><br><span class="line">      [getLinkClass(</span><br><span class="line">        props.activeClass, <span class="comment">// 如果 routerLink中 传入activeClass 就用这个样式</span></span><br><span class="line">        options.linkActiveClass, <span class="comment">// routerLink中没有传入 但是 在createRouter传入的那个options 定义了linkActiveClass 就用这个</span></span><br><span class="line">        <span class="string">&#x27;router-link-active&#x27;</span> <span class="comment">// 默认样式</span></span><br><span class="line">      )]: link.isActive,</span><br><span class="line">      [getLinkClass(</span><br><span class="line">        props.exactActiveClass, <span class="comment">// 如果 routerLink中 传入exactActiveClass就用这个样式</span></span><br><span class="line">        options.linkExactActiveClass, <span class="comment">// routerLink中没有传入 但是 在createRouter传入的那个options 定义了linkExactActiveClass 就用这个</span></span><br><span class="line">        <span class="string">&#x27;router-link-exact-active&#x27;</span> <span class="comment">// 默认样式</span></span><br><span class="line">      )]: link.isExactActive,</span><br><span class="line">    &#125;))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 开发环境 或者 支持 props的 开发工具 且 是在 浏览器下</span></span><br><span class="line">    <span class="keyword">if</span> ((__DEV__ || __FEATURE_PROD_DEVTOOLS__) &amp;&amp; __BROWSER__) &#123;</span><br><span class="line">      <span class="keyword">const</span> instance = getCurrentInstance() <span class="comment">// 获取当前实例</span></span><br><span class="line">      <span class="comment">// 使用 watchEffect</span></span><br><span class="line">      watchEffect(</span><br><span class="line">        <span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (!instance) <span class="keyword">return</span> <span class="comment">// 不存在 当前实例 返回</span></span><br><span class="line">          ;(instance <span class="keyword">as</span> <span class="built_in">any</span>).__vrl_route = link.route <span class="comment">// 否则就给 instance.__vrl_route赋值</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123; <span class="attr">flush</span>: <span class="string">&#x27;post&#x27;</span> &#125; <span class="comment">// post 队列</span></span><br><span class="line">      )</span><br><span class="line">      watchEffect(</span><br><span class="line">        <span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (!instance) <span class="keyword">return</span></span><br><span class="line">          ;(instance <span class="keyword">as</span> <span class="built_in">any</span>).__vrl_active = link.isActive</span><br><span class="line">          ;(instance <span class="keyword">as</span> <span class="built_in">any</span>).__vrl_exactActive = link.isExactActive</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123; <span class="attr">flush</span>: <span class="string">&#x27;post&#x27;</span> &#125;</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 如果 setup方法的执行结果 返回的是一个方法 将会作为一个render方法</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> children = slots.default &amp;&amp; slots.default(link) <span class="comment">// 存在 v-slot</span></span><br><span class="line">      <span class="keyword">return</span> props.custom <span class="comment">// 如果是用户 自定义 就用插槽 否则用默认的 h方法</span></span><br><span class="line">        ? children</span><br><span class="line">      	<span class="comment">// 否则用默认的 h方法 创建一个 a标签</span></span><br><span class="line">        : h(</span><br><span class="line">            <span class="string">&#x27;a&#x27;</span>,</span><br><span class="line">        		<span class="comment">// 定义属性</span></span><br><span class="line">            &#123;</span><br><span class="line">              <span class="string">&#x27;aria-current&#x27;</span>: link.isExactActive</span><br><span class="line">                ? props.ariaCurrentValue</span><br><span class="line">                : <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">href</span>: link.href,</span><br><span class="line">              <span class="attr">onClick</span>: link.navigate, <span class="comment">// 点击事件 触发navigate 方法</span></span><br><span class="line">              <span class="attr">class</span>: elClass.value,</span><br><span class="line">            &#125;,</span><br><span class="line">        		<span class="comment">// 放入 children</span></span><br><span class="line">            children</span><br><span class="line">          )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="router-view-Props"><a href="#router-view-Props" class="headerlink" title="router-view Props"></a>router-view Props</h3><h4 id="name"><a href="#name" class="headerlink" title="name"></a>name</h4><ul>
<li><p>类型:  <code>string</code></p>
</li>
<li><p>默认值:  <code>default</code></p>
</li>
<li><p>详细内容</p>
<p>如果 <code>&lt;router-view&gt;</code> 设置了 <code>name</code>, 则会渲染对应的路由配置中 <code>components</code> 下的相应组件</p>
</li>
<li><p>命名视图</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;router-view class=&quot;view left-sidebar&quot; name=&quot;LeftSidebar&quot;&gt;&lt;/router-view&gt;</span><br><span class="line">&lt;router-view class=&quot;view main-content&quot;&gt;&lt;/router-view&gt;</span><br><span class="line">&lt;router-view class=&quot;view right-sidebar&quot; name=&quot;RightSidebar&quot;&gt;&lt;/router-view&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">    <span class="attr">components</span>: &#123;</span><br><span class="line">      <span class="attr">default</span>: Home,</span><br><span class="line">      <span class="comment">// LeftSidebar: LeftSidebar 的缩写</span></span><br><span class="line">      LeftSidebar,</span><br><span class="line">      <span class="comment">// 它们与 `&lt;router-view&gt;` 上的 `name` 属性匹配</span></span><br><span class="line">      RightSidebar,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">],</span><br><span class="line"><span class="keyword">const</span> router = createRouter(&#123;</span><br><span class="line">  <span class="attr">history</span>: createWebHashHistory(),</span><br><span class="line">  routes,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="route"><a href="#route" class="headerlink" title="route"></a>route</h4><ul>
<li><p>类型:  <code>RouteLocationNormalized</code></p>
</li>
<li><p>详细内容</p>
<p>一个路由地址的所有组件都已被解析（如果所有组件都被懒加载），因此可以显示</p>
</li>
</ul>
<h4 id="router-view-的-v-slot"><a href="#router-view-的-v-slot" class="headerlink" title="router-view 的 v-slot"></a>router-view 的 v-slot</h4><p><code>&lt;router-view&gt;</code> 暴露了一个 <code>v-slot</code> API, 主要使用 <code>&lt;transition&gt;</code> 和 <code>&lt;keep-alive&gt;</code> 组件来包裹你的路由组件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;router-view v-slot=&quot;&#123; Component, route &#125;&quot;&gt;</span><br><span class="line">  &#123;&#123; route &#125;&#125;</span><br><span class="line">  &lt;component :is=&quot;Component&quot;&gt;&lt;/component&gt;</span><br><span class="line">&lt;/router-view&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>Component</code>: 要传递给 <code>&lt;component&gt;</code> 的 VNodes <code>是</code> prop</li>
<li><code>route</code>: 解析出的标准化路由地址</li>
</ul>
<h4 id="router-view源码"><a href="#router-view源码" class="headerlink" title="router-view源码"></a>router-view源码</h4><p><code>src/RouterView.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// router-view 的props</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> RouterViewProps &#123;</span><br><span class="line">  name?: <span class="built_in">string</span> <span class="comment">// 命名视图</span></span><br><span class="line">  route?: RouteLocationNormalized  <span class="comment">// 完成的路由信息</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// router-view 组件</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> RouterViewImpl = <span class="comment">/*#__PURE__*/</span> defineComponent(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;RouterView&#x27;</span>, <span class="comment">// 组件名称</span></span><br><span class="line">  <span class="attr">inheritAttrs</span>: <span class="literal">false</span>, <span class="comment">// 没有继承样式啥的</span></span><br><span class="line">  <span class="comment">// 属性</span></span><br><span class="line">  <span class="attr">props</span>: &#123;</span><br><span class="line">    <span class="attr">name</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="built_in">String</span> <span class="keyword">as</span> PropType&lt;<span class="built_in">string</span>&gt;,</span><br><span class="line">      <span class="keyword">default</span>: <span class="string">&#x27;default&#x27;</span>,  <span class="comment">// 默认 default</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">route</span>: <span class="built_in">Object</span> <span class="keyword">as</span> PropType&lt;RouteLocationNormalizedLoaded&gt;,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// setup 方法</span></span><br><span class="line">  <span class="function"><span class="title">setup</span>(<span class="params">props, &#123; attrs, slots &#125;</span>)</span> &#123;</span><br><span class="line">    __DEV__ &amp;&amp; warnDeprecatedUsage() <span class="comment">// 开发环境下 检测父节点 是不是 keepAlive 或者 transtion </span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> injectedRoute = inject(routerViewLocationKey)! <span class="comment">// 取出注入的 route</span></span><br><span class="line">    <span class="keyword">const</span> routeToDisplay = computed(<span class="function">() =&gt;</span> props.route || injectedRoute.value) <span class="comment">//  展示路由 props 传入的 route 还是 注入的route的route</span></span><br><span class="line">    <span class="keyword">const</span> depth = inject(viewDepthKey, <span class="number">0</span>) <span class="comment">// 深度</span></span><br><span class="line">    <span class="comment">// 匹配的route</span></span><br><span class="line">    <span class="keyword">const</span> matchedRouteRef = computed&lt;RouteLocationMatched | <span class="literal">undefined</span>&gt;(</span><br><span class="line">      <span class="function">() =&gt;</span> routeToDisplay.value.matched[depth]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    provide(viewDepthKey, depth + <span class="number">1</span>) <span class="comment">// 修改深度</span></span><br><span class="line">    provide(matchedRouteKey, matchedRouteRef) <span class="comment">// 修改匹配的路由</span></span><br><span class="line">    provide(routerViewLocationKey, routeToDisplay) <span class="comment">// 修改当前展示的路由</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> viewRef = ref&lt;ComponentPublicInstance&gt;()</span><br><span class="line">		</span><br><span class="line">    <span class="comment">// 视图变化, 路由变化, 名字变化 都会触发watch</span></span><br><span class="line">    watch(</span><br><span class="line">      <span class="function">() =&gt;</span> [viewRef.value, matchedRouteRef.value, props.name] <span class="keyword">as</span> <span class="keyword">const</span>,</span><br><span class="line">      <span class="function">(<span class="params">[instance, to, name], [oldInstance, <span class="keyword">from</span>, oldName]</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (to) &#123;</span><br><span class="line">          to.instances[name] = instance <span class="comment">// 将变化的instance 添加到to.instances 对象里面</span></span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">from</span> &amp;&amp; <span class="keyword">from</span> !== to &amp;&amp; instance &amp;&amp; instance === oldInstance) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!to.leaveGuards.size) &#123; <span class="comment">// 如果 新跳转到的 路由 的 leaveGuards(离开守卫) 为0 我们则需要把 之前from 的 离开守卫 赋值给 to</span></span><br><span class="line">              to.leaveGuards = <span class="keyword">from</span>.leaveGuards</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!to.updateGuards.size) &#123; <span class="comment">// 如果 新跳转到的 路由 的 updateGuards(更新守卫) 为0 我们则需要把 之前from 的 更新守卫 赋值给 to</span></span><br><span class="line">              to.updateGuards = <span class="keyword">from</span>.updateGuards</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 触发 beforeRouteEnter 钩子</span></span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">          instance &amp;&amp;</span><br><span class="line">          to &amp;&amp;</span><br><span class="line">          (!<span class="keyword">from</span> || !isSameRouteRecord(to, <span class="keyword">from</span>) || !oldInstance)</span><br><span class="line">        ) &#123;</span><br><span class="line">          ;(to.enterCallbacks[name] || []).forEach(<span class="function"><span class="params">callback</span> =&gt;</span></span><br><span class="line">            callback(instance)</span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123; <span class="attr">flush</span>: <span class="string">&#x27;post&#x27;</span> &#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> route = routeToDisplay.value</span><br><span class="line">      <span class="keyword">const</span> matchedRoute = matchedRouteRef.value</span><br><span class="line">      <span class="keyword">const</span> ViewComponent = matchedRoute &amp;&amp; matchedRoute.components[props.name]</span><br><span class="line">      <span class="keyword">const</span> currentName = props.name</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 不存在 组件时 展示插槽</span></span><br><span class="line">      <span class="keyword">if</span> (!ViewComponent) &#123;</span><br><span class="line">        <span class="keyword">return</span> normalizeSlot(slots.default, &#123; <span class="attr">Component</span>: ViewComponent, route &#125;)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> routePropsOption = matchedRoute!.props[props.name]</span><br><span class="line">      <span class="keyword">const</span> routeProps = routePropsOption</span><br><span class="line">        ? routePropsOption === <span class="literal">true</span></span><br><span class="line">          ? route.params</span><br><span class="line">          : <span class="keyword">typeof</span> routePropsOption === <span class="string">&#x27;function&#x27;</span></span><br><span class="line">          ? routePropsOption(route)</span><br><span class="line">          : routePropsOption</span><br><span class="line">        : <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 卸载</span></span><br><span class="line">      <span class="keyword">const</span> onVnodeUnmounted: VNodeProps[<span class="string">&#x27;onVnodeUnmounted&#x27;</span>] = <span class="function"><span class="params">vnode</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// remove the instance reference to prevent leak</span></span><br><span class="line">        <span class="keyword">if</span> (vnode.component!.isUnmounted) &#123;</span><br><span class="line">          matchedRoute!.instances[currentName] = <span class="literal">null</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 生成一个 component</span></span><br><span class="line">      <span class="keyword">const</span> component = h(</span><br><span class="line">        ViewComponent,</span><br><span class="line">        assign(&#123;&#125;, routeProps, attrs, &#123;</span><br><span class="line">          onVnodeUnmounted,</span><br><span class="line">          <span class="attr">ref</span>: viewRef,</span><br><span class="line">        &#125;)</span><br><span class="line">      )</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">return</span> (</span><br><span class="line">        normalizeSlot(slots.default, &#123; <span class="attr">Component</span>: component, route &#125;) ||</span><br><span class="line">        component</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 正常话 slot</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">normalizeSlot</span>(<span class="params">slot: Slot | <span class="literal">undefined</span>, data: <span class="built_in">any</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!slot) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">  <span class="keyword">const</span> slotContent = slot(data)</span><br><span class="line">  <span class="keyword">return</span> slotContent.length === <span class="number">1</span> ? slotContent[<span class="number">0</span>] : slotContent</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 导出的RouterView </span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> RouterView = (RouterViewImpl <span class="keyword">as</span> <span class="built_in">any</span>) <span class="keyword">as</span> &#123;</span><br><span class="line">  <span class="keyword">new</span> (): &#123;</span><br><span class="line">    <span class="attr">$props</span>: AllowedComponentProps &amp;</span><br><span class="line">      ComponentCustomProps &amp;</span><br><span class="line">      VNodeProps &amp;</span><br><span class="line">      RouterViewProps</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">warnDeprecatedUsage</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> instance = getCurrentInstance()!</span><br><span class="line">  <span class="keyword">const</span> parentName = instance.parent &amp;&amp; instance.parent.type.name</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    parentName &amp;&amp;</span><br><span class="line">    (parentName === <span class="string">&#x27;KeepAlive&#x27;</span> || parentName.includes(<span class="string">&#x27;Transition&#x27;</span>))</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">const</span> comp = parentName === <span class="string">&#x27;KeepAlive&#x27;</span> ? <span class="string">&#x27;keep-alive&#x27;</span> : <span class="string">&#x27;transition&#x27;</span></span><br><span class="line">    warn(</span><br><span class="line">      <span class="string">`&lt;router-view&gt; can no longer be used directly inside &lt;transition&gt; or &lt;keep-alive&gt;.\n`</span> +</span><br><span class="line">        <span class="string">`Use slot props instead:\n\n`</span> +</span><br><span class="line">        <span class="string">`&lt;router-view v-slot=&quot;&#123; Component &#125;&quot;&gt;\n`</span> +</span><br><span class="line">        <span class="string">`  &lt;<span class="subst">$&#123;comp&#125;</span>&gt;\n`</span> +</span><br><span class="line">        <span class="string">`    &lt;component :is=&quot;Component&quot; /&gt;\n`</span> +</span><br><span class="line">        <span class="string">`  &lt;/<span class="subst">$&#123;comp&#125;</span>&gt;\n`</span> +</span><br><span class="line">        <span class="string">`&lt;/router-view&gt;`</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="createRouter"><a href="#createRouter" class="headerlink" title="createRouter"></a>createRouter</h3><p>创建一个可以被 Vue 应用程序使用的路由实例</p>
<p>函数签名</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">declare</span> <span class="function"><span class="keyword">function</span> <span class="title">createRouter</span>(<span class="params">options: RouterOptions</span>): <span class="title">Router</span></span></span><br></pre></td></tr></table></figure>

<p>参数: </p>
<table>
<thead>
<tr>
<th align="center">参数</th>
<th align="center">类型</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">options</td>
<td align="center">RouterOptions</td>
<td align="center">Options 用来初始化 router</td>
</tr>
</tbody></table>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> _PathParserOptions &#123;</span><br><span class="line">  sensitive?: <span class="built_in">boolean</span> <span class="comment">// RegExp区分大小写 默认 false</span></span><br><span class="line">  strict?: <span class="built_in">boolean</span> <span class="comment">// 是否应该禁止在斜线后面加上斜线 默认 false</span></span><br><span class="line">  start?: <span class="built_in">boolean</span> <span class="comment">// RegExp是否应该通过在开头添加一个^来匹配 默认 true</span></span><br><span class="line">  end?: <span class="built_in">boolean</span> <span class="comment">// RegExp是否应该通过在末尾附加一个$来匹配 默认 true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Pick 挑选 从 _PathParserOptions 挑选出 &#x27;end&#x27; &#x27;sensitive&#x27; &#x27;strict&#x27; 重新组成一个类型 PathParserOptions</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> PathParserOptions = Pick&lt;</span><br><span class="line">  _PathParserOptions,</span><br><span class="line">  <span class="string">&#x27;end&#x27;</span> | <span class="string">&#x27;sensitive&#x27;</span> | <span class="string">&#x27;strict&#x27;</span></span><br><span class="line">&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> HistoryLocation = <span class="built_in">string</span> <span class="comment">// string的别名</span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">type</span> HistoryStateValue =</span><br><span class="line">  | <span class="built_in">string</span></span><br><span class="line">  | <span class="built_in">number</span></span><br><span class="line">  | <span class="built_in">boolean</span></span><br><span class="line">  | <span class="literal">null</span></span><br><span class="line">  | <span class="literal">undefined</span></span><br><span class="line">  | HistoryState</span><br><span class="line">  | HistoryStateArray</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> HistoryState &#123;</span><br><span class="line">  [x: <span class="built_in">number</span>]: HistoryStateValue</span><br><span class="line">  [x: <span class="built_in">string</span>]: HistoryStateValue</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> RouterHistory &#123;</span><br><span class="line">  <span class="keyword">readonly</span> base: <span class="built_in">string</span> <span class="comment">// 基础路径</span></span><br><span class="line">  <span class="keyword">readonly</span> location: HistoryLocation <span class="comment">// 当前的记录位置</span></span><br><span class="line">  <span class="keyword">readonly</span> state: HistoryState <span class="comment">// 当前记录的状态</span></span><br><span class="line">  <span class="comment">// readonly location: ValueContainer&lt;HistoryLocationNormalized&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// push 方法 跳转到相应的路由</span></span><br><span class="line">  push(to: HistoryLocation, data?: HistoryState): <span class="built_in">void</span></span><br><span class="line">  <span class="comment">// replace 方法 也有跳转 但是 不会进入记录里面 </span></span><br><span class="line">  replace(to: HistoryLocation, data?: HistoryState): <span class="built_in">void</span></span><br><span class="line">  <span class="comment">// 前进 第二个参数为是否添加到监听历史里面</span></span><br><span class="line">  go(delta: <span class="built_in">number</span>, triggerListeners?: <span class="built_in">boolean</span>): <span class="built_in">void</span></span><br><span class="line">  <span class="comment">// 监听 返回值是一个销毁listen 的函数</span></span><br><span class="line">  listen(callback: NavigationCallback): <span class="function">() =&gt;</span> <span class="built_in">void</span></span><br><span class="line">  <span class="comment">// 创建一个 href</span></span><br><span class="line">  createHref(location: HistoryLocation): <span class="built_in">string</span></span><br><span class="line">  <span class="comment">// 清除所有的事件</span></span><br><span class="line">  destroy(): <span class="built_in">void</span></span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> RouterScrollBehavior &#123;</span><br><span class="line">  (</span><br><span class="line">    to: RouteLocationNormalized, <span class="comment">// 到哪个页面</span></span><br><span class="line">    <span class="attr">from</span>: RouteLocationNormalizedLoaded, <span class="comment">// 从哪个页面去</span></span><br><span class="line">    <span class="attr">savedPosition</span>: _ScrollPositionNormalized | <span class="literal">null</span> <span class="comment">// 存放 top, left , behavior 的对象</span></span><br><span class="line">  ): Awaitable&lt;ScrollPosition | <span class="literal">false</span> | <span class="built_in">void</span>&gt; <span class="comment">// 返回值是一个 promise</span></span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> ScrollPositionCoordinates = &#123;</span><br><span class="line">  behavior?: ScrollOptions[<span class="string">&#x27;behavior&#x27;</span>] <span class="comment">// &quot;auto&quot; | &quot;smooth&quot;</span></span><br><span class="line">  left?: <span class="built_in">number</span> <span class="comment">// 距左边距离</span></span><br><span class="line">  top?: <span class="built_in">number</span> <span class="comment">// 距顶部记录</span></span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="comment">// RouterOptions </span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> RouterOptions <span class="keyword">extends</span> PathParserOptions &#123;</span><br><span class="line">  <span class="attr">history</span>: RouterHistory <span class="comment">// 路由器的使用历史记录</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">		createMemoryHistory:  创建基于内存的历史记录 通常用于SSR</span></span><br><span class="line"><span class="comment">		createWebHashHistory: 创建 hash 路由  可用于没有主机的 web	应用程序</span></span><br><span class="line"><span class="comment">		createWebHistory: 创建 HTML5 历史记录 , 通常用于SPA	</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">  <span class="attr">routes</span>: RouteRecordRaw[] <span class="comment">// 用户的路由</span></span><br><span class="line">  scrollBehavior?: RouterScrollBehavior <span class="comment">// from 到 to 页面跳转时可以控制其 页面滑动到多少多少位置 类似锚点 返回值一个promise </span></span><br><span class="line">  parseQuery?: <span class="keyword">typeof</span> originalParseQuery <span class="comment">// 自定义解析查询</span></span><br><span class="line">  stringifyQuery?: <span class="keyword">typeof</span> originalStringifyQuery <span class="comment">// 自定义实现以对查询对象进行字符串化</span></span><br><span class="line">  linkActiveClass?: <span class="built_in">string</span> <span class="comment">// router-link h函数那里会使用这个 router-link props 和 这里没有定义 默认就是 router-link-active</span></span><br><span class="line">  linkExactActiveClass?: <span class="built_in">string</span> <span class="comment">// router-link h函数那里会使用这个 router-link props 和 这里没有定义 默认就是 router-link-exact-active</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 例子</span></span><br><span class="line"><span class="keyword">import</span> qs <span class="keyword">from</span> <span class="string">&#x27;qs&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  createRouter,</span><br><span class="line">  createWebHistory,</span><br><span class="line">  parseQuery,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;vue-router&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> router = createRouter(&#123;</span><br><span class="line">  <span class="attr">history</span>: createWebHistory(process.env.BASE_URL),</span><br><span class="line">  routes,</span><br><span class="line">  <span class="function"><span class="title">scrollBehavior</span>(<span class="params">to, <span class="keyword">from</span>, savePosition</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">top</span>: <span class="number">100</span>,</span><br><span class="line">      <span class="attr">left</span>: <span class="number">100</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  parseQuery, <span class="comment">// 官方源码位置给的 qs.parse 但是在ts 中会报类型不能兼容的错误, 这里的 parseQuery 是官方自己写好的 从 vue-router导出来就好了</span></span><br><span class="line">  <span class="attr">stringifyQuery</span>: qs.stringify,</span><br><span class="line">  <span class="attr">linkActiveClass</span>: <span class="string">&#x27;activeClass&#x27;</span>,</span><br><span class="line">  <span class="attr">linkExactActiveClass</span>: <span class="string">&#x27;exactActiveClass&#x27;</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 哈希 的历史记录</span></span><br><span class="line"><span class="keyword">const</span> hashRouter = createRouter(&#123;</span><br><span class="line">  <span class="attr">history</span>: createWebHashHistory(), <span class="comment">// 没有 base，应用托管在域名 `https://example.com` 的根目录下 有就在 https://example.com/base/</span></span><br><span class="line">  routes,</span><br><span class="line">&#125;); </span><br><span class="line"></span><br><span class="line"><span class="comment">// 内存 的历史记录</span></span><br><span class="line"><span class="keyword">const</span> memoryRouter = createMemoryHistory();</span><br><span class="line"></span><br><span class="line"><span class="comment">// at https://example.com/folder</span></span><br><span class="line">createWebHashHistory() <span class="comment">// 给出的网址为 `https://example.com/folder#`</span></span><br><span class="line">createWebHashHistory(<span class="string">&#x27;/folder/&#x27;</span>) <span class="comment">// 给出的网址为 `https://example.com/folder/#`</span></span><br><span class="line"><span class="comment">// 如果在 base 中提供了 `#`，则它不会被 `createWebHashHistory` 添加</span></span><br><span class="line">createWebHashHistory(<span class="string">&#x27;/folder/#/app/&#x27;</span>) <span class="comment">// 给出的网址为 `https://example.com/folder/#/app/`</span></span><br><span class="line"><span class="comment">// 你应该避免这样做，因为它会更改原始 url 并打断正在复制的 url</span></span><br><span class="line">createWebHashHistory(<span class="string">&#x27;/other-folder/&#x27;</span>) <span class="comment">// 给出的网址为 `https://example.com/other-folder/#`</span></span><br><span class="line"><span class="comment">// at file:///usr/etc/folder/index.html</span></span><br><span class="line"><span class="comment">// 对于没有 `host` 的位置，base被忽略</span></span><br><span class="line">createWebHashHistory(<span class="string">&#x27;/iAmIgnored&#x27;</span>) <span class="comment">// 给出的网址为 `file:///usr/etc/folder/index.html#`</span></span><br></pre></td></tr></table></figure>

<h4 id="createRouter-源码"><a href="#createRouter-源码" class="headerlink" title="createRouter 源码"></a>createRouter 源码</h4><p><code>src/router.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Router </span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> Router &#123;</span><br><span class="line">  <span class="comment">// 当前 route</span></span><br><span class="line">  <span class="keyword">readonly</span> currentRoute: Ref&lt;RouteLocationNormalizedLoaded&gt;</span><br><span class="line">  <span class="comment">// createRouter 传入的那个options</span></span><br><span class="line">  <span class="keyword">readonly</span> options: RouterOptions</span><br><span class="line">  <span class="comment">// 添加一个子路由 </span></span><br><span class="line">  addRoute(parentName: RouteRecordName, <span class="attr">route</span>: RouteRecordRaw): <span class="function">() =&gt;</span> <span class="built_in">void</span></span><br><span class="line">  <span class="comment">// 添加路由</span></span><br><span class="line">  addRoute(route: RouteRecordRaw): <span class="function">() =&gt;</span> <span class="built_in">void</span></span><br><span class="line">  <span class="comment">// 通过路由名称删除路由</span></span><br><span class="line">  removeRoute(name: RouteRecordName): <span class="built_in">void</span></span><br><span class="line">  <span class="comment">// 根据name 判断是否存在</span></span><br><span class="line">  hasRoute(name: RouteRecordName): <span class="built_in">boolean</span></span><br><span class="line">  <span class="comment">// 获取路由表</span></span><br><span class="line">  getRoutes(): RouteRecord[]</span><br><span class="line">	<span class="comment">// 就是将 &quot;/home&quot; &#123; path: &quot;/home&quot; &#125; 这样的跳转 转换成 RouteLocation &amp; &#123; href: string &#125; 的一个对象</span></span><br><span class="line">  resolve(</span><br><span class="line">    to: RouteLocationRaw,</span><br><span class="line">    currentLocation?: RouteLocationNormalizedLoaded</span><br><span class="line">  ): RouteLocation &amp; &#123; <span class="attr">href</span>: <span class="built_in">string</span> &#125;</span><br><span class="line">	<span class="comment">// 跳转的新的导航 push 进 历史堆</span></span><br><span class="line">  push(to: RouteLocationRaw): <span class="built_in">Promise</span>&lt;NavigationFailure | <span class="built_in">void</span> | <span class="literal">undefined</span>&gt;</span><br><span class="line">	<span class="comment">// 跳转的新的导航 替换 之前的导航 </span></span><br><span class="line">  replace(to: RouteLocationRaw): <span class="built_in">Promise</span>&lt;NavigationFailure | <span class="built_in">void</span> | <span class="literal">undefined</span>&gt;</span><br><span class="line">	<span class="comment">// 历史回退 router.go(-1)</span></span><br><span class="line">  back(): ReturnType&lt;Router[<span class="string">&#x27;go&#x27;</span>]&gt;</span><br><span class="line">	<span class="comment">// 历史前进 router.go(1)</span></span><br><span class="line">  forward(): ReturnType&lt;Router[<span class="string">&#x27;go&#x27;</span>]&gt;</span><br><span class="line">	<span class="comment">// 跳转</span></span><br><span class="line">  go(delta: <span class="built_in">number</span>): <span class="built_in">void</span></span><br><span class="line">	<span class="comment">// 进入路由之前的导航钩子 返回值是 删除这个导航钩子的</span></span><br><span class="line">  beforeEach(guard: NavigationGuardWithThis&lt;<span class="literal">undefined</span>&gt;): <span class="function">() =&gt;</span> <span class="built_in">void</span></span><br><span class="line">	<span class="comment">// resolve 之前 返回值是 删除这个钩子的方法</span></span><br><span class="line">  beforeResolve(guard: NavigationGuardWithThis&lt;<span class="literal">undefined</span>&gt;): <span class="function">() =&gt;</span> <span class="built_in">void</span></span><br><span class="line">	<span class="comment">// 进入导航后 执行的钩子 返回值 是删除这个钩子的方法</span></span><br><span class="line">  afterEach(guard: NavigationHookAfter): <span class="function">() =&gt;</span> <span class="built_in">void</span></span><br><span class="line">  <span class="comment">// 导航中 发生错误时 触发的钩子	</span></span><br><span class="line">  onError(handler: _ErrorHandler): <span class="function">() =&gt;</span> <span class="built_in">void</span></span><br><span class="line">  <span class="comment">// 路由的相关配置都已经完成了</span></span><br><span class="line">  isReady(): <span class="built_in">Promise</span>&lt;<span class="built_in">void</span>&gt;</span><br><span class="line">  <span class="comment">// 注册 router 的方法</span></span><br><span class="line">  install(app: App): <span class="built_in">void</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建 router</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createRouter</span>(<span class="params">options: RouterOptions</span>): <span class="title">Router</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> matcher = createRouterMatcher(options.routes, options) <span class="comment">// 创建一个匹配器</span></span><br><span class="line">  <span class="keyword">let</span> parseQuery = options.parseQuery || originalParseQuery <span class="comment">// 如果用户定义了 parseQuery 用 用户的 否则用自带的</span></span><br><span class="line">  <span class="keyword">let</span> stringifyQuery = options.stringifyQuery || originalStringifyQuery <span class="comment">// 如果用户定义了 stringifyQuery 用 用户的 否则用自带的</span></span><br><span class="line">  <span class="keyword">let</span> routerHistory = options.history <span class="comment">// 取出history</span></span><br><span class="line">  <span class="keyword">if</span> (__DEV__ &amp;&amp; !routerHistory) <span class="comment">// 开发环境下且 用户没有定义 history</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">      <span class="string">&#x27;Provide the &quot;history&quot; option when calling &quot;createRouter()&quot;:&#x27;</span> +</span><br><span class="line">        <span class="string">&#x27; https://next.router.vuejs.org/api/#history.&#x27;</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">  <span class="comment">// useCallbacks =&gt; 返回的一个对象&#123;add, list, reset&#125;  add 方法 添加handler进handlers 数组, list 返回handlers, reset将handles 重置为空</span></span><br><span class="line">  <span class="keyword">const</span> beforeGuards = useCallbacks&lt;NavigationGuardWithThis&lt;<span class="literal">undefined</span>&gt;&gt;() <span class="comment">// 创建 beforeEach callbacks</span></span><br><span class="line">  <span class="keyword">const</span> beforeResolveGuards = useCallbacks&lt;NavigationGuardWithThis&lt;<span class="literal">undefined</span>&gt;&gt;() <span class="comment">// 创建 beforeResolveEach callbacks</span></span><br><span class="line">  <span class="keyword">const</span> afterGuards = useCallbacks&lt;NavigationHookAfter&gt;() <span class="comment">// 创建 afterEach callbacks</span></span><br><span class="line">  <span class="keyword">const</span> currentRoute = shallowRef&lt;RouteLocationNormalizedLoaded&gt;(</span><br><span class="line">    START_LOCATION_NORMALIZED</span><br><span class="line">  ) <span class="comment">// 初始化 currentRoute</span></span><br><span class="line">  <span class="keyword">let</span> pendingLocation: RouteLocation = START_LOCATION_NORMALIZED <span class="comment">// 初始化 待办的 location</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 浏览器环境,  options 里提供了 scrollBehavior , &#x27;scrollRestoration&#x27; 在history 中</span></span><br><span class="line">  <span class="keyword">if</span> (isBrowser &amp;&amp; options.scrollBehavior &amp;&amp; <span class="string">&#x27;scrollRestoration&#x27;</span> <span class="keyword">in</span> history) &#123;</span><br><span class="line">    history.scrollRestoration = <span class="string">&#x27;manual&#x27;</span> <span class="comment">// 防止自动恢复页面 &#x27;auto&#x27; 表示 恢复到用户已滚动到的位置</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// applyToParams =&gt; 传入一个方法 然后 params的每个键值作为参数调用这个方法</span></span><br><span class="line">  <span class="keyword">const</span> normalizeParams = applyToParams.bind(</span><br><span class="line">    <span class="literal">null</span>,</span><br><span class="line">    <span class="function"><span class="params">paramValue</span> =&gt;</span> <span class="string">&#x27;&#x27;</span> + paramValue</span><br><span class="line">  ) <span class="comment">// params 的每个键值 都会调用 paramValue =&gt; &#x27;&#x27; + paramValue 方法</span></span><br><span class="line">  <span class="keyword">const</span> encodeParams = applyToParams.bind(<span class="literal">null</span>, encodeParam) <span class="comment">// params 的每个键值 都会调用 encodeParam 方法</span></span><br><span class="line">  <span class="keyword">const</span> decodeParams = applyToParams.bind(<span class="literal">null</span>, decode)  <span class="comment">// params 的每个键值 都会调用 decode 方法</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 下面的方法 具体实现我后面 再去研究 </span></span><br><span class="line">  <span class="comment">// router 的 addRoute 方法</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">addRoute</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    parentOrRoute: RouteRecordName | RouteRecordRaw,</span></span></span><br><span class="line"><span class="params"><span class="function">    route?: RouteRecordRaw</span></span></span><br><span class="line"><span class="params"><span class="function">  </span>) </span>&#123;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// router 的 removeRoute 方法</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">removeRoute</span>(<span class="params">name: RouteRecordName</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// router 的 getRoutes 方法</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getRoutes</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// router 的 hasRoute 方法</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">hasRoute</span>(<span class="params">name: RouteRecordName</span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">     <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// router 的resolve 方法</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">resolve</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    rawLocation: Readonly&lt;RouteLocationRaw&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">    currentLocation?: RouteLocationNormalizedLoaded</span></span></span><br><span class="line"><span class="params"><span class="function">  </span>): <span class="title">RouteLocation</span> &amp; </span>&#123; href: <span class="built_in">string</span> &#125; &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 辅助方法 将 路由地址 转换成对象</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">locationAsObject</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    to: RouteLocationRaw | RouteLocationNormalized</span></span></span><br><span class="line"><span class="params"><span class="function">  </span>): <span class="title">Exclude</span>&lt;<span class="title">RouteLocationRaw</span>, <span class="title">string</span>&gt; | <span class="title">RouteLocationNormalized</span> </span>&#123;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 验证已经取消的 导航</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">checkCanceledNavigation</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    to: RouteLocationNormalized,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">from</span>: RouteLocationNormalized</span></span></span><br><span class="line"><span class="params"><span class="function">  </span>): <span class="title">NavigationFailure</span> | <span class="title">void</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">	</span><br><span class="line">  <span class="comment">// router 的 push 方法</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">push</span>(<span class="params">to: RouteLocationRaw | RouteLocation</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// router 的 replace 方法</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">replace</span>(<span class="params">to: RouteLocationRaw | RouteLocationNormalized</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// 处理重定向记录的方法</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">handleRedirectRecord</span>(<span class="params">to: RouteLocation</span>): <span class="title">RouteLocationRaw</span> | <span class="title">void</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 重定向的添加进 记录</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">pushWithRedirect</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    to: RouteLocationRaw | RouteLocation,</span></span></span><br><span class="line"><span class="params"><span class="function">    redirectedFrom?: RouteLocation</span></span></span><br><span class="line"><span class="params"><span class="function">  </span>): <span class="title">Promise</span>&lt;<span class="title">NavigationFailure</span> | <span class="title">void</span> | <span class="title">undefined</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 验证 取消的导航 和 拒绝的导航</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">checkCanceledNavigationAndReject</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    to: RouteLocationNormalized,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">from</span>: RouteLocationNormalized</span></span></span><br><span class="line"><span class="params"><span class="function">  </span>): <span class="title">Promise</span>&lt;<span class="title">void</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// router 的 navigate 方法</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">navigate</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    to: RouteLocationNormalized,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">from</span>: RouteLocationNormalizedLoaded</span></span></span><br><span class="line"><span class="params"><span class="function">  </span>): <span class="title">Promise</span>&lt;<span class="title">any</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 触发 afterEach 这个钩子的方法</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">triggerAfterEach</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    to: RouteLocationNormalizedLoaded,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">from</span>: RouteLocationNormalizedLoaded,</span></span></span><br><span class="line"><span class="params"><span class="function">    failure?: NavigationFailure | <span class="built_in">void</span></span></span></span><br><span class="line"><span class="params"><span class="function">  </span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 导航完成之后 调用的方法</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">finalizeNavigation</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    toLocation: RouteLocationNormalizedLoaded,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">from</span>: RouteLocationNormalizedLoaded,</span></span></span><br><span class="line"><span class="params"><span class="function">    isPush: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    replace?: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    data?: HistoryState</span></span></span><br><span class="line"><span class="params"><span class="function">  </span>): <span class="title">NavigationFailure</span> | <span class="title">void</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 移出 历史记录 侦听的方法</span></span><br><span class="line">  <span class="keyword">let</span> removeHistoryListener: <span class="function">() =&gt;</span> <span class="built_in">void</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 侦听 历史记录 方法</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">setupListeners</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 初始化 ready 和 error 的handlers</span></span><br><span class="line">  <span class="keyword">let</span> readyHandlers = useCallbacks&lt;OnReadyCallback&gt;()</span><br><span class="line">  <span class="keyword">let</span> errorHandlers = useCallbacks&lt;_ErrorHandler&gt;()</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// router 初始化是否完成的 标志</span></span><br><span class="line">  <span class="keyword">let</span> ready: <span class="built_in">boolean</span> </span><br><span class="line"></span><br><span class="line">	<span class="comment">// 触发 errorHandler 的方法</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">triggerError</span>(<span class="params">error: <span class="built_in">any</span></span>) </span>&#123;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// router 的isReady 方法</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">isReady</span>(<span class="params"></span>): <span class="title">Promise</span>&lt;<span class="title">void</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 将 router 的标记为 ready  这个方法 只会被调用一次</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">markAsReady</span>(<span class="params">err?: <span class="built_in">any</span></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Scroll behavior</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">handleScroll</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    to: RouteLocationNormalizedLoaded,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">from</span>: RouteLocationNormalizedLoaded,</span></span></span><br><span class="line"><span class="params"><span class="function">    isPush: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    isFirstNavigation: <span class="built_in">boolean</span></span></span></span><br><span class="line"><span class="params"><span class="function">  </span>): <span class="title">Promise</span>&lt;<span class="title">any</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// router 的 go 方法</span></span><br><span class="line">  <span class="keyword">const</span> go = <span class="function">(<span class="params">delta: <span class="built_in">number</span></span>) =&gt;</span> routerHistory.go(delta)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 开始标记</span></span><br><span class="line">  <span class="keyword">let</span> started: <span class="built_in">boolean</span> | <span class="literal">undefined</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 当前 router 注册的 app 的 Set 集合</span></span><br><span class="line">  <span class="keyword">const</span> installedApps = <span class="keyword">new</span> <span class="built_in">Set</span>&lt;App&gt;()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化 router</span></span><br><span class="line">  <span class="keyword">const</span> router: Router = &#123;</span><br><span class="line">    currentRoute,</span><br><span class="line"></span><br><span class="line">    addRoute,</span><br><span class="line">    removeRoute,</span><br><span class="line">    hasRoute,</span><br><span class="line">    getRoutes,</span><br><span class="line">    resolve,</span><br><span class="line">    options,</span><br><span class="line"></span><br><span class="line">    push,</span><br><span class="line">    replace,</span><br><span class="line">    go,</span><br><span class="line">    <span class="attr">back</span>: <span class="function">() =&gt;</span> go(-<span class="number">1</span>),</span><br><span class="line">    <span class="attr">forward</span>: <span class="function">() =&gt;</span> go(<span class="number">1</span>),</span><br><span class="line"></span><br><span class="line">    <span class="attr">beforeEach</span>: beforeGuards.add,</span><br><span class="line">    <span class="attr">beforeResolve</span>: beforeResolveGuards.add,</span><br><span class="line">    <span class="attr">afterEach</span>: afterGuards.add,</span><br><span class="line"></span><br><span class="line">    <span class="attr">onError</span>: errorHandlers.add,</span><br><span class="line">    isReady,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 暴露的注册方法 </span></span><br><span class="line">    <span class="function"><span class="title">install</span>(<span class="params">app: App</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> router = <span class="built_in">this</span></span><br><span class="line">      app.component(<span class="string">&#x27;RouterLink&#x27;</span>, RouterLink) <span class="comment">// 注册 RouterLink 组件</span></span><br><span class="line">      app.component(<span class="string">&#x27;RouterView&#x27;</span>, RouterView) <span class="comment">// 注册 RouterView 组件</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 在 app 的全局属性上 挂载 $router</span></span><br><span class="line">      app.config.globalProperties.$router = router</span><br><span class="line">      <span class="comment">// 通过 defineProperty 设置 访问 ctx.config.globalProperties.$route 返回当前的 路由</span></span><br><span class="line">      <span class="built_in">Object</span>.defineProperty(app.config.globalProperties, <span class="string">&#x27;$route&#x27;</span>, &#123;</span><br><span class="line">        <span class="attr">get</span>: <span class="function">() =&gt;</span> unref(currentRoute),</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 初始化 导航</span></span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        isBrowser &amp;&amp; <span class="comment">// 是浏览器</span></span><br><span class="line">        !started &amp;&amp; <span class="comment">// started 的值是 Falsy</span></span><br><span class="line">        currentRoute.value === START_LOCATION_NORMALIZED <span class="comment">// 且 currentRoute.value 为 那个初始化的</span></span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="comment">// 修改 started 为 true</span></span><br><span class="line">        started = <span class="literal">true</span></span><br><span class="line">        <span class="comment">// routerHistory 就是 用户使用 createWebHistory 返回的值 </span></span><br><span class="line">        <span class="comment">// 然后跳转到 location 并这个 时候会catch error </span></span><br><span class="line">        push(routerHistory.location).catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (__DEV__) warn(<span class="string">&#x27;Unexpected error when starting the router:&#x27;</span>, err)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 定义一个 响应式 route</span></span><br><span class="line">      <span class="keyword">const</span> reactiveRoute = &#123;&#125; <span class="keyword">as</span> &#123;</span><br><span class="line">        [k <span class="keyword">in</span> keyof RouteLocationNormalizedLoaded]: ComputedRef&lt;</span><br><span class="line">          RouteLocationNormalizedLoaded[k]</span><br><span class="line">        &gt;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 初始化 reactiveRoute</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> START_LOCATION_NORMALIZED) &#123;</span><br><span class="line">        <span class="comment">// @ts-ignore: the key matches</span></span><br><span class="line">        reactiveRoute[key] = computed(<span class="function">() =&gt;</span> currentRoute.value[key])</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      app.provide(routerKey, router) <span class="comment">// 提供一个 router 所以 useRouter 其实就是返回的 inject(routerKey)</span></span><br><span class="line">      app.provide(routeLocationKey, reactive(reactiveRoute)) <span class="comment">// 提供一个 reactiveRoute</span></span><br><span class="line">      app.provide(routerViewLocationKey, currentRoute) <span class="comment">// 提供一个currentRoute 所以 useRoute 就是 返回的 inject(routeLocationKey)</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 取出 app.unmount 卸载方法</span></span><br><span class="line">      <span class="keyword">let</span> unmountApp = app.unmount</span><br><span class="line">      installedApps.add(app) <span class="comment">// 将当前的 app 添加进 app Set集合</span></span><br><span class="line">      <span class="comment">// 重写 app的 卸载方法</span></span><br><span class="line">      app.unmount = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        installedApps.delete(app) <span class="comment">// 在Set 集合中删除当前的 app</span></span><br><span class="line">        <span class="keyword">if</span> (installedApps.size &lt; <span class="number">1</span>) &#123; <span class="comment">// 判断 当前的 Set 集合 已经没有 别的app</span></span><br><span class="line">          removeHistoryListener() <span class="comment">// 调用 删除 历史 的侦听</span></span><br><span class="line">          currentRoute.value = START_LOCATION_NORMALIZED <span class="comment">// 当前路由的 值 重置为 START_LOCATION_NORMALIZED</span></span><br><span class="line">          started = <span class="literal">false</span> <span class="comment">// 重置 started</span></span><br><span class="line">          ready = <span class="literal">false</span> <span class="comment">// 重置 ready 状态</span></span><br><span class="line">        &#125;</span><br><span class="line">        unmountApp() <span class="comment">// 调用原本的卸载方法</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 支持 这个feature 就将router 添加进 devtool</span></span><br><span class="line">      <span class="keyword">if</span> ((__DEV__ || __FEATURE_PROD_DEVTOOLS__) &amp;&amp; __BROWSER__) &#123;</span><br><span class="line">        addDevtools(app, router, matcher)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> router</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="useCallbacks"><a href="#useCallbacks" class="headerlink" title="useCallbacks"></a>useCallbacks</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">useCallbacks</span>&lt;<span class="title">T</span>&gt;(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> handlers: T[] = []</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">handler: T</span>): (<span class="params"></span>) =&gt; <span class="title">void</span> </span>&#123;</span><br><span class="line">    handlers.push(handler)</span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> i = handlers.indexOf(handler)</span><br><span class="line">      <span class="keyword">if</span> (i &gt; -<span class="number">1</span>) handlers.splice(i, <span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">reset</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    handlers = []</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    add,</span><br><span class="line">    <span class="attr">list</span>: <span class="function">() =&gt;</span> handlers,</span><br><span class="line">    reset,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="applyToParams"><a href="#applyToParams" class="headerlink" title="applyToParams"></a>applyToParams</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">applyToParams</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  fn: (v: <span class="built_in">string</span> | <span class="built_in">number</span>) =&gt; <span class="built_in">string</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  params: RouteParamsRaw | <span class="literal">undefined</span></span></span></span><br><span class="line"><span class="params"><span class="function"></span>): <span class="title">RouteParams</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> newParams: RouteParams = &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> params) &#123;</span><br><span class="line">    <span class="keyword">const</span> value = params[key]</span><br><span class="line">    newParams[key] = <span class="built_in">Array</span>.isArray(value) ? value.map(fn) : fn(value)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> newParams</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="NavigationFailureType"><a href="#NavigationFailureType" class="headerlink" title="NavigationFailureType"></a>NavigationFailureType</h3><p>包含所有可能导航失败类型的枚举, 可以传递给 <code>isNavigationFailure</code> 来检查某些特定类型的失败, <strong>不要使用任何数值</strong>, 总是使用诸如<code>NavigationFailureType.aborted</code> 这样的变量</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="built_in">enum</span> NavigationFailureType &#123;</span><br><span class="line">  aborted = ErrorTypes.NAVIGATION_ABORTED, <span class="comment">// 4 终止导航是指由于导航守卫返回 false 或调用 next(false) 而失败的导航</span></span><br><span class="line">  cancelled = ErrorTypes.NAVIGATION_CANCELLED, <span class="comment">// 8 取消导航是指由于最近的导航完成启动（不一定是完成）而失败的导航</span></span><br><span class="line">  duplicated = ErrorTypes.NAVIGATION_DUPLICATED, <span class="comment">// 16 重复导航是指在启动时已经在同一位置失败的导航</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="built_in">enum</span> ErrorTypes &#123;</span><br><span class="line">  MATCHER_NOT_FOUND = <span class="number">1</span>, <span class="comment">// 没有找到</span></span><br><span class="line">  NAVIGATION_GUARD_REDIRECT = <span class="number">2</span>, <span class="comment">// 重定向</span></span><br><span class="line">  NAVIGATION_ABORTED = <span class="number">4</span>, <span class="comment">// 已中止</span></span><br><span class="line">  NAVIGATION_CANCELLED = <span class="number">8</span>, <span class="comment">// 已取消</span></span><br><span class="line">  NAVIGATION_DUPLICATED = <span class="number">16</span>, <span class="comment">// 重复</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 看看 isNavigationFailure 的实现</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">isNavigationFailure</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  error: <span class="built_in">any</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">type</span>?: ErrorTypes.NAVIGATION_GUARD_REDIRECT <span class="comment">// 值是2  导航守卫 重定向 error</span></span></span></span><br><span class="line"><span class="params"><span class="function"></span>): <span class="title">error</span> <span class="title">is</span> <span class="title">NavigationRedirectError</span></span></span><br><span class="line"><span class="function"><span class="title">export</span> <span class="function"><span class="keyword">function</span> <span class="title">isNavigationFailure</span>(<span class="params"></span></span></span></span><br><span class="line"><span class="params"><span class="function"><span class="function">  error: <span class="built_in">any</span>,</span></span></span></span><br><span class="line"><span class="params"><span class="function"><span class="function">  <span class="keyword">type</span>?: ErrorTypes | NavigationFailureType</span></span></span></span><br><span class="line"><span class="params"><span class="function"><span class="function"></span>): <span class="title">error</span> <span class="title">is</span> <span class="title">NavigationFailure</span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="title">export</span> <span class="function"><span class="keyword">function</span> <span class="title">isNavigationFailure</span>(<span class="params"></span></span></span></span></span><br><span class="line"><span class="params"><span class="function"><span class="function"><span class="function">  error: <span class="built_in">any</span>,</span></span></span></span></span><br><span class="line"><span class="params"><span class="function"><span class="function"><span class="function">  <span class="keyword">type</span>?: <span class="built_in">number</span></span></span></span></span></span><br><span class="line"><span class="params"><span class="function"><span class="function"><span class="function"></span>): <span class="title">error</span> <span class="title">is</span> <span class="title">NavigationFailure</span> </span>&#123;</span></span></span><br><span class="line"><span class="function"><span class="function">  <span class="title">return</span> (<span class="params"></span></span></span></span><br><span class="line"><span class="params"><span class="function"><span class="function">    error <span class="keyword">instanceof</span> <span class="built_in">Error</span> &amp;&amp;</span></span></span></span><br><span class="line"><span class="params"><span class="function"><span class="function">    NavigationFailureSymbol <span class="keyword">in</span> error &amp;&amp;</span></span></span></span><br><span class="line"><span class="params"><span class="function"><span class="function">    (<span class="keyword">type</span> == <span class="literal">null</span> || !!((error <span class="keyword">as</span> NavigationFailure).<span class="keyword">type</span> &amp; <span class="keyword">type</span>))</span></span></span></span><br><span class="line"><span class="params"><span class="function"><span class="function">  </span>)</span></span></span><br><span class="line"><span class="function"><span class="function">&#125;</span></span></span><br><span class="line"><span class="function"><span class="function"></span></span></span><br><span class="line"><span class="function"><span class="function">// 例子 在 <span class="title">router</span> 的添加导航钩子中使用 </span></span></span><br><span class="line"><span class="function"><span class="function"><span class="title">import</span> </span>&#123;</span></span><br><span class="line"><span class="function">  <span class="title">isNavigationFailure</span>,</span></span><br><span class="line"><span class="function">  <span class="title">NavigationFailureType</span>,</span></span><br><span class="line"><span class="function">&#125; <span class="title">from</span> &#x27;<span class="title">vue</span>-<span class="title">router</span>&#x27;</span>;</span><br><span class="line">router.afterEach(<span class="function">(<span class="params">to, <span class="keyword">from</span>, failure</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (isNavigationFailure(failure)) &#123;</span><br><span class="line">    <span class="comment">// 是 ErrorTypes | NavigationFailureType 中的</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isNavigationFailure(failure, NavigationFailureType.duplicated)) &#123;</span><br><span class="line">    <span class="comment">// 是 重复导航 这个错误</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    isNavigationFailure(</span><br><span class="line">      failure,</span><br><span class="line">      NavigationFailureType.aborted | NavigationFailureType.cancelled,</span><br><span class="line">    )</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">// 是 已中止 或者 已取消 这样的错误</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="START-LOCATION"><a href="#START-LOCATION" class="headerlink" title="START_LOCATION"></a>START_LOCATION</h4><p>路由所在的初始路由地址, 可用于导航守卫中, 以区分初始导航</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> START_LOCATION_NORMALIZED: RouteLocationNormalizedLoaded = &#123;</span><br><span class="line">  <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">  <span class="attr">name</span>: <span class="literal">undefined</span>,</span><br><span class="line">  <span class="attr">params</span>: &#123;&#125;,</span><br><span class="line">  <span class="attr">query</span>: &#123;&#125;,</span><br><span class="line">  <span class="attr">hash</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  <span class="attr">fullPath</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">  <span class="attr">matched</span>: [],</span><br><span class="line">  <span class="attr">meta</span>: &#123;&#125;,</span><br><span class="line">  <span class="attr">redirectedFrom</span>: <span class="literal">undefined</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 例子 </span></span><br><span class="line"><span class="keyword">import</span> &#123; START_LOCATION &#125; <span class="keyword">from</span> <span class="string">&#x27;vue-router&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(router.currentRoute.value === START_LOCATION); <span class="comment">// true  </span></span><br><span class="line"></span><br><span class="line">router.beforeEach(<span class="function">(<span class="params">to, <span class="keyword">from</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">from</span> === START_LOCATION) &#123;</span><br><span class="line">    <span class="comment">// 初始导航</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="CompositionApi"><a href="#CompositionApi" class="headerlink" title="CompositionApi"></a>CompositionApi</h3><h4 id="onBeforeRouteLeave"><a href="#onBeforeRouteLeave" class="headerlink" title="onBeforeRouteLeave"></a>onBeforeRouteLeave</h4><p>添加一个导航守卫, 在当前位置的组件将要离开时触发, 类似于 <code>beforeRouteLeave</code>, 但它可以在任何组件中使用, 当组件被卸载时, 导航守卫将被移除</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">onBeforeRouteLeave</span>(<span class="params">leaveGuard: NavigationGuard</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (__DEV__ &amp;&amp; !getCurrentInstance()) &#123;</span><br><span class="line">    warn(</span><br><span class="line">      <span class="string">&#x27;getCurrentInstance() returned null. onBeforeRouteLeave() must be called at the top of a setup function&#x27;</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 当前点击的 记录</span></span><br><span class="line">  <span class="keyword">const</span> activeRecord: RouteRecordNormalized | <span class="literal">undefined</span> = inject(</span><br><span class="line">    matchedRouteKey,</span><br><span class="line">    &#123;&#125; <span class="keyword">as</span> <span class="built_in">any</span></span><br><span class="line">  ).value</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 不存在 警告一下</span></span><br><span class="line">  <span class="keyword">if</span> (!activeRecord) &#123;</span><br><span class="line">    __DEV__ &amp;&amp;</span><br><span class="line">      warn(</span><br><span class="line">        <span class="string">&#x27;No active route record was found. Are you missing a &lt;router-view&gt; component?&#x27;</span></span><br><span class="line">      )</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 调用这个 注册守卫的方法</span></span><br><span class="line">  registerGuard(activeRecord, <span class="string">&#x27;leaveGuards&#x27;</span>, leaveGuard)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="onBeforeRouteUpdate"><a href="#onBeforeRouteUpdate" class="headerlink" title="onBeforeRouteUpdate"></a>onBeforeRouteUpdate</h4><p>添加一个导航守卫, 在当前位置即将更新时触发, 类似于 <code>beforeRouteUpdate</code>, 但它可以在任何组件中使用, 当组件被卸载时, 导航守卫将被移除</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">onBeforeRouteUpdate</span>(<span class="params">updateGuard: NavigationGuard</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (__DEV__ &amp;&amp; !getCurrentInstance()) &#123;</span><br><span class="line">    warn(</span><br><span class="line">      <span class="string">&#x27;getCurrentInstance() returned null. onBeforeRouteUpdate() must be called at the top of a setup function&#x27;</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">	<span class="comment">// 当前点击的 记录</span></span><br><span class="line">  <span class="keyword">const</span> activeRecord: RouteRecordNormalized | <span class="literal">undefined</span> = inject(</span><br><span class="line">    matchedRouteKey,</span><br><span class="line">    &#123;&#125; <span class="keyword">as</span> <span class="built_in">any</span></span><br><span class="line">  ).value</span><br><span class="line">	</span><br><span class="line">  <span class="comment">// 不存在 警告一下</span></span><br><span class="line">  <span class="keyword">if</span> (!activeRecord) &#123;</span><br><span class="line">    __DEV__ &amp;&amp;</span><br><span class="line">      warn(</span><br><span class="line">        <span class="string">&#x27;No active route record was found. Are you missing a &lt;router-view&gt; component?&#x27;</span></span><br><span class="line">      )</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">	<span class="comment">// 调用这个 注册守卫的方法</span></span><br><span class="line">  registerGuard(activeRecord, <span class="string">&#x27;updateGuards&#x27;</span>, updateGuard)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>registerGuard 方法</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">registerGuard</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  record: RouteRecordNormalized,</span></span></span><br><span class="line"><span class="params"><span class="function">  name: <span class="string">&#x27;leaveGuards&#x27;</span> | <span class="string">&#x27;updateGuards&#x27;</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  guard: NavigationGuard</span></span></span><br><span class="line"><span class="params"><span class="function"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 会把 记录中的 相应的钩子 Set集合 删除 当前执行的这个 guard钩子</span></span><br><span class="line">  <span class="keyword">const</span> removeFromList = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    record[name].delete(guard)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 在 卸载组件时  调用 removeFromList</span></span><br><span class="line">  onUnmounted(removeFromList)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 在 keepalive 组件没有激活的 时候 调用 removeFromList</span></span><br><span class="line">  onDeactivated(removeFromList)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 在 keepalive 组件 激活时 添加进 集合</span></span><br><span class="line">  onActivated(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    record[name].add(guard)</span><br><span class="line">  &#125;)</span><br><span class="line">	</span><br><span class="line">  <span class="comment">// 注册时 就直接添加进 Set 集合</span></span><br><span class="line">  record[name].add(guard)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="useLink"><a href="#useLink" class="headerlink" title="useLink"></a>useLink</h4><p>返回 <code>v-slot</code> API暴露的所有内容, 代码在 <code>router-link</code> 里面</p>
<p>这个可以自己实现一个<strong>跳转</strong></p>
<h4 id="useRoute"><a href="#useRoute" class="headerlink" title="useRoute"></a>useRoute</h4><p>返回当前路由地址, 相当于在模板中使用 <code>$route</code>, 必须在 <code>setup()</code> 中调用</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">useRoute</span>(<span class="params"></span>): <span class="title">RouteLocationNormalizedLoaded</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> inject(routeLocationKey)!</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="userRouter"><a href="#userRouter" class="headerlink" title="userRouter"></a>userRouter</h4><p>返回 <code>router</code> 实例, 相当于在模板中使用 <code>$router</code>, 必须在 <code>setup()</code> 中调用</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">useRouter</span>(<span class="params"></span>): <span class="title">Router</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> inject(routerKey)!</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Router-方法"><a href="#Router-方法" class="headerlink" title="Router 方法"></a>Router 方法</h3><p>在介绍 <code>Router</code> 方法之前 我先介绍一下 <code>VueRouter</code> 的 核心 <code>Matcher</code></p>
<h4 id="createRouterMatcher"><a href="#createRouterMatcher" class="headerlink" title="createRouterMatcher"></a>createRouterMatcher</h4><p><code>src/matcher/index.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createRouterMatcher</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  routes: RouteRecordRaw[],</span></span></span><br><span class="line"><span class="params"><span class="function">  globalOptions: PathParserOptions</span></span></span><br><span class="line"><span class="params"><span class="function"></span>): <span class="title">RouterMatcher</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 最主要的三个东西</span></span><br><span class="line">  <span class="keyword">const</span> matchers: RouteRecordMatcher[] = [] <span class="comment">// 存放的 routes 的数组</span></span><br><span class="line">  <span class="keyword">const</span> matcherMap = <span class="keyword">new</span> <span class="built_in">Map</span>&lt;RouteRecordName, RouteRecordMatcher&gt;() <span class="comment">//  routeMap 路由的name 为键值 value 是 匹配的routes</span></span><br><span class="line">  globalOptions = mergeOptions(</span><br><span class="line">    &#123; <span class="attr">strict</span>: <span class="literal">false</span>, <span class="attr">end</span>: <span class="literal">true</span>, <span class="attr">sensitive</span>: <span class="literal">false</span> &#125; <span class="keyword">as</span> PathParserOptions,</span><br><span class="line">    globalOptions</span><br><span class="line">  ) <span class="comment">// 如果 用户传的配置中 包含了上面三个 就是用 用户的 没有就用默认的</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ... 省略</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 初始化 添加进来的 路由记录</span></span><br><span class="line">  routes.forEach(<span class="function"><span class="params">route</span> =&gt;</span> addRoute(route))</span><br><span class="line">  <span class="keyword">return</span> &#123; addRoute, resolve, removeRoute, getRoutes, getRecordMatcher &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="addRoute"><a href="#addRoute" class="headerlink" title="addRoute"></a>addRoute</h4><p>添加一条新的<code>路由记录</code>作为现有路由的子路由, 如果存在名称相同的 删除后再添加</p>
<p>添加一条新的<code>路由记录</code>到路由 , 如果存在名称相同的 删除后再添加</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * parentOrRoute 父级路由的名字 或者是路由记录 </span></span><br><span class="line"><span class="comment"> * route 路由记录</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addRoute</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  parentOrRoute: RouteRecordName | RouteRecordRaw,</span></span></span><br><span class="line"><span class="params"><span class="function">  route?: RouteRecordRaw</span></span></span><br><span class="line"><span class="params"><span class="function"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> parent: Parameters&lt;<span class="keyword">typeof</span> matcher[<span class="string">&#x27;addRoute&#x27;</span>]&gt;[<span class="number">1</span>] | <span class="literal">undefined</span> <span class="comment">// 定义一个变量存放 获取到的 父级的 路由记录</span></span><br><span class="line">  <span class="keyword">let</span> record: RouteRecordRaw <span class="comment">// 定义一个路由记录</span></span><br><span class="line">  <span class="keyword">if</span> (isRouteName(parentOrRoute)) &#123; <span class="comment">// 判断 传入的第一个参数 是否是 路由名字</span></span><br><span class="line">    parent = matcher.getRecordMatcher(parentOrRoute) <span class="comment">// 根据 名字 获取 到相应 的 路由记录</span></span><br><span class="line">    record = route! <span class="comment">// 第二个参数 赋值给 route</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    record = parentOrRoute <span class="comment">// 不是 routeName 说明是 路由记录</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> matcher.addRoute(record, parent) <span class="comment">// 调用 matcher的 addRoute 方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里是 <code>matcher</code>的 <code>addRoute</code> 实现</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * record 路由记录</span></span><br><span class="line"><span class="comment"> * parent 父记录</span></span><br><span class="line"><span class="comment"> * originalRecord 原始记录</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addRoute</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  record: RouteRecordRaw, </span></span></span><br><span class="line"><span class="params"><span class="function">  parent?: RouteRecordMatcher,</span></span></span><br><span class="line"><span class="params"><span class="function">  originalRecord?: RouteRecordMatcher</span></span></span><br><span class="line"><span class="params"><span class="function"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> isRootAdd = !originalRecord <span class="comment">// 是否是从 root 添加的</span></span><br><span class="line">  <span class="keyword">let</span> mainNormalizedRecord = normalizeRouteRecord(record) <span class="comment">// 正常化 路由记录</span></span><br><span class="line">  mainNormalizedRecord.aliasOf = originalRecord &amp;&amp; originalRecord.record <span class="comment">// 初始化 别名</span></span><br><span class="line">  <span class="keyword">const</span> options: PathParserOptions = mergeOptions(globalOptions, record) <span class="comment">// 整合 options</span></span><br><span class="line">  <span class="comment">// 存放 normalizeRouteRecord 处理过的路由记录</span></span><br><span class="line">  <span class="keyword">const</span> normalizedRecords: <span class="keyword">typeof</span> mainNormalizedRecord[] = [</span><br><span class="line">    mainNormalizedRecord,</span><br><span class="line">  ]</span><br><span class="line">  <span class="comment">// 如果 alias(别名) 存在于 记录中</span></span><br><span class="line">  <span class="comment">// 会通过别名叫 当前的记录 复制一份 不同的地方 是 path 不同</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="string">&#x27;alias&#x27;</span> <span class="keyword">in</span> record) &#123;</span><br><span class="line">    <span class="comment">// 取出别名 alias 对应的值类型 要么是 string 要么是 string[] 所以这里统一处理成 string[]</span></span><br><span class="line">    <span class="keyword">const</span> aliases =</span><br><span class="line">      <span class="keyword">typeof</span> record.alias === <span class="string">&#x27;string&#x27;</span> ? [record.alias] : record.alias!</span><br><span class="line">    <span class="comment">// 遍历每个别名数组</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> alias <span class="keyword">of</span> aliases) &#123;</span><br><span class="line">      <span class="comment">// 将这个 别名对应的 生成 的 路由记录 添加进 记录数组</span></span><br><span class="line">      normalizedRecords.push(</span><br><span class="line">        assign(&#123;&#125;, mainNormalizedRecord, &#123;</span><br><span class="line">          <span class="attr">components</span>: originalRecord <span class="comment">// 如果存在 源记录 用原纪录的 components</span></span><br><span class="line">            ? originalRecord.record.components</span><br><span class="line">            : mainNormalizedRecord.components,</span><br><span class="line">          <span class="attr">path</span>: alias, <span class="comment">// alias 作为path</span></span><br><span class="line">          <span class="attr">aliasOf</span>: originalRecord <span class="comment">// 赋值别名</span></span><br><span class="line">            ? originalRecord.record</span><br><span class="line">            : mainNormalizedRecord,</span><br><span class="line">        &#125;) <span class="keyword">as</span> <span class="keyword">typeof</span> mainNormalizedRecord</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; </span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> matcher: RouteRecordMatcher <span class="comment">// 根据当前路由记录 生成的 匹配器</span></span><br><span class="line">  <span class="keyword">let</span> originalMatcher: RouteRecordMatcher | <span class="literal">undefined</span> <span class="comment">// 根据当前路由记录 生成的源 匹配器</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 遍历 处理后的 记录数组</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> normalizedRecord <span class="keyword">of</span> normalizedRecords) &#123;</span><br><span class="line">    <span class="keyword">let</span> &#123; path &#125; = normalizedRecord <span class="comment">// 取出记录中的 path</span></span><br><span class="line">    <span class="keyword">if</span> (parent &amp;&amp; path[<span class="number">0</span>] !== <span class="string">&#x27;/&#x27;</span>) &#123; </span><br><span class="line">      <span class="comment">// parent 存在 且path 不是以 &quot;/&quot; 开始 如下例子</span></span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">      	&#123;</span></span><br><span class="line"><span class="comment">      		path: &quot;/decade&quot;,</span></span><br><span class="line"><span class="comment">      		name: &quot;decade&quot;,</span></span><br><span class="line"><span class="comment">      		components: () =&gt; imgport(&quot;xxxx&quot;),</span></span><br><span class="line"><span class="comment">      		children: [</span></span><br><span class="line"><span class="comment">      			&#123;</span></span><br><span class="line"><span class="comment">      				path: &quot;children&quot;,</span></span><br><span class="line"><span class="comment">      				name: &quot;children&quot;,</span></span><br><span class="line"><span class="comment">      				components: () =&gt; import(&quot;xxx&quot;)</span></span><br><span class="line"><span class="comment">      			&#125;</span></span><br><span class="line"><span class="comment">      		]</span></span><br><span class="line"><span class="comment">      	&#125;</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">      <span class="keyword">let</span> parentPath = parent.record.path <span class="comment">// 取出 父级的 path</span></span><br><span class="line">      <span class="comment">// 根据父级的path 最后一个字符是不是 &quot;/&quot; 来判断  是否需要添加 &quot;/&quot; </span></span><br><span class="line">      <span class="keyword">let</span> connectingSlash =</span><br><span class="line">        parentPath[parentPath.length - <span class="number">1</span>] === <span class="string">&#x27;/&#x27;</span> ? <span class="string">&#x27;&#x27;</span> : <span class="string">&#x27;/&#x27;</span></span><br><span class="line">      <span class="comment">// 修改当前 记录的path </span></span><br><span class="line">      <span class="comment">// 最开始是 &quot;children&quot; =&gt; 最后变成 &quot;/decade/children&quot;</span></span><br><span class="line">      normalizedRecord.path =</span><br><span class="line">        parent.record.path + (path &amp;&amp; connectingSlash + path)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 开发环境下 path === &quot;*&quot; 抛error</span></span><br><span class="line">    <span class="keyword">if</span> (__DEV__ &amp;&amp; normalizedRecord.path === <span class="string">&#x27;*&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">        <span class="string">&#x27;Catch all routes (&quot;*&quot;) must now be defined using a param with a custom regexp.\n&#x27;</span> +</span><br><span class="line">          <span class="string">&#x27;See more at https://next.router.vuejs.org/guide/migration/#removed-star-or-catch-all-routes.&#x27;</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用 createRouteRecordMatcher 生成 matcher</span></span><br><span class="line">    matcher = createRouteRecordMatcher(normalizedRecord, parent, options)</span><br><span class="line">		</span><br><span class="line">    <span class="comment">// 开发环境下 存在 父级 且 path 第一个字符为 &quot;/&quot; 说明子的 路由记录path 是绝对路径</span></span><br><span class="line">    <span class="keyword">if</span> (__DEV__ &amp;&amp; parent &amp;&amp; path[<span class="number">0</span>] === <span class="string">&#x27;/&#x27;</span>) </span><br><span class="line">      checkMissingParamsInAbsolutePath(matcher, parent) <span class="comment">// 这个方法 用于验证 子参数 应该与 父级的参数一样, 如下</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    	&#123;</span></span><br><span class="line"><span class="comment">        path: &#x27;/about:name&#x27;,</span></span><br><span class="line"><span class="comment">        name: &#x27;About&#x27;,</span></span><br><span class="line"><span class="comment">        alias: &#x27;/decade:name&#x27;,</span></span><br><span class="line"><span class="comment">        component: () =&gt; import(xxx),</span></span><br><span class="line"><span class="comment">        children: [</span></span><br><span class="line"><span class="comment">          &#123;</span></span><br><span class="line"><span class="comment">            path: &#x27;/example1:name&#x27;,</span></span><br><span class="line"><span class="comment">            component: () =&gt; import(&#x27;../views/test/index.vue&#x27;),</span></span><br><span class="line"><span class="comment">            name: &#x27;x1&#x27;,</span></span><br><span class="line"><span class="comment">          &#125;,</span></span><br><span class="line"><span class="comment">        ],</span></span><br><span class="line"><span class="comment">      &#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// 存在 传入第三个参数的情况下</span></span><br><span class="line">    <span class="keyword">if</span> (originalRecord) &#123;</span><br><span class="line">      <span class="comment">// 添加进 原始记录的 alias 里面</span></span><br><span class="line">      originalRecord.alias.push(matcher)</span><br><span class="line">      <span class="keyword">if</span> (__DEV__) &#123; <span class="comment">// 开发环境下 判断参数名称</span></span><br><span class="line">        checkSameParams(originalRecord, matcher)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 不存在 第三个参数的情况下 我们默认 把 normalizedRecords 的第一条 生成的 matcher 作为  originalMatcher</span></span><br><span class="line">      originalMatcher = originalMatcher || matcher</span><br><span class="line">      <span class="comment">// 避免重复添加</span></span><br><span class="line">      <span class="keyword">if</span> (originalMatcher !== matcher) originalMatcher.alias.push(matcher)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// isAliasRecord 方法 递归调用寻找record.aliasOf </span></span><br><span class="line">      <span class="keyword">if</span> (isRootAdd &amp;&amp; record.name &amp;&amp; !isAliasRecord(matcher))</span><br><span class="line">        removeRoute(record.name) <span class="comment">// 删除这个 路由记录</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 存在 children 添加进去</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&#x27;children&#x27;</span> <span class="keyword">in</span> mainNormalizedRecord) &#123;</span><br><span class="line">      <span class="keyword">let</span> children = mainNormalizedRecord.children</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; children.length; i++) &#123;</span><br><span class="line">        addRoute(</span><br><span class="line">          children[i],</span><br><span class="line">          matcher,</span><br><span class="line">          originalRecord &amp;&amp; originalRecord.children[i]</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 赋值给 originalRecord</span></span><br><span class="line">    originalRecord = originalRecord || matcher</span><br><span class="line">    </span><br><span class="line">		<span class="comment">// 添加进 matchers 还有 matcherMap</span></span><br><span class="line">    insertMatcher(matcher)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> originalMatcher</span><br><span class="line">    ? <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    		<span class="comment">// 由于其他匹配器是别名，因此应由原始匹配器将其删除</span></span><br><span class="line">        removeRoute(originalMatcher!)</span><br><span class="line">      &#125;</span><br><span class="line">    : noop</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 添加进matcher 的顺序都是 children =&gt; parent</span></span><br></pre></td></tr></table></figure>

<h5 id="normalizeRouteRecord"><a href="#normalizeRouteRecord" class="headerlink" title="normalizeRouteRecord"></a>normalizeRouteRecord</h5><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">normalizeRouteRecord</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  record: RouteRecordRaw</span></span></span><br><span class="line"><span class="params"><span class="function"></span>): <span class="title">RouteRecordNormalized</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">path</span>: record.path, <span class="comment">// path</span></span><br><span class="line">    <span class="attr">redirect</span>: record.redirect, <span class="comment">// 重定向的 路由地址</span></span><br><span class="line">    <span class="attr">name</span>: record.name, <span class="comment">// 记录名字</span></span><br><span class="line">    <span class="attr">meta</span>: record.meta || &#123;&#125;, <span class="comment">// meta</span></span><br><span class="line">    <span class="attr">aliasOf</span>: <span class="literal">undefined</span>,</span><br><span class="line">    <span class="attr">beforeEnter</span>: record.beforeEnter, <span class="comment">// 记录中 的 beforeEnter 进入前的钩子</span></span><br><span class="line">    <span class="attr">props</span>: normalizeRecordProps(record), <span class="comment">// 记录中的 props</span></span><br><span class="line">    <span class="attr">children</span>: record.children || [], <span class="comment">// 子记录</span></span><br><span class="line">    <span class="attr">instances</span>: &#123;&#125;, <span class="comment">// 实例</span></span><br><span class="line">    <span class="attr">leaveGuards</span>: <span class="keyword">new</span> <span class="built_in">Set</span>(), <span class="comment">// 离开当前记录地址 的守卫</span></span><br><span class="line">    <span class="attr">updateGuards</span>: <span class="keyword">new</span> <span class="built_in">Set</span>(), <span class="comment">// 更新 时的守卫</span></span><br><span class="line">    <span class="attr">enterCallbacks</span>: &#123;&#125;, <span class="comment">// 进入路由之前的 回调</span></span><br><span class="line">    <span class="attr">components</span>: <span class="comment">// 组件</span></span><br><span class="line">      <span class="string">&#x27;components&#x27;</span> <span class="keyword">in</span> record</span><br><span class="line">        ? record.components || &#123;&#125;</span><br><span class="line">        : &#123; <span class="attr">default</span>: record.component! &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="mergeOptions"><a href="#mergeOptions" class="headerlink" title="mergeOptions"></a>mergeOptions</h5><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mergeOptions</span>&lt;<span class="title">T</span>&gt;(<span class="params">defaults: T, partialOptions: Partial&lt;T&gt;</span>): <span class="title">T</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> options = &#123;&#125; <span class="keyword">as</span> T</span><br><span class="line">  <span class="comment">// 遍历 默认配置中的key</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> defaults) &#123;</span><br><span class="line">    options[key] =</span><br><span class="line">      <span class="comment">// key 存在于用户配置的 用用户配置的 否则默认的</span></span><br><span class="line">      key <span class="keyword">in</span> partialOptions ? partialOptions[key] : (defaults[key] <span class="keyword">as</span> <span class="built_in">any</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> options</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="createRouteRecordMatcher"><a href="#createRouteRecordMatcher" class="headerlink" title="createRouteRecordMatcher"></a>createRouteRecordMatcher</h5><p><code>src/matcher/pathMatcher.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	record 路由记录</span></span><br><span class="line"><span class="comment">	parent 父级的matcher(匹配器)</span></span><br><span class="line"><span class="comment">	options 解析的配置options</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createRouteRecordMatcher</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  record: Readonly&lt;RouteRecord&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">  parent: RouteRecordMatcher | <span class="literal">undefined</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  options?: PathParserOptions</span></span></span><br><span class="line"><span class="params"><span class="function"></span>): <span class="title">RouteRecordMatcher</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 生成解析器</span></span><br><span class="line">  <span class="keyword">const</span> parser = tokensToParser(tokenizePath(record.path), options)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 警告 相同的参数名 例子如下</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  	  &#123;</span></span><br><span class="line"><span class="comment">        path: &#x27;/about:id&#x27;,</span></span><br><span class="line"><span class="comment">        name: &#x27;About&#x27;,</span></span><br><span class="line"><span class="comment">        alias: &#x27;/decade:id&#x27;,</span></span><br><span class="line"><span class="comment">        component: () =&gt;</span></span><br><span class="line"><span class="comment">          import(&#x27;xxx&#x27;),</span></span><br><span class="line"><span class="comment">        children: [</span></span><br><span class="line"><span class="comment">          &#123;</span></span><br><span class="line"><span class="comment">            path: &#x27;example1:id&#x27;,</span></span><br><span class="line"><span class="comment">            component: () =&gt; import(&#x27;xxx&#x27;),</span></span><br><span class="line"><span class="comment">            name: &#x27;x1&#x27;,</span></span><br><span class="line"><span class="comment">          &#125;,</span></span><br><span class="line"><span class="comment">        ],</span></span><br><span class="line"><span class="comment">      &#125;,</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    <span class="keyword">const</span> existingKeys = <span class="keyword">new</span> <span class="built_in">Set</span>&lt;<span class="built_in">string</span>&gt;() <span class="comment">// key 的 Set集合</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">of</span> parser.keys) &#123;</span><br><span class="line">      <span class="keyword">if</span> (existingKeys.has(key.name)) <span class="comment">// 存在相同的 警告一下</span></span><br><span class="line">        warn(</span><br><span class="line">          <span class="string">`Found duplicated params with name &quot;<span class="subst">$&#123;key.name&#125;</span>&quot; for path &quot;<span class="subst">$&#123;record.path&#125;</span>&quot;. Only the last one will be available on &quot;$route.params&quot;.`</span></span><br><span class="line">        )</span><br><span class="line">      existingKeys.add(key.name) <span class="comment">// 添加进集合</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 定义 匹配器</span></span><br><span class="line">  <span class="keyword">const</span> matcher: RouteRecordMatcher = assign(parser, &#123;</span><br><span class="line">    record,</span><br><span class="line">    parent,</span><br><span class="line">    <span class="comment">// children 和 alias 是需要 parent 来定义的</span></span><br><span class="line">    <span class="attr">children</span>: [],</span><br><span class="line">    <span class="attr">alias</span>: [],</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 存在 父级的 matcher </span></span><br><span class="line">  <span class="keyword">if</span> (parent) &#123;</span><br><span class="line">    <span class="comment">// 不一样 aliasOf</span></span><br><span class="line">    <span class="keyword">if</span> (!matcher.record.aliasOf === !parent.record.aliasOf)</span><br><span class="line">      parent.children.push(matcher) <span class="comment">// 添加进 children</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> matcher</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="tokenizePath"><a href="#tokenizePath" class="headerlink" title="tokenizePath"></a>tokenizePath</h5><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="built_in">enum</span> TokenType &#123;</span><br><span class="line">  Static, <span class="comment">// 0 静态 比如 /decade </span></span><br><span class="line">  Param, <span class="comment">// 1 带有参数 比如 /decade:id </span></span><br><span class="line">  Group, <span class="comment">// 2 这个在后面的代码具体也没用到过 而且 文档中有这么一句英文  </span></span><br><span class="line">  <span class="comment">// not sure how useful this is and if it&#x27;s worth supporting because of the cost to support the ranking as well</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">enum</span> TokenizerState &#123;</span><br><span class="line">  Static, <span class="comment">// 0 静态 /decade</span></span><br><span class="line">  Param, <span class="comment">// 1 不带正则的参数形式 比如 /decade:id</span></span><br><span class="line">  ParamRegExp, <span class="comment">// 2 检测到 /decade:id(\\d+) 中 &quot;(&quot; 这个时 会把状态从 Param 变成 ParamRegExp</span></span><br><span class="line">  ParamRegExpEnd, <span class="comment">// 也就是一个分组() 检测完 就会 把状态 从 ParamRegExp 变成 ParamRegExpEnd</span></span><br><span class="line">  EscapeNext, <span class="comment">// 处理 一开始遇到 \\ 比如 /decade;id\\  就会把状态变成 EscapeNext</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// static token 形状</span></span><br><span class="line"><span class="keyword">interface</span> TokenStatic &#123;</span><br><span class="line">  <span class="attr">type</span>: TokenType.Static</span><br><span class="line">  <span class="attr">value</span>: <span class="built_in">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// param token 形状</span></span><br><span class="line"><span class="keyword">interface</span> TokenParam &#123;</span><br><span class="line">  <span class="attr">type</span>: TokenType.Param</span><br><span class="line">  regexp?: <span class="built_in">string</span></span><br><span class="line">  <span class="attr">value</span>: <span class="built_in">string</span></span><br><span class="line">  <span class="attr">optional</span>: <span class="built_in">boolean</span></span><br><span class="line">  <span class="attr">repeatable</span>: <span class="built_in">boolean</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// token 组</span></span><br><span class="line"><span class="keyword">interface</span> TokenGroup &#123;</span><br><span class="line">  <span class="attr">type</span>: TokenType.Group</span><br><span class="line">  <span class="attr">value</span>: Exclude&lt;Token, TokenGroup&gt;[]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> Token = TokenStatic | TokenParam | TokenGroup</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化一个 根 token 即 匹配到 &quot;/&quot;</span></span><br><span class="line"><span class="keyword">const</span> ROOT_TOKEN: Token = &#123;</span><br><span class="line">  <span class="attr">type</span>: TokenType.Static,</span><br><span class="line">  <span class="attr">value</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	path: 路径 比如&quot;/decade&quot; </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">tokenizePath</span>(<span class="params">path: <span class="built_in">string</span></span>): <span class="title">Array</span>&lt;<span class="title">Token</span>[]&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!path) <span class="keyword">return</span> [[]] <span class="comment">// 返回一个空数组</span></span><br><span class="line">  <span class="keyword">if</span> (path === <span class="string">&#x27;/&#x27;</span>) <span class="keyword">return</span> [[ROOT_TOKEN]] <span class="comment">// path 为 &quot;/&quot; 返回 [&#123;type: 0, value: &quot;&quot;&#125;]</span></span><br><span class="line">  <span class="keyword">if</span> (!path.startsWith(<span class="string">&#x27;/&#x27;</span>)) &#123; <span class="comment">// 警告必须是以 &quot;/&quot; 打头</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">      __DEV__</span><br><span class="line">        ? <span class="string">`Route paths should start with a &quot;/&quot;: &quot;<span class="subst">$&#123;path&#125;</span>&quot; should be &quot;/<span class="subst">$&#123;path&#125;</span>&quot;.`</span></span><br><span class="line">        : <span class="string">`Invalid path &quot;<span class="subst">$&#123;path&#125;</span>&quot;`</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 抛出 error 的方法</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">crash</span>(<span class="params">message: <span class="built_in">string</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`ERR (<span class="subst">$&#123;state&#125;</span>)/&quot;<span class="subst">$&#123;buffer&#125;</span>&quot;: <span class="subst">$&#123;message&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> state: TokenizerState = TokenizerState.Static <span class="comment">// 初始化 默认为 0 即 不包含参数</span></span><br><span class="line">  <span class="keyword">let</span> previousState: TokenizerState = state <span class="comment">// 记录之前的 状态 这样 有利于当处理到 /decade:id\\xx 这样的时候能恢复到之前 状态</span></span><br><span class="line">  <span class="keyword">const</span> tokens: <span class="built_in">Array</span>&lt;Token[]&gt; = [] <span class="comment">// 初始化一个数组 里面的每个元素又都是 Token[] 这样的数组</span></span><br><span class="line">  <span class="keyword">let</span> segment!: Token[] <span class="comment">// 声明一个变量 用于存放单独 token</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 这个方法用来将每次 分成段的 token 存入 tokens  另外将segment重置为空</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">finalizeSegment</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (segment) tokens.push(segment)</span><br><span class="line">    segment = []</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// path 的起始 index</span></span><br><span class="line">  <span class="keyword">let</span> i = <span class="number">0</span></span><br><span class="line">  <span class="comment">// 用于存放 path的 字符</span></span><br><span class="line">  <span class="keyword">let</span> char: <span class="built_in">string</span></span><br><span class="line">  <span class="comment">// 设置一个缓存 用于存放 分成段的 path 的chars</span></span><br><span class="line">  <span class="keyword">let</span> buffer: <span class="built_in">string</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">  <span class="comment">// 用于存储 path 中的正则</span></span><br><span class="line">  <span class="keyword">let</span> customRe: <span class="built_in">string</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 消费buffer 意味 根据状态  将当前buffer 赋值给 接口 TokenStatic, 接口TokenParam 中的 value字段</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">consumeBuffer</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 空值时 直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (!buffer) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 状态为 static 0 </span></span><br><span class="line">    <span class="keyword">if</span> (state === TokenizerState.Static) &#123;</span><br><span class="line">      <span class="comment">// 生成一个对象 将对象push进 segment 里面</span></span><br><span class="line">      segment.push(&#123;</span><br><span class="line">        <span class="attr">type</span>: TokenType.Static,</span><br><span class="line">        <span class="attr">value</span>: buffer,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">      <span class="comment">// 下面三种之一</span></span><br><span class="line">      state === TokenizerState.Param ||</span><br><span class="line">      state === TokenizerState.ParamRegExp ||</span><br><span class="line">      state === TokenizerState.ParamRegExpEnd</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">if</span> (segment.length &gt; <span class="number">1</span> &amp;&amp; (char === <span class="string">&#x27;*&#x27;</span> || char === <span class="string">&#x27;+&#x27;</span>))</span><br><span class="line">        crash(</span><br><span class="line">          <span class="string">`A repeatable param (<span class="subst">$&#123;buffer&#125;</span>) must be alone in its segment. eg: &#x27;/:ids+.`</span></span><br><span class="line">        )</span><br><span class="line">      <span class="comment">// 生成一个对象 将对象push进 segment 里面</span></span><br><span class="line">      segment.push(&#123;</span><br><span class="line">        <span class="attr">type</span>: TokenType.Param,</span><br><span class="line">        <span class="attr">value</span>: buffer,</span><br><span class="line">        <span class="attr">regexp</span>: customRe,</span><br><span class="line">        <span class="attr">repeatable</span>: char === <span class="string">&#x27;*&#x27;</span> || char === <span class="string">&#x27;+&#x27;</span>, <span class="comment">// char为* 或者+ repeatable 可重复</span></span><br><span class="line">        <span class="attr">optional</span>: char === <span class="string">&#x27;*&#x27;</span> || char === <span class="string">&#x27;?&#x27;</span>, <span class="comment">// char 为 * 或者 ? optional 可选</span></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 抛出异常</span></span><br><span class="line">      crash(<span class="string">&#x27;Invalid state to consume buffer&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 重置buffer</span></span><br><span class="line">    buffer = <span class="string">&#x27;&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将char 添加进buffer</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">addCharToBuffer</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    buffer += char</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 循环 path</span></span><br><span class="line">  <span class="keyword">while</span> (i &lt; path.length) &#123;</span><br><span class="line">    <span class="comment">// 赋值 char</span></span><br><span class="line">    char = path[i++]</span><br><span class="line"></span><br><span class="line">    <span class="comment">// char 为 \ 且 状态不是 ParamRegExp</span></span><br><span class="line">    <span class="keyword">if</span> (char === <span class="string">&#x27;\\&#x27;</span> &amp;&amp; state !== TokenizerState.ParamRegExp) &#123;</span><br><span class="line">      previousState = state <span class="comment">// 保留之前的状态</span></span><br><span class="line">      state = TokenizerState.EscapeNext <span class="comment">// 修改状态</span></span><br><span class="line">      <span class="keyword">continue</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (state) &#123;</span><br><span class="line">      <span class="keyword">case</span> TokenizerState.Static: <span class="comment">// 静态</span></span><br><span class="line">        <span class="keyword">if</span> (char === <span class="string">&#x27;/&#x27;</span>) &#123; <span class="comment">// char 为&quot;/&quot;</span></span><br><span class="line">          <span class="keyword">if</span> (buffer) &#123; <span class="comment">// buffer 有值了才调用 consumeBuffer</span></span><br><span class="line">            consumeBuffer()</span><br><span class="line">          &#125;</span><br><span class="line">          finalizeSegment() </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char === <span class="string">&#x27;:&#x27;</span>) &#123; <span class="comment">// 当char 为 &quot;:&quot;  比如 /decade:id</span></span><br><span class="line">          consumeBuffer() <span class="comment">// 执行 consumeBuffer 就会把 decade 作为value 执行 state 为0 那</span></span><br><span class="line">          state = TokenizerState.Param <span class="comment">// 修改 buffer </span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          addCharToBuffer() <span class="comment">// 添加进buffer</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> TokenizerState.EscapeNext: <span class="comment">// 4</span></span><br><span class="line">        addCharToBuffer() <span class="comment">// 添加进buffer </span></span><br><span class="line">        state = previousState <span class="comment">// 恢复之前的 状态</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> TokenizerState.Param: <span class="comment">// 由参数</span></span><br><span class="line">        <span class="keyword">if</span> (char === <span class="string">&#x27;(&#x27;</span>) &#123; <span class="comment">// char 为&quot;(&quot;</span></span><br><span class="line">          state = TokenizerState.ParamRegExp <span class="comment">// 修改状态</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (VALID_PARAM_RE.test(char)) &#123; <span class="comment">// VALID_PARAM_RE 匹配的 是 小写a-z大写A-Z0-9_中的字符 </span></span><br><span class="line">          addCharToBuffer() <span class="comment">// 成功就添加进buffer</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          consumeBuffer()</span><br><span class="line">          state = TokenizerState.Static <span class="comment">// 修改状态</span></span><br><span class="line">          <span class="comment">// go back one character if we were not modifying</span></span><br><span class="line">          <span class="keyword">if</span> (char !== <span class="string">&#x27;*&#x27;</span> &amp;&amp; char !== <span class="string">&#x27;?&#x27;</span> &amp;&amp; char !== <span class="string">&#x27;+&#x27;</span>) i--</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> TokenizerState.ParamRegExp:</span><br><span class="line">        <span class="keyword">if</span> (char === <span class="string">&#x27;)&#x27;</span>) &#123; </span><br><span class="line">          <span class="keyword">if</span> (customRe[customRe.length - <span class="number">1</span>] == <span class="string">&#x27;\\&#x27;</span>) <span class="comment">// 判断一下存好的 path中的 正则的 最后一个字符是不是 &quot;\&quot;</span></span><br><span class="line">            customRe = customRe.slice(<span class="number">0</span>, -<span class="number">1</span>) + char</span><br><span class="line">          <span class="keyword">else</span> state = TokenizerState.ParamRegExpEnd</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          customRe += char <span class="comment">// 添加进 customRe 比如 /decade:id(\\d+) \d+</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> TokenizerState.ParamRegExpEnd:</span><br><span class="line">        consumeBuffer() </span><br><span class="line">        state = TokenizerState.Static <span class="comment">// 修改状态</span></span><br><span class="line">        <span class="keyword">if</span> (char !== <span class="string">&#x27;*&#x27;</span> &amp;&amp; char !== <span class="string">&#x27;?&#x27;</span> &amp;&amp; char !== <span class="string">&#x27;+&#x27;</span>)  <span class="comment">// char 为 ? * + i-- 可能会包含多个分组</span></span><br><span class="line">          i--</span><br><span class="line">        customRe = <span class="string">&#x27;&#x27;</span> <span class="comment">// 重置customRe</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">default</span>:</span><br><span class="line">        crash(<span class="string">&#x27;Unknown state&#x27;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (state === TokenizerState.ParamRegExp) <span class="comment">// 如果最后状态 还是 ParamRegExp 报错</span></span><br><span class="line">    crash(<span class="string">`Unfinished custom RegExp for param &quot;<span class="subst">$&#123;buffer&#125;</span>&quot;`</span>)</span><br><span class="line"></span><br><span class="line">  consumeBuffer()</span><br><span class="line">  finalizeSegment()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> tokens</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="tokensToParser"><a href="#tokensToParser" class="headerlink" title="tokensToParser"></a>tokensToParser</h5><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	segments: 传入的tokens</span></span><br><span class="line"><span class="comment">	extraOptions: 用户自己的配置</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">// segments 里面有很多 segment 每个 segment 里面有很多 token 对应的很多 score 数组</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">tokensToParser</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  segments: <span class="built_in">Array</span>&lt;Token[]&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">  extraOptions?: _PathParserOptions</span></span></span><br><span class="line"><span class="params"><span class="function"></span>): <span class="title">PathParser</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> options = assign(&#123;&#125;, BASE_PATH_PARSER_OPTIONS, extraOptions) <span class="comment">// 整合配置</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 分数数组</span></span><br><span class="line">  <span class="keyword">let</span> score: <span class="built_in">Array</span>&lt;<span class="built_in">number</span>[]&gt; = []</span><br><span class="line">  <span class="comment">// new RegExp() 传入的那个字符串</span></span><br><span class="line">  <span class="keyword">let</span> pattern = options.start ? <span class="string">&#x27;^&#x27;</span> : <span class="string">&#x27;&#x27;</span> </span><br><span class="line">  <span class="comment">// 存放参数的key 的数组 比如 /decade:id 中的id </span></span><br><span class="line">  <span class="keyword">const</span> keys: PathParserParamKey[] = []</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 遍历 </span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> segment <span class="keyword">of</span> segments) &#123;</span><br><span class="line">    <span class="comment">// 初始化 片段的分组</span></span><br><span class="line">    <span class="keyword">const</span> segmentScores: <span class="built_in">number</span>[] = segment.length ? [] : [PathScore.Root]</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加 &quot;/&quot;</span></span><br><span class="line">    <span class="keyword">if</span> (options.strict &amp;&amp; !segment.length) pattern += <span class="string">&#x27;/&#x27;</span></span><br><span class="line">    <span class="comment">// 遍历 每个片段里面的token</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> tokenIndex = <span class="number">0</span>; tokenIndex &lt; segment.length; tokenIndex++) &#123;</span><br><span class="line">      <span class="keyword">const</span> token = segment[tokenIndex] <span class="comment">// 取出</span></span><br><span class="line">      <span class="keyword">let</span> subSegmentScore: <span class="built_in">number</span> =</span><br><span class="line">        PathScore.Segment + <span class="comment">// 是否配置了 sensitive (区分大小写)</span></span><br><span class="line">        (options.sensitive ? PathScore.BonusCaseSensitive : <span class="number">0</span>) <span class="comment">//  初始化 每个token 的分数</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 为 0 时</span></span><br><span class="line">      <span class="keyword">if</span> (token.type === TokenType.Static) &#123;</span><br><span class="line">        <span class="comment">// 如果 tokenIndex 为0 需要在 + &#x27;/&#x27;</span></span><br><span class="line">        <span class="keyword">if</span> (!tokenIndex) pattern += <span class="string">&#x27;/&#x27;</span></span><br><span class="line">        pattern += token.value.replace(REGEX_CHARS_RE, <span class="string">&#x27;\\$&amp;&#x27;</span>) <span class="comment">// 满足 /[.+*?^$&#123;&#125;()[\]/\\]/g 全局替换成 \$&amp;</span></span><br><span class="line">        subSegmentScore += PathScore.Static <span class="comment">// 加上 static 对应的分</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (token.type === TokenType.Param) &#123; <span class="comment">// 为 1 时 </span></span><br><span class="line">        <span class="keyword">const</span> &#123; value, repeatable, optional, regexp &#125; = token <span class="comment">// 取出</span></span><br><span class="line">        keys.push(&#123;</span><br><span class="line">          <span class="attr">name</span>: value,</span><br><span class="line">          repeatable,</span><br><span class="line">          optional,</span><br><span class="line">        &#125;) <span class="comment">// 添加进 keys</span></span><br><span class="line">        <span class="keyword">const</span> re = regexp ? regexp : BASE_PARAM_PATTERN <span class="comment">// regexp 不为空串 用 regexp 否则用 &#x27;[^/]+?&#x27;</span></span><br><span class="line">        <span class="comment">// 当 re 不为 &#x27;[^/]+?&#x27; 时</span></span><br><span class="line">        <span class="keyword">if</span> (re !== BASE_PARAM_PATTERN) &#123;</span><br><span class="line">          subSegmentScore += PathScore.BonusCustomRegExp <span class="comment">// 算出新的分数</span></span><br><span class="line">          <span class="comment">// 确保能够 作为一个正则</span></span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">`(<span class="subst">$&#123;re&#125;</span>)`</span>)</span><br><span class="line">          &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">              <span class="string">`Invalid custom RegExp for param &quot;<span class="subst">$&#123;value&#125;</span>&quot; (<span class="subst">$&#123;re&#125;</span>): `</span> +</span><br><span class="line">                err.message</span><br><span class="line">            )</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 可以重复时 生成对应的 </span></span><br><span class="line">        <span class="keyword">let</span> subPattern = repeatable ? <span class="string">`((?:<span class="subst">$&#123;re&#125;</span>)(?:/(?:<span class="subst">$&#123;re&#125;</span>))*)`</span> : <span class="string">`(<span class="subst">$&#123;re&#125;</span>)`</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// tokenIndex 为 0</span></span><br><span class="line">        <span class="keyword">if</span> (!tokenIndex)</span><br><span class="line">          subPattern =</span><br><span class="line">            optional &amp;&amp; segment.length &lt; <span class="number">2</span></span><br><span class="line">              ? <span class="string">`(?:/<span class="subst">$&#123;subPattern&#125;</span>)`</span></span><br><span class="line">              : <span class="string">&#x27;/&#x27;</span> + subPattern</span><br><span class="line">        <span class="comment">// 可选 </span></span><br><span class="line">        <span class="keyword">if</span> (optional) </span><br><span class="line">          subPattern += <span class="string">&#x27;?&#x27;</span></span><br><span class="line">				</span><br><span class="line">        <span class="comment">// 拼接</span></span><br><span class="line">        pattern += subPattern</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 重新计算分数</span></span><br><span class="line">        subSegmentScore += PathScore.Dynamic</span><br><span class="line">        <span class="comment">// 可选</span></span><br><span class="line">        <span class="keyword">if</span> (optional) subSegmentScore += PathScore.BonusOptional</span><br><span class="line">        <span class="comment">// 可重复</span></span><br><span class="line">        <span class="keyword">if</span> (repeatable) subSegmentScore += PathScore.BonusRepeatable</span><br><span class="line">        <span class="comment">// .* 匹配任意</span></span><br><span class="line">        <span class="keyword">if</span> (re === <span class="string">&#x27;.*&#x27;</span>) subSegmentScore += PathScore.BonusWildcard</span><br><span class="line">      &#125;</span><br><span class="line">			</span><br><span class="line">      <span class="comment">// 添加进 分段分数数组</span></span><br><span class="line">      segmentScores.push(subSegmentScore)</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">// 添加 score </span></span><br><span class="line">    score.push(segmentScores)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (options.strict &amp;&amp; options.end) &#123;</span><br><span class="line">    <span class="keyword">const</span> i = score.length - <span class="number">1</span></span><br><span class="line">    score[i][score[i].length - <span class="number">1</span>] += PathScore.BonusStrict</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!options.strict) pattern += <span class="string">&#x27;/?&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 添加结尾 $</span></span><br><span class="line">  <span class="keyword">if</span> (options.end) pattern += <span class="string">&#x27;$&#x27;</span></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (options.strict) pattern += <span class="string">&#x27;(?:/|$)&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 生成</span></span><br><span class="line">  <span class="keyword">const</span> re = <span class="keyword">new</span> <span class="built_in">RegExp</span>(pattern, options.sensitive ? <span class="string">&#x27;&#x27;</span> : <span class="string">&#x27;i&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">parse</span>(<span class="params">path: <span class="built_in">string</span></span>): <span class="title">PathParams</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> match = path.match(re)</span><br><span class="line">    <span class="keyword">const</span> params: PathParams = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!match) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>; i &lt; match.length; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> value: <span class="built_in">string</span> = match[i] || <span class="string">&#x27;&#x27;</span></span><br><span class="line">      <span class="keyword">const</span> key = keys[i - <span class="number">1</span>]</span><br><span class="line">      params[key.name] = value &amp;&amp; key.repeatable ? value.split(<span class="string">&#x27;/&#x27;</span>) : value</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> params</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">stringify</span>(<span class="params">params: PathParams</span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> path = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="comment">// for optional parameters to allow to be empty</span></span><br><span class="line">    <span class="keyword">let</span> avoidDuplicatedSlash: <span class="built_in">boolean</span> = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> segment <span class="keyword">of</span> segments) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!avoidDuplicatedSlash || !path.endsWith(<span class="string">&#x27;/&#x27;</span>)) path += <span class="string">&#x27;/&#x27;</span></span><br><span class="line">      avoidDuplicatedSlash = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> token <span class="keyword">of</span> segment) &#123;</span><br><span class="line">        <span class="keyword">if</span> (token.type === TokenType.Static) &#123;</span><br><span class="line">          path += token.value</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (token.type === TokenType.Param) &#123;</span><br><span class="line">          <span class="keyword">const</span> &#123; value, repeatable, optional &#125; = token</span><br><span class="line">          <span class="keyword">const</span> param: <span class="built_in">string</span> | <span class="built_in">string</span>[] = value <span class="keyword">in</span> params ? params[value] : <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(param) &amp;&amp; !repeatable)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">              <span class="string">`Provided param &quot;<span class="subst">$&#123;value&#125;</span>&quot; is an array but it is not repeatable (* or + modifiers)`</span></span><br><span class="line">            )</span><br><span class="line">          <span class="keyword">const</span> text: <span class="built_in">string</span> = <span class="built_in">Array</span>.isArray(param) ? param.join(<span class="string">&#x27;/&#x27;</span>) : param</span><br><span class="line">          <span class="keyword">if</span> (!text) &#123;</span><br><span class="line">            <span class="keyword">if</span> (optional) &#123;</span><br><span class="line">              <span class="comment">// if we have more than one optional param like /:a?-static we</span></span><br><span class="line">              <span class="comment">// don&#x27;t need to care about the optional param</span></span><br><span class="line">              <span class="keyword">if</span> (segment.length &lt; <span class="number">2</span>) &#123;</span><br><span class="line">                <span class="comment">// remove the last slash as we could be at the end</span></span><br><span class="line">                <span class="keyword">if</span> (path.endsWith(<span class="string">&#x27;/&#x27;</span>)) path = path.slice(<span class="number">0</span>, -<span class="number">1</span>)</span><br><span class="line">                <span class="comment">// do not append a slash on the next iteration</span></span><br><span class="line">                <span class="keyword">else</span> avoidDuplicatedSlash = <span class="literal">true</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`Missing required param &quot;<span class="subst">$&#123;value&#125;</span>&quot;`</span>)</span><br><span class="line">          &#125;</span><br><span class="line">          path += text</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> path</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    re,</span><br><span class="line">    score,</span><br><span class="line">    keys,</span><br><span class="line">    parse,</span><br><span class="line">    stringify,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="beforeEach-beforeResolve-afterEach"><a href="#beforeEach-beforeResolve-afterEach" class="headerlink" title="beforeEach,  beforeResolve, afterEach,"></a>beforeEach,  beforeResolve, afterEach,</h4><p><code>beforeEach</code> :  添加一个导航守卫, 在任何导航前执行, 返回一个删除已注册守卫的函数</p>
<p><code>beforeResolve</code> : 添加一个导航守卫, 在导航即将解析之前执行, 在这个状态下, 所有的组件都已经被获取, 并且其他导航守卫也已经成功, 返回一个删除已注册守卫的函数 </p>
<p><code>afterEach</code> :  添加一个导航钩子, 在每次导航后执行, 返回一个删除注册钩子的函数</p>
<p>相关的代码 <code>部分都在 createRouter</code> 这个方法里面</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> NavigationGuardWithThis&lt;T&gt; &#123;</span><br><span class="line">  (</span><br><span class="line">    <span class="built_in">this</span>: T,</span><br><span class="line">    <span class="attr">to</span>: RouteLocationNormalized, <span class="comment">// 去到那个路由</span></span><br><span class="line">    <span class="attr">from</span>: RouteLocationNormalized, <span class="comment">// 从那个路由来 </span></span><br><span class="line">    <span class="attr">next</span>: NavigationGuardNext <span class="comment">// 跳转的方法</span></span><br><span class="line">  ): NavigationGuardReturn | <span class="built_in">Promise</span>&lt;NavigationGuardReturn&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> NavigationHookAfter &#123;</span><br><span class="line">  (</span><br><span class="line">    to: RouteLocationNormalized, <span class="comment">// 去到那个路由</span></span><br><span class="line">    <span class="attr">from</span>: RouteLocationNormalized, <span class="comment">// 从那个路由来 </span></span><br><span class="line">    failure?: NavigationFailure | <span class="built_in">void</span> <span class="comment">// 捕捉失败的钩子</span></span><br><span class="line">  ): <span class="built_in">any</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">useCallbacks</span>&lt;<span class="title">T</span>&gt;(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> handlers: T[] = [] <span class="comment">// 定义一个 handles 的数组 用于存放回调钩子</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">handler: T</span>): (<span class="params"></span>) =&gt; <span class="title">void</span> </span>&#123; <span class="comment">// 定义添加回调函数的方法 返回值 是删除这个钩子的 函数</span></span><br><span class="line">    handlers.push(handler)</span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> i = handlers.indexOf(handler)</span><br><span class="line">      <span class="keyword">if</span> (i &gt; -<span class="number">1</span>) handlers.splice(i, <span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">reset</span>(<span class="params"></span>) </span>&#123; <span class="comment">// 重置 存放的 数组 清空钩子</span></span><br><span class="line">    handlers = []</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    add,</span><br><span class="line">    <span class="attr">list</span>: <span class="function">() =&gt;</span> handlers,</span><br><span class="line">    reset,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建进入导航钱 的钩子集合</span></span><br><span class="line"><span class="keyword">const</span> beforeGuards = useCallbacks&lt;NavigationGuardWithThis&lt;<span class="literal">undefined</span>&gt;&gt;()</span><br><span class="line"><span class="comment">// 创建导航解析之前 的钩子集合</span></span><br><span class="line"><span class="keyword">const</span> beforeResolveGuards = useCallbacks&lt;NavigationGuardWithThis&lt;<span class="literal">undefined</span>&gt;&gt;()</span><br><span class="line"><span class="comment">// 创建进入导航之后的钩子集合</span></span><br><span class="line"><span class="keyword">const</span> afterGuards = useCallbacks&lt;NavigationHookAfter&gt;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router: Router = &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="attr">beforeEach</span>: beforeGuards.add,</span><br><span class="line">  <span class="attr">beforeResolve</span>: beforeResolveGuards.add,</span><br><span class="line">  <span class="attr">afterEach</span>: afterGuards.add,</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// example</span></span><br><span class="line">router.beforeEach(<span class="function">(<span class="params">to, <span class="keyword">from</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line">  <span class="comment">// return false; // 返回false 就会不让你跳转</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当然你也可以</span></span><br><span class="line">router.beforeEach(<span class="keyword">async</span> (to, <span class="keyword">from</span>) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">4</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> func(); <span class="comment">// func() 结果 true / false</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.beforeResolve(<span class="function">(<span class="params">to, <span class="keyword">from</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// console.log(rest);</span></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">2</span>);</span><br><span class="line">  <span class="comment">// return false; // 返回false 就会不让你跳转</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 同理</span></span><br><span class="line">router.beforeResolve(<span class="keyword">async</span> (to, <span class="keyword">from</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="built_in">Promise</span>.resolve(<span class="literal">false</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> destroyHooks = router.afterEach(<span class="function">(<span class="params">to, <span class="keyword">from</span>, failure</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (isNavigationFailure(failure)) &#123;</span><br><span class="line">    <span class="comment">// todo</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isNavigationFailure(failure, NavigationFailureType.duplicated)) &#123;</span><br><span class="line">    <span class="comment">// todo</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    isNavigationFailure(</span><br><span class="line">      failure,</span><br><span class="line">      NavigationFailureType.aborted | NavigationFailureType.cancelled,</span><br><span class="line">    )</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">// todo</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">3</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">destroyHooks();</span><br></pre></td></tr></table></figure>

<h4 id="go-back-forward"><a href="#go-back-forward" class="headerlink" title="go,  back, forward"></a>go,  back, forward</h4><p><code>go</code> :  允许你在历史中前进或后退</p>
<p><code>back</code> :  如果可能的话, 通过调用 <code>history.back()</code> 回溯历史, 相当于 <code>router.go(-1)</code></p>
<p><code>forward</code> :  如果可能的话, 通过调用 <code>history.forward()</code> 在历史中前进, 相当于 <code>router.go(1)</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> routerHistory = options.history <span class="comment">// 这里就是我们 传入的 history </span></span><br><span class="line"><span class="keyword">const</span> go = <span class="function">(<span class="params">delta: <span class="built_in">number</span></span>) =&gt;</span> routerHistory.go(delta) </span><br><span class="line"><span class="keyword">const</span> router:Router = &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  go,</span><br><span class="line">  <span class="attr">back</span>: <span class="function">() =&gt;</span> go(-<span class="number">1</span>),</span><br><span class="line">  <span class="attr">forward</span>: <span class="function">() =&gt;</span> go(<span class="number">1</span>),</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="getRoutes"><a href="#getRoutes" class="headerlink" title="getRoutes"></a>getRoutes</h4><p>获取所有 <code>路由记录</code>的完整列表</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这个是 createRouter 里面的</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRoutes</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> matcher.getRoutes().map(<span class="function"><span class="params">routeMatcher</span> =&gt;</span> routeMatcher.record) <span class="comment">// 返回的是所有匹配器中的 record组成的数组</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这个是 createRouterMatcher 里面的</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRoutes</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> matchers <span class="comment">// 存放的所有的匹配器</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="hasRoute"><a href="#hasRoute" class="headerlink" title="hasRoute"></a>hasRoute</h4><p>确认是否存在指定名称的路由</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// !! 转成 布尔值</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hasRoute</span>(<span class="params">name: RouteRecordName</span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> !!matcher.getRecordMatcher(name) </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果 name 存在于 matchMap 里面 则返回拿到, 否则返回undefined </span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRecordMatcher</span>(<span class="params">name: RouteRecordName</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> matcherMap.get(name)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="isReady"><a href="#isReady" class="headerlink" title="isReady"></a>isReady</h4><p>当路由器完成初始化导航时, 返回一个 Promise, 这意味着它已经解析了所有与初始路由相关的异步输入钩子和异步组件, 如果初始导航已经发生了, 那么 promise 就会立即解析, 这在服务器端渲染中很有用, 可以确保服务器和客户端的输出一致, 需要注意的是, 在服务器端, 你需要手动推送初始位置, 而在客户端, 路由器会自动从 URL 中获取初始位置</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> readyHandlers = useCallbacks&lt;OnReadyCallback&gt;()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isReady</span>(<span class="params"></span>): <span class="title">Promise</span>&lt;<span class="title">void</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (ready &amp;&amp; currentRoute.value !== START_LOCATION_NORMALIZED)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve()</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    readyHandlers.add([resolve, reject])</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// example</span></span><br><span class="line"><span class="keyword">const</span> routerReadyToPush= <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> router.isReady();</span><br><span class="line">  router.push(<span class="string">&#x27;/about&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="onError"><a href="#onError" class="headerlink" title="onError"></a>onError</h4><p>添加一个错误处理程序, 在导航期间每次发生未捕获的错误时都会调用该处理程序, 这包括同步和异步抛出的错误, 在任何导航守卫中返回或传递给 <code>next</code> 的错误, 以及在试图解析渲染路由所需的异步组件时发生的错误</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> errorHandlers = useCallbacks&lt;_ErrorHandler&gt;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router: Router = &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="attr">onError</span>: errorHandlers.add,</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// example </span></span><br><span class="line">router.onError(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(e);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="removeRoute"><a href="#removeRoute" class="headerlink" title="removeRoute"></a>removeRoute</h4><p>通过名称删除现有路由</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">removeRoute</span>(<span class="params">name: RouteRecordName</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> recordMatcher = matcher.getRecordMatcher(name) <span class="comment">// 获取</span></span><br><span class="line">  <span class="keyword">if</span> (recordMatcher) &#123; <span class="comment">// 存在 就调用 matcher 的removeRoute方法 </span></span><br><span class="line">    matcher.removeRoute(recordMatcher)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__) &#123; <span class="comment">// 不存在 且开发环境下  报警告 不存在</span></span><br><span class="line">    warn(<span class="string">`Cannot remove non-existent route &quot;<span class="subst">$&#123;<span class="built_in">String</span>(name)&#125;</span>&quot;`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">removeRoute</span>(<span class="params">matcherRef: RouteRecordName | RouteRecordMatcher</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (isRouteName(matcherRef)) &#123; <span class="comment">// 先判断是否是 routeName</span></span><br><span class="line">    <span class="keyword">const</span> matcher = matcherMap.get(matcherRef) <span class="comment">// 取出</span></span><br><span class="line">    <span class="keyword">if</span> (matcher) &#123; <span class="comment">// 存在</span></span><br><span class="line">      matcherMap.delete(matcherRef) <span class="comment">// 从matchMap 中删除</span></span><br><span class="line">      matchers.splice(matchers.indexOf(matcher), <span class="number">1</span>) <span class="comment">// 删除匹配器</span></span><br><span class="line">      matcher.children.forEach(removeRoute) <span class="comment">// 匹配器中的children 也要删除</span></span><br><span class="line">      matcher.alias.forEach(removeRoute) <span class="comment">// 别名也删除</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> index = matchers.indexOf(matcherRef) <span class="comment">// 不是说明传入的是一个 匹配器</span></span><br><span class="line">    <span class="keyword">if</span> (index &gt; -<span class="number">1</span>) &#123; <span class="comment">// 匹配器存在于 matchers</span></span><br><span class="line">      matchers.splice(index, <span class="number">1</span>) <span class="comment">// 删除</span></span><br><span class="line">      <span class="keyword">if</span> (matcherRef.record.name) <span class="comment">// 取出 记录的name</span></span><br><span class="line">        matcherMap.delete(matcherRef.record.name) <span class="comment">// 删除 map对应的name的 </span></span><br><span class="line">      matcherRef.children.forEach(removeRoute) <span class="comment">// children 执行</span></span><br><span class="line">      matcherRef.alias.forEach(removeRoute) <span class="comment">// 别名执行</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="resolve"><a href="#resolve" class="headerlink" title="resolve"></a>resolve</h4><p>返回 <code>路由地址</code> 的<code>标准化版本</code> , 还包括一个包含任何现有 <code>base</code> 的 <code>href</code> 属性</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolve</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  rawLocation: Readonly&lt;RouteLocationRaw&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">  currentLocation?: RouteLocationNormalizedLoaded</span></span></span><br><span class="line"><span class="params"><span class="function"></span>): <span class="title">RouteLocation</span> &amp; </span>&#123; href: <span class="built_in">string</span> &#125; &#123;</span><br><span class="line">  <span class="comment">// const objectLocation = routerLocationAsObject(rawLocation)</span></span><br><span class="line">  <span class="comment">// we create a copy to modify it later</span></span><br><span class="line">  currentLocation = assign(&#123;&#125;, currentLocation || currentRoute.value)</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> rawLocation === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> locationNormalized = parseURL(</span><br><span class="line">      parseQuery,</span><br><span class="line">      rawLocation,</span><br><span class="line">      currentLocation.path</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">let</span> matchedRoute = matcher.resolve(</span><br><span class="line">      &#123; <span class="attr">path</span>: locationNormalized.path &#125;,</span><br><span class="line">      currentLocation</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> href = routerHistory.createHref(locationNormalized.fullPath)</span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      <span class="keyword">if</span> (href.startsWith(<span class="string">&#x27;//&#x27;</span>))</span><br><span class="line">        warn(</span><br><span class="line">          <span class="string">`Location &quot;<span class="subst">$&#123;rawLocation&#125;</span>&quot; resolved to &quot;<span class="subst">$&#123;href&#125;</span>&quot;. A resolved location cannot start with multiple slashes.`</span></span><br><span class="line">        )</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (!matchedRoute.matched.length) &#123;</span><br><span class="line">        warn(<span class="string">`No match found for location with path &quot;<span class="subst">$&#123;rawLocation&#125;</span>&quot;`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// locationNormalized is always a new object</span></span><br><span class="line">    <span class="keyword">return</span> assign(locationNormalized, matchedRoute, &#123;</span><br><span class="line">      <span class="attr">params</span>: decodeParams(matchedRoute.params),</span><br><span class="line">      <span class="attr">hash</span>: decode(locationNormalized.hash),</span><br><span class="line">      <span class="attr">redirectedFrom</span>: <span class="literal">undefined</span>,</span><br><span class="line">      href,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> matcherLocation: MatcherLocationRaw</span><br><span class="line"></span><br><span class="line">  <span class="comment">// path could be relative in object as well</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="string">&#x27;path&#x27;</span> <span class="keyword">in</span> rawLocation) &#123;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      __DEV__ &amp;&amp;</span><br><span class="line">      <span class="string">&#x27;params&#x27;</span> <span class="keyword">in</span> rawLocation &amp;&amp;</span><br><span class="line">      !(<span class="string">&#x27;name&#x27;</span> <span class="keyword">in</span> rawLocation) &amp;&amp;</span><br><span class="line">      <span class="built_in">Object</span>.keys((rawLocation <span class="keyword">as</span> <span class="built_in">any</span>).params).length</span><br><span class="line">    ) &#123;</span><br><span class="line">      warn(</span><br><span class="line">        <span class="string">`Path &quot;<span class="subst">$&#123;</span></span></span><br><span class="line"><span class="subst"><span class="string">          (rawLocation <span class="keyword">as</span> <span class="built_in">any</span>).path</span></span></span><br><span class="line"><span class="subst"><span class="string">        &#125;</span>&quot; was passed with params but they will be ignored. Use a named route alongside params instead.`</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    matcherLocation = assign(&#123;&#125;, rawLocation, &#123;</span><br><span class="line">      <span class="attr">path</span>: parseURL(parseQuery, rawLocation.path, currentLocation.path).path,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// pass encoded values to the matcher so it can produce encoded path and fullPath</span></span><br><span class="line">    matcherLocation = assign(&#123;&#125;, rawLocation, &#123;</span><br><span class="line">      <span class="attr">params</span>: encodeParams(rawLocation.params),</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// current location params are decoded, we need to encode them in case the</span></span><br><span class="line">    <span class="comment">// matcher merges the params</span></span><br><span class="line">    currentLocation.params = encodeParams(currentLocation.params)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> matchedRoute = matcher.resolve(matcherLocation, currentLocation)</span><br><span class="line">  <span class="keyword">const</span> hash = rawLocation.hash || <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__DEV__ &amp;&amp; hash &amp;&amp; !hash.startsWith(<span class="string">&#x27;#&#x27;</span>)) &#123;</span><br><span class="line">    warn(</span><br><span class="line">      <span class="string">`A \`hash\` should always start with the character &quot;#&quot;. Replace &quot;<span class="subst">$&#123;hash&#125;</span>&quot; with &quot;#<span class="subst">$&#123;hash&#125;</span>&quot;.`</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// decoding them) the matcher might have merged current location params so</span></span><br><span class="line">  <span class="comment">// we need to run the decoding again</span></span><br><span class="line">  matchedRoute.params = normalizeParams(decodeParams(matchedRoute.params))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> fullPath = stringifyURL(</span><br><span class="line">    stringifyQuery,</span><br><span class="line">    assign(&#123;&#125;, rawLocation, &#123;</span><br><span class="line">      <span class="attr">hash</span>: encodeHash(hash),</span><br><span class="line">      <span class="attr">path</span>: matchedRoute.path,</span><br><span class="line">    &#125;)</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> href = routerHistory.createHref(fullPath)</span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    <span class="keyword">if</span> (href.startsWith(<span class="string">&#x27;//&#x27;</span>)) &#123;</span><br><span class="line">      warn(</span><br><span class="line">        <span class="string">`Location &quot;<span class="subst">$&#123;rawLocation&#125;</span>&quot; resolved to &quot;<span class="subst">$&#123;href&#125;</span>&quot;. A resolved location cannot start with multiple slashes.`</span></span><br><span class="line">      )</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!matchedRoute.matched.length) &#123;</span><br><span class="line">      warn(</span><br><span class="line">        <span class="string">`No match found for location with path &quot;<span class="subst">$&#123;</span></span></span><br><span class="line"><span class="subst"><span class="string">          <span class="string">&#x27;path&#x27;</span> <span class="keyword">in</span> rawLocation ? rawLocation.path : rawLocation</span></span></span><br><span class="line"><span class="subst"><span class="string">        &#125;</span>&quot;`</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> assign(</span><br><span class="line">    &#123;</span><br><span class="line">      fullPath,</span><br><span class="line">      <span class="comment">// keep the hash encoded so fullPath is effectively path + encodedQuery +</span></span><br><span class="line">      <span class="comment">// hash</span></span><br><span class="line">      hash,</span><br><span class="line">      <span class="attr">query</span>:</span><br><span class="line">        <span class="comment">// if the user is using a custom query lib like qs, we might have</span></span><br><span class="line">        <span class="comment">// nested objects, so we keep the query as is, meaning it can contain</span></span><br><span class="line">        <span class="comment">// numbers at `$route.query`, but at the point, the user will have to</span></span><br><span class="line">        <span class="comment">// use their own type anyway.</span></span><br><span class="line">        <span class="comment">// https://github.com/vuejs/vue-router-next/issues/328#issuecomment-649481567</span></span><br><span class="line">        stringifyQuery === originalStringifyQuery</span><br><span class="line">          ? normalizeQuery(rawLocation.query)</span><br><span class="line">          : (rawLocation.query <span class="keyword">as</span> LocationQuery),</span><br><span class="line">    &#125;,</span><br><span class="line">    matchedRoute,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">redirectedFrom</span>: <span class="literal">undefined</span>,</span><br><span class="line">      href,</span><br><span class="line">    &#125;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="replace-1"><a href="#replace-1" class="headerlink" title="replace"></a>replace</h4><p>通过替换历史堆栈中的当前 entry, 以编程方式导航到一个新的 URL</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">replace</span>(<span class="params">to: RouteLocationRaw | RouteLocationNormalized</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> push(assign(locationAsObject(to), &#123; <span class="attr">replace</span>: <span class="literal">true</span> &#125;))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 放着 push 一起分析</span></span><br></pre></td></tr></table></figure>

<h4 id="push"><a href="#push" class="headerlink" title="push"></a>push</h4><p>通过在历史堆栈中推送一个 entry, 以编程方式导航到一个新的 URL</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">push</span>(<span class="params">to: RouteLocationRaw | RouteLocation</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> pushWithRedirect(to)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 核心方法 是 pushWithRedirect</span></span><br></pre></td></tr></table></figure>

<h5 id="pushWithRedirect"><a href="#pushWithRedirect" class="headerlink" title="pushWithRedirect"></a>pushWithRedirect</h5><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pushWithRedirect</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  to: RouteLocationRaw | RouteLocation,</span></span></span><br><span class="line"><span class="params"><span class="function">  redirectedFrom?: RouteLocation</span></span></span><br><span class="line"><span class="params"><span class="function"></span>): <span class="title">Promise</span>&lt;<span class="title">NavigationFailure</span> | <span class="title">void</span> | <span class="title">undefined</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> targetLocation: RouteLocation = (pendingLocation = resolve(to))</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">from</span> = currentRoute.value</span><br><span class="line">  <span class="keyword">const</span> data: HistoryState | <span class="literal">undefined</span> = (to <span class="keyword">as</span> RouteLocationOptions).state</span><br><span class="line">  <span class="keyword">const</span> force: <span class="built_in">boolean</span> | <span class="literal">undefined</span> = (to <span class="keyword">as</span> RouteLocationOptions).force</span><br><span class="line">  <span class="comment">// to could be a string where `replace` is a function</span></span><br><span class="line">  <span class="keyword">const</span> replace = (to <span class="keyword">as</span> RouteLocationOptions).replace === <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> shouldRedirect = handleRedirectRecord(targetLocation)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (shouldRedirect)</span><br><span class="line">    <span class="keyword">return</span> pushWithRedirect(</span><br><span class="line">      assign(locationAsObject(shouldRedirect), &#123;</span><br><span class="line">        <span class="attr">state</span>: data,</span><br><span class="line">        force,</span><br><span class="line">        replace,</span><br><span class="line">      &#125;),</span><br><span class="line">      <span class="comment">// keep original redirectedFrom if it exists</span></span><br><span class="line">      redirectedFrom || targetLocation</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">  <span class="comment">// if it was a redirect we already called `pushWithRedirect` above</span></span><br><span class="line">  <span class="keyword">const</span> toLocation = targetLocation <span class="keyword">as</span> RouteLocationNormalized</span><br><span class="line"></span><br><span class="line">  toLocation.redirectedFrom = redirectedFrom</span><br><span class="line">  <span class="keyword">let</span> failure: NavigationFailure | <span class="built_in">void</span> | <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!force &amp;&amp; isSameRouteLocation(stringifyQuery, <span class="keyword">from</span>, targetLocation)) &#123;</span><br><span class="line">    failure = createRouterError&lt;NavigationFailure&gt;(</span><br><span class="line">      ErrorTypes.NAVIGATION_DUPLICATED,</span><br><span class="line">      &#123; <span class="attr">to</span>: toLocation, <span class="keyword">from</span> &#125;</span><br><span class="line">    )</span><br><span class="line">    <span class="comment">// trigger scroll to allow scrolling to the same anchor</span></span><br><span class="line">    handleScroll(</span><br><span class="line">      <span class="keyword">from</span>,</span><br><span class="line">      <span class="keyword">from</span>,</span><br><span class="line">      <span class="comment">// this is a push, the only way for it to be triggered from a</span></span><br><span class="line">      <span class="comment">// history.listen is with a redirect, which makes it become a push</span></span><br><span class="line">      <span class="literal">true</span>,</span><br><span class="line">      <span class="comment">// This cannot be the first navigation because the initial location</span></span><br><span class="line">      <span class="comment">// cannot be manually navigated to</span></span><br><span class="line">      <span class="literal">false</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (failure ? <span class="built_in">Promise</span>.resolve(failure) : navigate(toLocation, <span class="keyword">from</span>))</span><br><span class="line">    .catch(<span class="function">(<span class="params">error: NavigationFailure | NavigationRedirectError</span>) =&gt;</span></span><br><span class="line">      isNavigationFailure(error)</span><br><span class="line">        ? error</span><br><span class="line">        : <span class="comment">// reject any unknown error</span></span><br><span class="line">          triggerError(error)</span><br><span class="line">    )</span><br><span class="line">    .then(<span class="function">(<span class="params">failure: NavigationFailure | NavigationRedirectError | <span class="built_in">void</span></span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (failure) &#123;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">          isNavigationFailure(failure, ErrorTypes.NAVIGATION_GUARD_REDIRECT)</span><br><span class="line">        ) &#123;</span><br><span class="line">          <span class="keyword">if</span> (</span><br><span class="line">            __DEV__ &amp;&amp;</span><br><span class="line">            <span class="comment">// we are redirecting to the same location we were already at</span></span><br><span class="line">            isSameRouteLocation(</span><br><span class="line">              stringifyQuery,</span><br><span class="line">              resolve(failure.to),</span><br><span class="line">              toLocation</span><br><span class="line">            ) &amp;&amp;</span><br><span class="line">            <span class="comment">// and we have done it a couple of times</span></span><br><span class="line">            redirectedFrom &amp;&amp;</span><br><span class="line">            <span class="comment">// @ts-ignore</span></span><br><span class="line">            (redirectedFrom._count = redirectedFrom._count</span><br><span class="line">              ? <span class="comment">// @ts-ignore</span></span><br><span class="line">                redirectedFrom._count + <span class="number">1</span></span><br><span class="line">              : <span class="number">1</span>) &gt; <span class="number">10</span></span><br><span class="line">          ) &#123;</span><br><span class="line">            warn(</span><br><span class="line">              <span class="string">`Detected an infinite redirection in a navigation guard when going from &quot;<span class="subst">$&#123;<span class="keyword">from</span>.fullPath&#125;</span>&quot; to &quot;<span class="subst">$&#123;toLocation.fullPath&#125;</span>&quot;. Aborting to avoid a Stack Overflow. This will break in production if not fixed.`</span></span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(</span><br><span class="line">              <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;Infinite redirect in navigation guard&#x27;</span>)</span><br><span class="line">            )</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">return</span> pushWithRedirect(</span><br><span class="line">            <span class="comment">// keep options</span></span><br><span class="line">            assign(locationAsObject(failure.to), &#123;</span><br><span class="line">              <span class="attr">state</span>: data,</span><br><span class="line">              force,</span><br><span class="line">              replace,</span><br><span class="line">            &#125;),</span><br><span class="line">            <span class="comment">// preserve the original redirectedFrom if any</span></span><br><span class="line">            redirectedFrom || toLocation</span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// if we fail we don&#x27;t finalize the navigation</span></span><br><span class="line">        failure = finalizeNavigation(</span><br><span class="line">          toLocation <span class="keyword">as</span> RouteLocationNormalizedLoaded,</span><br><span class="line">          <span class="keyword">from</span>,</span><br><span class="line">          <span class="literal">true</span>,</span><br><span class="line">          replace,</span><br><span class="line">          data</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">      triggerAfterEach(</span><br><span class="line">        toLocation <span class="keyword">as</span> RouteLocationNormalizedLoaded,</span><br><span class="line">        <span class="keyword">from</span>,</span><br><span class="line">        failure</span><br><span class="line">      )</span><br><span class="line">      <span class="keyword">return</span> failure</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Decade W</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://blog.decade.run/2021/05/09/Vue-Router-api/">http://blog.decade.run/2021/05/09/Vue-Router-api/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://blog.decade.run" target="_blank">王小明</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/learn/">learn</a><a class="post-meta__tags" href="/tags/vueRouter/">vueRouter</a></div><div class="post_share"><div class="social-share" data-image="/img/coverimg/vue.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/" target="_blank"><img class="post-qr-code-img" src="/"/></a><div class="post-qr-code-desc"></div></li><li class="reward-item"><a href="/" target="_blank"><img class="post-qr-code-img" src="/"/></a><div class="post-qr-code-desc"></div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/05/18/diff/"><img class="prev-cover" src="/img/post.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">diff</div></div></a></div><div class="next-post pull-right"><a href="/2021/04/28/vue3-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E4%B8%89/"><img class="next-cover" src="/img/coverimg/vue.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">vue3 源码阅读 watch</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2021/05/30/webpack搭建vue3/" title="webpack搭建vue3 chat"><img class="cover" src="/img/coverimg/webapck.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-05-30</div><div class="title">webpack搭建vue3 chat</div></div></a></div><div><a href="/2021/05/18/diff/" title="diff"><img class="cover" src="/img/post.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-05-18</div><div class="title">diff</div></div></a></div><div><a href="/2021/04/28/vue3-源码阅读-三/" title="vue3 源码阅读 watch"><img class="cover" src="/img/coverimg/vue.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-28</div><div class="title">vue3 源码阅读 watch</div></div></a></div><div><a href="/2021/04/17/vue3-源码阅读-二/" title="vue3-源码阅读 reactive模块"><img class="cover" src="/img/coverimg/vue.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-17</div><div class="title">vue3-源码阅读 reactive模块</div></div></a></div><div><a href="/2021/04/09/vite-文档学习/" title="vite 文档学习"><img class="cover" src="/img/coverimg/vue.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-09</div><div class="title">vite 文档学习</div></div></a></div><div><a href="/2021/04/06/vue3-源码阅读-一/" title="vue3 源码阅读 init to mount"><img class="cover" src="/img/coverimg/vue.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-06</div><div class="title">vue3 源码阅读 init to mount</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Decade W</div><div class="author-info__description">博客,记录,生活,学习,成长</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">57</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">20</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">17</div></a></div></div><a class="button--animated" id="card-info-btn" href="https://blog.decade.run/"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/WangMaoquan" target="_blank" title="Github"><i class="fa fa-github"></i></a><a class="social-icon" href="/shixindonga@gmail.com" target="_blank" title="Email"><i class="fa fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fa fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#API-%E5%8F%82%E8%80%83"><span class="toc-number">1.</span> <span class="toc-text">API 参考</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#router-link-Props"><span class="toc-number">1.1.</span> <span class="toc-text">router-link Props</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#to"><span class="toc-number">1.1.1.</span> <span class="toc-text">to</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#replace"><span class="toc-number">1.1.2.</span> <span class="toc-text">replace</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#active-class"><span class="toc-number">1.1.3.</span> <span class="toc-text">active-class</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#aria-current-value"><span class="toc-number">1.1.4.</span> <span class="toc-text">aria-current-value</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#costom"><span class="toc-number">1.1.5.</span> <span class="toc-text">costom</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#exact-active-class"><span class="toc-number">1.1.6.</span> <span class="toc-text">exact-active-class</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#router-link-%E7%9A%84-v-slot"><span class="toc-number">1.2.</span> <span class="toc-text">router-link   的   v-slot</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#router-link-%E6%BA%90%E7%A0%81"><span class="toc-number">1.3.</span> <span class="toc-text">router-link 源码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#router-view-Props"><span class="toc-number">1.4.</span> <span class="toc-text">router-view Props</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#name"><span class="toc-number">1.4.1.</span> <span class="toc-text">name</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#route"><span class="toc-number">1.4.2.</span> <span class="toc-text">route</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#router-view-%E7%9A%84-v-slot"><span class="toc-number">1.4.3.</span> <span class="toc-text">router-view 的 v-slot</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#router-view%E6%BA%90%E7%A0%81"><span class="toc-number">1.4.4.</span> <span class="toc-text">router-view源码</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#createRouter"><span class="toc-number">1.5.</span> <span class="toc-text">createRouter</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#createRouter-%E6%BA%90%E7%A0%81"><span class="toc-number">1.5.1.</span> <span class="toc-text">createRouter 源码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#useCallbacks"><span class="toc-number">1.5.2.</span> <span class="toc-text">useCallbacks</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#applyToParams"><span class="toc-number">1.5.3.</span> <span class="toc-text">applyToParams</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NavigationFailureType"><span class="toc-number">1.6.</span> <span class="toc-text">NavigationFailureType</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#START-LOCATION"><span class="toc-number">1.6.1.</span> <span class="toc-text">START_LOCATION</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CompositionApi"><span class="toc-number">1.7.</span> <span class="toc-text">CompositionApi</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#onBeforeRouteLeave"><span class="toc-number">1.7.1.</span> <span class="toc-text">onBeforeRouteLeave</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#onBeforeRouteUpdate"><span class="toc-number">1.7.2.</span> <span class="toc-text">onBeforeRouteUpdate</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#useLink"><span class="toc-number">1.7.3.</span> <span class="toc-text">useLink</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#useRoute"><span class="toc-number">1.7.4.</span> <span class="toc-text">useRoute</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#userRouter"><span class="toc-number">1.7.5.</span> <span class="toc-text">userRouter</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Router-%E6%96%B9%E6%B3%95"><span class="toc-number">1.8.</span> <span class="toc-text">Router 方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#createRouterMatcher"><span class="toc-number">1.8.1.</span> <span class="toc-text">createRouterMatcher</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#addRoute"><span class="toc-number">1.8.2.</span> <span class="toc-text">addRoute</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#normalizeRouteRecord"><span class="toc-number">1.8.2.1.</span> <span class="toc-text">normalizeRouteRecord</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#mergeOptions"><span class="toc-number">1.8.2.2.</span> <span class="toc-text">mergeOptions</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#createRouteRecordMatcher"><span class="toc-number">1.8.2.3.</span> <span class="toc-text">createRouteRecordMatcher</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#tokenizePath"><span class="toc-number">1.8.2.4.</span> <span class="toc-text">tokenizePath</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#tokensToParser"><span class="toc-number">1.8.2.5.</span> <span class="toc-text">tokensToParser</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#beforeEach-beforeResolve-afterEach"><span class="toc-number">1.8.3.</span> <span class="toc-text">beforeEach,  beforeResolve, afterEach,</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#go-back-forward"><span class="toc-number">1.8.4.</span> <span class="toc-text">go,  back, forward</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#getRoutes"><span class="toc-number">1.8.5.</span> <span class="toc-text">getRoutes</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#hasRoute"><span class="toc-number">1.8.6.</span> <span class="toc-text">hasRoute</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#isReady"><span class="toc-number">1.8.7.</span> <span class="toc-text">isReady</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#onError"><span class="toc-number">1.8.8.</span> <span class="toc-text">onError</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#removeRoute"><span class="toc-number">1.8.9.</span> <span class="toc-text">removeRoute</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#resolve"><span class="toc-number">1.8.10.</span> <span class="toc-text">resolve</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#replace-1"><span class="toc-number">1.8.11.</span> <span class="toc-text">replace</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#push"><span class="toc-number">1.8.12.</span> <span class="toc-text">push</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#pushWithRedirect"><span class="toc-number">1.8.12.1.</span> <span class="toc-text">pushWithRedirect</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2021/05/30/webpack%E6%90%AD%E5%BB%BAvue3/" title="webpack搭建vue3 chat"><img src="/img/coverimg/webapck.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="webpack搭建vue3 chat"/></a><div class="content"><a class="title" href="/2021/05/30/webpack%E6%90%AD%E5%BB%BAvue3/" title="webpack搭建vue3 chat">webpack搭建vue3 chat</a><time datetime="2021-05-29T18:34:56.000Z" title="发表于 2021-05-30 02:34:56">2021-05-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/05/18/diff/" title="diff"><img src="/img/post.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="diff"/></a><div class="content"><a class="title" href="/2021/05/18/diff/" title="diff">diff</a><time datetime="2021-05-17T17:29:19.000Z" title="发表于 2021-05-18 01:29:19">2021-05-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/05/09/Vue-Router-api/" title="Vue-Router api"><img src="/img/coverimg/vue.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Vue-Router api"/></a><div class="content"><a class="title" href="/2021/05/09/Vue-Router-api/" title="Vue-Router api">Vue-Router api</a><time datetime="2021-05-09T12:33:58.000Z" title="发表于 2021-05-09 20:33:58">2021-05-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/04/28/vue3-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E4%B8%89/" title="vue3 源码阅读 watch"><img src="/img/coverimg/vue.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="vue3 源码阅读 watch"/></a><div class="content"><a class="title" href="/2021/04/28/vue3-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E4%B8%89/" title="vue3 源码阅读 watch">vue3 源码阅读 watch</a><time datetime="2021-04-27T16:18:35.000Z" title="发表于 2021-04-28 00:18:35">2021-04-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/04/17/vue3-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E4%BA%8C/" title="vue3-源码阅读 reactive模块"><img src="/img/coverimg/vue.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="vue3-源码阅读 reactive模块"/></a><div class="content"><a class="title" href="/2021/04/17/vue3-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E4%BA%8C/" title="vue3-源码阅读 reactive模块">vue3-源码阅读 reactive模块</a><time datetime="2021-04-16T16:32:50.000Z" title="发表于 2021-04-17 00:32:50">2021-04-17</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By Decade W</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi,  welcome  to  my  <a  href="http://blog.decade.run/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><div class="js-pjax"></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/lib/autoload.js" async></script></body></html>