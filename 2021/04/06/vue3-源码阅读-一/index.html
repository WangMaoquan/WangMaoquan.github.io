<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>vue3 源码阅读 init to mount | 王小明</title><meta name="keywords" content="vue3"><meta name="author" content="Decade W"><meta name="copyright" content="Decade W"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="源码阅读">
<meta property="og:type" content="article">
<meta property="og:title" content="vue3 源码阅读 init to mount">
<meta property="og:url" content="http://blog.decade.run/2021/04/06/vue3-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E4%B8%80/index.html">
<meta property="og:site_name" content="王小明">
<meta property="og:description" content="源码阅读">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://blog.decade.run/img/coverimg/vue.jpg">
<meta property="article:published_time" content="2021-04-06T07:50:56.000Z">
<meta property="article:modified_time" content="2021-05-17T17:34:23.663Z">
<meta property="article:author" content="Decade W">
<meta property="article:tag" content="learn">
<meta property="article:tag" content="vue">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://blog.decade.run/img/coverimg/vue.jpg"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="http://blog.decade.run/2021/04/06/vue3-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E4%B8%80/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'vue3 源码阅读 init to mount',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-05-18 01:34:23'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="王小明" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">59</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">21</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">18</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tag</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/coverimg/vue.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">王小明</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tag</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">vue3 源码阅读 init to mount</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-04-06T07:50:56.000Z" title="发表于 2021-04-06 15:50:56">2021-04-06</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-05-17T17:34:23.663Z" title="更新于 2021-05-18 01:34:23">2021-05-18</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/vue3/">vue3</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="vue3 源码阅读 init to mount"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="从创建到挂载完成"><a href="#从创建到挂载完成" class="headerlink" title="从创建到挂载完成"></a>从创建到挂载完成</h1><p>我的初始模板: </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;&#123; state.num &#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- &lt;div&gt;&#123;&#123; num &#125;&#125;&lt;/div&gt; --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;handleClick&quot;</span>&gt;</span>click<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;../../dist/vue.global.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> &#123;</span></span><br><span class="line"><span class="javascript">    createApp,</span></span><br><span class="line"><span class="javascript">    reactive</span></span><br><span class="line"><span class="javascript">  &#125; = <span class="built_in">this</span>.Vue;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">debugger</span></span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> app = createApp(&#123;</span></span><br><span class="line"><span class="javascript">    <span class="comment">// composition api</span></span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="title">setup</span>(<span class="params"></span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> obj = &#123;</span></span><br><span class="line"><span class="javascript">        <span class="attr">num</span>: <span class="number">1</span></span></span><br><span class="line"><span class="javascript">      &#125;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">const</span> state = reactive(obj)</span></span><br><span class="line"><span class="javascript">      <span class="keyword">const</span> handleClick = <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">        state.num++;</span></span><br><span class="line"><span class="javascript">      &#125;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="javascript">        state,</span></span><br><span class="line"><span class="javascript">        handleClick</span></span><br><span class="line"><span class="javascript">      &#125;</span></span><br><span class="line"><span class="javascript">    &#125;</span></span><br><span class="line"><span class="javascript">    <span class="comment">// option api</span></span></span><br><span class="line"><span class="javascript">    <span class="comment">// data() &#123;</span></span></span><br><span class="line"><span class="javascript">    <span class="comment">//   return &#123;</span></span></span><br><span class="line"><span class="javascript">    <span class="comment">//     num: 1</span></span></span><br><span class="line"><span class="javascript">    <span class="comment">//   &#125;</span></span></span><br><span class="line"><span class="javascript">    <span class="comment">// &#125;,</span></span></span><br><span class="line"><span class="javascript">    <span class="comment">// methods: &#123;</span></span></span><br><span class="line"><span class="javascript">    <span class="comment">//   handleClick() &#123;</span></span></span><br><span class="line"><span class="javascript">    <span class="comment">//     this.num++;</span></span></span><br><span class="line"><span class="javascript">    <span class="comment">//   &#125;</span></span></span><br><span class="line"><span class="javascript">    <span class="comment">// &#125;,</span></span></span><br><span class="line"><span class="javascript">  &#125;)</span></span><br><span class="line"><span class="javascript">  app.mount(<span class="string">&quot;#app&quot;</span>);</span></span><br><span class="line"><span class="javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="createApp"><a href="#createApp" class="headerlink" title="createApp"></a>createApp</h2><p><code>packages/runtime-dom/src/index.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> renderer: Renderer&lt;Element&gt; | HydrationRenderer</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回一个renderer</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ensureRenderer</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// render为undefined 走 createRenderer方法</span></span><br><span class="line">  <span class="keyword">return</span> renderer || (renderer = createRenderer&lt;Node, Element&gt;(rendererOptions))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注入 isNativeTag 方法</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">injectNativeTagCheck</span>(<span class="params">app: App</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Inject `isNativeTag`</span></span><br><span class="line">  <span class="comment">// this is used for component name validation (dev only)</span></span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(app.config, <span class="string">&#x27;isNativeTag&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">value</span>: <span class="function">(<span class="params">tag: <span class="built_in">string</span></span>) =&gt;</span> isHTMLTag(tag) || isSVGTag(tag),</span><br><span class="line">    <span class="attr">writable</span>: <span class="literal">false</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> createApp = (<span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 内部创建一个app</span></span><br><span class="line">  <span class="keyword">const</span> app = ensureRenderer().createApp(...args)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123; <span class="comment">// 开发环境下 注入isNativeTag 方法</span></span><br><span class="line">    injectNativeTagCheck(app)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 先保存 之前的mount方法 </span></span><br><span class="line">  <span class="keyword">const</span> &#123; mount &#125; = app</span><br><span class="line">  <span class="comment">// 重置 app的mount方法 </span></span><br><span class="line">  app.mount = (containerOrSelector: Element | ShadowRoot | <span class="built_in">string</span>): <span class="function"><span class="params">any</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// ...省略代码部分</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> app <span class="comment">//返回一个app</span></span><br><span class="line">&#125;) <span class="keyword">as</span> CreateAppFunction&lt;Element&gt;</span><br></pre></td></tr></table></figure>

<h3 id="createRenderer"><a href="#createRenderer" class="headerlink" title="createRenderer"></a>createRenderer</h3><p><code>packages/runtime-core/src/renderer.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 传入DOM的方法 调用 baseCreateRenderer 返回一个renderer</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createRenderer</span>&lt;</span></span><br><span class="line"><span class="function">  <span class="title">HostNode</span> = <span class="title">RendererNode</span>,</span></span><br><span class="line"><span class="function">  <span class="title">HostElement</span> = <span class="title">RendererElement</span></span></span><br><span class="line"><span class="function">&gt;(<span class="params">options: RendererOptions&lt;HostNode, HostElement&gt;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> baseCreateRenderer&lt;HostNode, HostElement&gt;(options)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// baseCreateRenderer重载 </span></span><br><span class="line"><span class="comment">// overload 1: no hydration 只有一个参数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">baseCreateRenderer</span>&lt;</span></span><br><span class="line"><span class="function">  <span class="title">HostNode</span> = <span class="title">RendererNode</span>,</span></span><br><span class="line"><span class="function">  <span class="title">HostElement</span> = <span class="title">RendererElement</span></span></span><br><span class="line"><span class="function">&gt;(<span class="params">options: RendererOptions&lt;HostNode, HostElement&gt;</span>): <span class="title">Renderer</span>&lt;<span class="title">HostElement</span>&gt;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">// <span class="title">overload</span> 2: <span class="title">with</span> <span class="title">hydration</span> 两个参数 </span></span><br><span class="line"><span class="function"><span class="function"><span class="keyword">function</span> <span class="title">baseCreateRenderer</span>(<span class="params"></span></span></span></span><br><span class="line"><span class="params"><span class="function"><span class="function">  options: RendererOptions&lt;Node, Element&gt;,</span></span></span></span><br><span class="line"><span class="params"><span class="function"><span class="function">  createHydrationFns: <span class="keyword">typeof</span> createHydrationFunctions</span></span></span></span><br><span class="line"><span class="params"><span class="function"><span class="function"></span>): <span class="title">HydrationRenderer</span></span></span></span><br><span class="line"><span class="function"><span class="function"></span></span></span><br><span class="line"><span class="function"><span class="function">// <span class="title">implementation</span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="keyword">function</span> <span class="title">baseCreateRenderer</span>(<span class="params"></span></span></span></span></span><br><span class="line"><span class="params"><span class="function"><span class="function"><span class="function">  options: RendererOptions,</span></span></span></span></span><br><span class="line"><span class="params"><span class="function"><span class="function"><span class="function">  createHydrationFns?: <span class="keyword">typeof</span> createHydrationFunctions</span></span></span></span></span><br><span class="line"><span class="params"><span class="function"><span class="function"><span class="function"></span>): <span class="title">any</span> </span>&#123;</span></span></span><br><span class="line"><span class="function"><span class="function">  // <span class="title">compile</span>-<span class="title">time</span> <span class="title">feature</span> <span class="title">flags</span> <span class="title">check</span></span></span></span><br><span class="line"><span class="function"><span class="function">  <span class="title">if</span> (<span class="params">__ESM_BUNDLER__ &amp;&amp; !__TEST__</span>) </span>&#123;</span></span><br><span class="line"><span class="function">    <span class="title">initFeatureFlags</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">  &#125;</span></span><br><span class="line"><span class="function">	</span></span><br><span class="line"><span class="function">  // 取出操作<span class="title">DOM</span>的方法</span></span><br><span class="line"><span class="function">  <span class="title">const</span> </span>&#123;</span><br><span class="line">    <span class="attr">insert</span>: hostInsert,</span><br><span class="line">    <span class="attr">remove</span>: hostRemove,</span><br><span class="line">    <span class="attr">patchProp</span>: hostPatchProp,</span><br><span class="line">    <span class="attr">forcePatchProp</span>: hostForcePatchProp,</span><br><span class="line">    <span class="attr">createElement</span>: hostCreateElement,</span><br><span class="line">    <span class="attr">createText</span>: hostCreateText,</span><br><span class="line">    <span class="attr">createComment</span>: hostCreateComment,</span><br><span class="line">    <span class="attr">setText</span>: hostSetText,</span><br><span class="line">    <span class="attr">setElementText</span>: hostSetElementText,</span><br><span class="line">    <span class="attr">parentNode</span>: hostParentNode,</span><br><span class="line">    <span class="attr">nextSibling</span>: hostNextSibling,</span><br><span class="line">    <span class="attr">setScopeId</span>: hostSetScopeId = NOOP,</span><br><span class="line">    <span class="attr">cloneNode</span>: hostCloneNode,</span><br><span class="line">    <span class="attr">insertStaticContent</span>: hostInsertStaticContent</span><br><span class="line">  &#125; = options</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Note: functions inside this closure should use `const xxx = () =&gt; &#123;&#125;`</span></span><br><span class="line">  <span class="comment">// style in order to prevent being inlined by minifiers.</span></span><br><span class="line">  <span class="comment">// patch方法</span></span><br><span class="line">  <span class="keyword">const</span> patch: PatchFn = <span class="function">(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    n1,</span></span></span><br><span class="line"><span class="params"><span class="function">    n2,</span></span></span><br><span class="line"><span class="params"><span class="function">    container,</span></span></span><br><span class="line"><span class="params"><span class="function">    anchor = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    parentComponent = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    parentSuspense = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    isSVG = <span class="literal">false</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    optimized = <span class="literal">false</span></span></span></span><br><span class="line"><span class="params"><span class="function">  </span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 省略部分代码</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  	省略很多代码</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// render方法</span></span><br><span class="line">  <span class="keyword">const</span> render: RootRenderFunction = <span class="function">(<span class="params">vnode, container</span>) =&gt;</span> &#123; </span><br><span class="line">  	<span class="comment">// 省略部分代码</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> internals: RendererInternals = &#123;</span><br><span class="line">    <span class="attr">p</span>: patch,</span><br><span class="line">    <span class="attr">um</span>: unmount,</span><br><span class="line">    <span class="attr">m</span>: move,</span><br><span class="line">    <span class="attr">r</span>: remove,</span><br><span class="line">    <span class="attr">mt</span>: mountComponent,</span><br><span class="line">    <span class="attr">mc</span>: mountChildren,</span><br><span class="line">    <span class="attr">pc</span>: patchChildren,</span><br><span class="line">    <span class="attr">pbc</span>: patchBlockChildren,</span><br><span class="line">    <span class="attr">n</span>: getNextHostNode,</span><br><span class="line">    <span class="attr">o</span>: options</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> hydrate: ReturnType&lt;<span class="keyword">typeof</span> createHydrationFunctions&gt;[<span class="number">0</span>] | <span class="literal">undefined</span></span><br><span class="line">  <span class="keyword">let</span> hydrateNode: ReturnType&lt;<span class="keyword">typeof</span> createHydrationFunctions&gt;[<span class="number">1</span>] | <span class="literal">undefined</span></span><br><span class="line">  <span class="keyword">if</span> (createHydrationFns) &#123; <span class="comment">// 是否有第二个参数 注水?? 这个操作我还是有点不明白</span></span><br><span class="line">    ;[hydrate, hydrateNode] = createHydrationFns(internals <span class="keyword">as</span> RendererInternals&lt;</span><br><span class="line">      Node,</span><br><span class="line">      Element</span><br><span class="line">    &gt;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 返回一个对象,</span></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    render,</span><br><span class="line">    hydrate,</span><br><span class="line">    <span class="attr">createApp</span>: createAppAPI(render, hydrate) <span class="comment">// 调用 createAppAPI 方法</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="createAppAPI"><a href="#createAppAPI" class="headerlink" title="createAppAPI"></a>createAppAPI</h3><p><code>packages/runtime-core/scr/apiCreateApp.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回一个上下文对象</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createAppContext</span>(<span class="params"></span>): <span class="title">AppContext</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">app</span>: <span class="literal">null</span> <span class="keyword">as</span> <span class="built_in">any</span>, <span class="comment">// 实例</span></span><br><span class="line">    <span class="attr">config</span>: &#123;</span><br><span class="line">      <span class="attr">isNativeTag</span>: NO, <span class="comment">// NO 该方法永远返回false </span></span><br><span class="line">      <span class="attr">performance</span>: <span class="literal">false</span>, </span><br><span class="line">      <span class="attr">globalProperties</span>: &#123;&#125;, <span class="comment">// 挂载在全局属性上的 比如 app.config.globalProperties.$axios = axios</span></span><br><span class="line">      <span class="attr">optionMergeStrategies</span>: &#123;&#125;, <span class="comment">// option 合并策略</span></span><br><span class="line">      <span class="attr">isCustomElement</span>: NO,</span><br><span class="line">      <span class="attr">errorHandler</span>: <span class="literal">undefined</span>, <span class="comment">// 报错时的方法</span></span><br><span class="line">      <span class="attr">warnHandler</span>: <span class="literal">undefined</span> <span class="comment">// 警告时的方法</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">mixins</span>: [], <span class="comment">// mixins数组</span></span><br><span class="line">    <span class="attr">components</span>: &#123;&#125;, <span class="comment">// 组件</span></span><br><span class="line">    <span class="attr">directives</span>: &#123;&#125;, <span class="comment">// 指令</span></span><br><span class="line">    <span class="attr">provides</span>: <span class="built_in">Object</span>.create(<span class="literal">null</span>) <span class="comment">// 注入 provide/inject</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回的是一个createApp方法 这个方法 返回一个app对象</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createAppAPI</span>&lt;<span class="title">HostElement</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  render: RootRenderFunction,</span></span></span><br><span class="line"><span class="params"><span class="function">  hydrate?: RootHydrateFunction</span></span></span><br><span class="line"><span class="params"><span class="function"></span>): <span class="title">CreateAppFunction</span>&lt;<span class="title">HostElement</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">createApp</span>(<span class="params">rootComponent, rootProps = <span class="literal">null</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (rootProps != <span class="literal">null</span> &amp;&amp; !isObject(rootProps)) &#123;</span><br><span class="line">      __DEV__ &amp;&amp; warn(<span class="string">`root props passed to app.mount() must be an object.`</span>)</span><br><span class="line">      rootProps = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> context = createAppContext() <span class="comment">// 初始化上下文</span></span><br><span class="line">    <span class="keyword">const</span> installedPlugins = <span class="keyword">new</span> <span class="built_in">Set</span>() <span class="comment">// 插件是一个set集合</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> isMounted = <span class="literal">false</span> <span class="comment">// 初始挂载状态为false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化 app</span></span><br><span class="line">    <span class="keyword">const</span> app: App = (context.app = &#123;</span><br><span class="line">      <span class="attr">_uid</span>: uid++, <span class="comment">// uid自增</span></span><br><span class="line">      _component: rootComponent <span class="keyword">as</span> ConcreteComponent, <span class="comment">// 传入的 &#123; setup() &#123; return &#123;xxx&#125; &#125; &#125; 这样的对象</span></span><br><span class="line">      <span class="attr">_props</span>: rootProps,</span><br><span class="line">      <span class="attr">_container</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="attr">_context</span>: context, <span class="comment">// 上下文</span></span><br><span class="line"></span><br><span class="line">      version,</span><br><span class="line"></span><br><span class="line">      <span class="keyword">get</span> <span class="title">config</span>() &#123;</span><br><span class="line">        <span class="keyword">return</span> context.config <span class="comment">// app.config.globalProperties.$axios = axios</span></span><br><span class="line">      &#125;,</span><br><span class="line">		</span><br><span class="line">     	<span class="comment">// 不允许修改</span></span><br><span class="line">      <span class="keyword">set</span> <span class="title">config</span>(<span class="params">v</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          warn(</span><br><span class="line">            <span class="string">`app.config cannot be replaced. Modify individual options instead.`</span></span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// use方法 安装插件 返回app本身</span></span><br><span class="line">      <span class="function"><span class="title">use</span>(<span class="params">plugin: Plugin, ...options: <span class="built_in">any</span>[]</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (installedPlugins.has(plugin)) &#123; <span class="comment">// 避免重复安装</span></span><br><span class="line">          __DEV__ &amp;&amp; warn(<span class="string">`Plugin has already been applied to target app.`</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (plugin &amp;&amp; isFunction(plugin.install)) &#123; <span class="comment">// plugin可以是一个对象但必须有install这个属性 且必须是一个方法</span></span><br><span class="line">          installedPlugins.add(plugin) <span class="comment">// 放入set集合</span></span><br><span class="line">          plugin.install(app, ...options) <span class="comment">// 调用自己的 install 方法</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isFunction(plugin)) &#123; <span class="comment">// plugin就是一个方法</span></span><br><span class="line">          installedPlugins.add(plugin) <span class="comment">// 放入set 集合</span></span><br><span class="line">          plugin(app, ...options) <span class="comment">// 执行方法</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          warn(</span><br><span class="line">            <span class="string">`A plugin must either be a function or an object with an &quot;install&quot; `</span> +</span><br><span class="line">              <span class="string">`function.`</span></span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> app</span><br><span class="line">      &#125;,</span><br><span class="line">		</span><br><span class="line">      <span class="comment">// 混入方法</span></span><br><span class="line">      <span class="function"><span class="title">mixin</span>(<span class="params">mixin: ComponentOptions</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 如果是optionApi 就能用</span></span><br><span class="line">        <span class="keyword">if</span> (__FEATURE_OPTIONS_API__) &#123;</span><br><span class="line">          <span class="keyword">if</span> (!context.mixins.includes(mixin)) &#123; <span class="comment">// 如果不存在</span></span><br><span class="line">            context.mixins.push(mixin) <span class="comment">// 添加进去</span></span><br><span class="line">            <span class="comment">// global mixin with props/emits de-optimizes props/emits</span></span><br><span class="line">            <span class="comment">// normalization caching.</span></span><br><span class="line">            <span class="keyword">if</span> (mixin.props || mixin.emits) &#123;</span><br><span class="line">              context.deopt = <span class="literal">true</span> <span class="comment">// 反优化</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">            warn(</span><br><span class="line">              <span class="string">&#x27;Mixin has already been applied to target app&#x27;</span> +</span><br><span class="line">                (mixin.name ? <span class="string">`: <span class="subst">$&#123;mixin.name&#125;</span>`</span> : <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">            )</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          warn(<span class="string">&#x27;Mixins are only available in builds supporting Options API&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> app</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 注册组件 / 获取组件</span></span><br><span class="line">      component(name: <span class="built_in">string</span>, component?: Component): <span class="built_in">any</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          validateComponentName(name, context.config) <span class="comment">// 验证组件名称</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!component) &#123; <span class="comment">// 第二个参数不存在, 返回组件</span></span><br><span class="line">          <span class="keyword">return</span> context.components[name]  </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (__DEV__ &amp;&amp; context.components[name]) &#123; <span class="comment">// 组件存在 警告</span></span><br><span class="line">          warn(<span class="string">`Component &quot;<span class="subst">$&#123;name&#125;</span>&quot; has already been registered in target app.`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        context.components[name] = component <span class="comment">// 注册成功</span></span><br><span class="line">        <span class="keyword">return</span> app</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 注册 指令 / 返回指令</span></span><br><span class="line">      <span class="function"><span class="title">directive</span>(<span class="params">name: <span class="built_in">string</span>, directive?: Directive</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          validateDirectiveName(name) <span class="comment">// 验证指令名称</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!directive) &#123; <span class="comment">// 第二个参数不存在 返回指令</span></span><br><span class="line">          <span class="keyword">return</span> context.directives[name] <span class="keyword">as</span> <span class="built_in">any</span> </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (__DEV__ &amp;&amp; context.directives[name]) &#123; <span class="comment">// 指令已经存在 警告</span></span><br><span class="line">          warn(<span class="string">`Directive &quot;<span class="subst">$&#123;name&#125;</span>&quot; has already been registered in target app.`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        context.directives[name] = directive <span class="comment">// 注册成功</span></span><br><span class="line">        <span class="keyword">return</span> app</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 挂载的方法</span></span><br><span class="line">      mount(rootContainer: HostElement, isHydrate?: <span class="built_in">boolean</span>): <span class="built_in">any</span> &#123;</span><br><span class="line">        <span class="comment">// 省略代码部分</span></span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 移出的方法</span></span><br><span class="line">      <span class="function"><span class="title">unmount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (isMounted) &#123; <span class="comment">// 确定已经挂载过了的 才能执行该方法</span></span><br><span class="line">          render(<span class="literal">null</span>, app._container)</span><br><span class="line">          <span class="keyword">if</span> (__DEV__ || __FEATURE_PROD_DEVTOOLS__) &#123;</span><br><span class="line">            devtoolsUnmountApp(app) </span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          warn(<span class="string">`Cannot unmount an app that is not mounted.`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// provide 方法</span></span><br><span class="line">      <span class="function"><span class="title">provide</span>(<span class="params">key, value</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 检测是否注册过 提示注册过的会被修改成新值</span></span><br><span class="line">        <span class="keyword">if</span> (__DEV__ &amp;&amp; (key <span class="keyword">as</span> <span class="built_in">string</span> | symbol) <span class="keyword">in</span> context.provides) &#123;</span><br><span class="line">          warn(</span><br><span class="line">            <span class="string">`App already provides property with key &quot;<span class="subst">$&#123;<span class="built_in">String</span>(key)&#125;</span>&quot;. `</span> +</span><br><span class="line">              <span class="string">`It will be overwritten with the new value.`</span></span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// TypeScript doesn&#x27;t allow symbols as index type</span></span><br><span class="line">        <span class="comment">// https://github.com/Microsoft/TypeScript/issues/24587</span></span><br><span class="line">        context.provides[key <span class="keyword">as</span> <span class="built_in">string</span>] = value <span class="comment">// 加到provides里面</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> app</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> app</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="mount"><a href="#mount" class="headerlink" title="mount"></a>mount</h2><p>当我们执行 <strong><code>app.mount(&quot;#app&quot;)</code></strong> 方法 会进入到下面的代码里面, 我把关键的代码留下来, 其实这个方法的返回值是之前没有重写的<code>mount</code> 方法的返回值</p>
<p>修改之后的<code>mount</code>在 <code>packages/runtime-dom/index.ts</code></p>
<p>修改之前的<code>mount</code>在<code>packages/runtime-core/src/apiCreateApp.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回一个DOM或者null</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">normalizeContainer</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  container: Element | ShadowRoot | <span class="built_in">string</span></span></span></span><br><span class="line"><span class="params"><span class="function"></span>): <span class="title">Element</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (isString(container)) &#123; <span class="comment">// 如果是字符串 如 &quot;#app&quot;</span></span><br><span class="line">    <span class="keyword">const</span> res = <span class="built_in">document</span>.querySelector(container) <span class="comment">// 获取DOM</span></span><br><span class="line">    <span class="keyword">if</span> (__DEV__ &amp;&amp; !res) &#123; <span class="comment">// 开发环境下没有获取到 警告</span></span><br><span class="line">      warn(</span><br><span class="line">        <span class="string">`Failed to mount app: mount target selector &quot;<span class="subst">$&#123;container&#125;</span>&quot; returned null.`</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 如果继承 ShadowRoot 且 mode属性为 closed 警告</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    __DEV__ &amp;&amp;</span><br><span class="line">    container <span class="keyword">instanceof</span> ShadowRoot &amp;&amp;</span><br><span class="line">    container.mode === <span class="string">&#x27;closed&#x27;</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    warn(</span><br><span class="line">      <span class="string">`mounting on a ShadowRoot with \`&#123;mode: &quot;closed&quot;&#125;\` may lead to unpredictable bugs`</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> container <span class="keyword">as</span> <span class="built_in">any</span></span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="comment">// 重写的mount方法</span></span><br><span class="line">app.mount = (containerOrSelector: Element | ShadowRoot | <span class="built_in">string</span>): <span class="function"><span class="params">any</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> container =  normalizeContainer(containerOrSelector)</span><br><span class="line">    <span class="keyword">if</span> (!container) <span class="keyword">return</span> <span class="comment">// 直接return</span></span><br><span class="line">    <span class="keyword">const</span> component = app._component <span class="comment">// 获取app的_componet属性 这里就是我们的 setup函数所在的那个对象</span></span><br><span class="line">    <span class="keyword">if</span> (!isFunction(component) &amp;&amp; !component.render &amp;&amp; !component.template) &#123; <span class="comment">// 这个对象没有不是函数, 没有render方法, 没有template </span></span><br><span class="line">      component.template = container.innerHTML <span class="comment">// 则将获取到的DOM作为 template属性的值</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// clear content before mounting</span></span><br><span class="line">    container.innerHTML = <span class="string">&#x27;&#x27;</span> <span class="comment">// 清空</span></span><br><span class="line">    <span class="keyword">const</span> proxy = mount(container) <span class="comment">// 执行之前保存的mount方法</span></span><br><span class="line">    <span class="keyword">if</span> (container <span class="keyword">instanceof</span> Element) &#123; <span class="comment">// 如果 container 继承 Element</span></span><br><span class="line">      container.removeAttribute(<span class="string">&#x27;v-cloak&#x27;</span>) <span class="comment">// 移出v-cloak属性</span></span><br><span class="line">      container.setAttribute(<span class="string">&#x27;data-v-app&#x27;</span>, <span class="string">&#x27;&#x27;</span>) <span class="comment">// 添加 data-v-app属性</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> proxy <span class="comment">// 返回mount结果</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 原本的mount方法 </span></span><br><span class="line">mount(rootContainer: HostElement, isHydrate?: <span class="built_in">boolean</span>): <span class="built_in">any</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!isMounted) &#123; <span class="comment">// 没有挂载 创建根vnode</span></span><br><span class="line">    <span class="keyword">const</span> vnode = createVNode(</span><br><span class="line">      rootComponent <span class="keyword">as</span> ConcreteComponent,</span><br><span class="line">      rootProps</span><br><span class="line">    )</span><br><span class="line">    <span class="comment">// store app context on the root VNode.</span></span><br><span class="line">    <span class="comment">// this will be set on the root instance on initial mount.</span></span><br><span class="line">    vnode.appContext = context <span class="comment">// 加入上下文</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// HMR root reload </span></span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123; <span class="comment">// 开发环境下 自定义reload方法</span></span><br><span class="line">      context.reload = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        render(cloneVNode(vnode), rootContainer)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注水 则调用 hydrate</span></span><br><span class="line">    <span class="keyword">if</span> (isHydrate &amp;&amp; hydrate) &#123;</span><br><span class="line">      hydrate(vnode <span class="keyword">as</span> VNode&lt;Node, Element&gt;, rootContainer <span class="keyword">as</span> <span class="built_in">any</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">//否则调用render方法</span></span><br><span class="line">      render(vnode, rootContainer)</span><br><span class="line">    &#125;</span><br><span class="line">    isMounted = <span class="literal">true</span> <span class="comment">// render完毕 重置为true 当前组件已经挂载</span></span><br><span class="line">    app._container = rootContainer </span><br><span class="line">    <span class="comment">// for devtools and telemetry</span></span><br><span class="line">    <span class="comment">// __vue_app__ 属性指向自己</span></span><br><span class="line">    ;(rootContainer <span class="keyword">as</span> <span class="built_in">any</span>).__vue_app__ = app</span><br><span class="line">    <span class="keyword">if</span> (__DEV__ || __FEATURE_PROD_DEVTOOLS__) &#123; <span class="comment">// devtool工具</span></span><br><span class="line">      devtoolsInitApp(app, version)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> vnode.component!.proxy <span class="comment">// 返回一个vnode</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      warn(</span><br><span class="line">        <span class="string">`App has already been mounted.\n`</span> +</span><br><span class="line">          <span class="string">`If you want to remount the same app, move your app creation logic `</span> +</span><br><span class="line">          <span class="string">`into a factory function and create fresh app instances for each `</span> +</span><br><span class="line">          <span class="string">`mount - e.g. \`const createMyApp = () =&gt; createApp(App)\``</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>

<h3 id="createVNode"><a href="#createVNode" class="headerlink" title="createVNode"></a>createVNode</h3><p><code>packages/runtime-core/src/vnode.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 开发环境下 调用的 createVNodeWithArgsTransform</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> createVNode = (__DEV__ ? createVNodeWithArgsTransform : _createVNode) <span class="keyword">as</span> <span class="keyword">typeof</span> _createVNode</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回的是 _createVNode 方法完成后的值 vnodeArgsTransformer默认值为undefined </span></span><br><span class="line"><span class="keyword">const</span> createVNodeWithArgsTransform = (</span><br><span class="line">  ...args: Parameters&lt;<span class="keyword">typeof</span> _createVNode&gt;</span><br><span class="line">): <span class="function"><span class="params">VNode</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> _createVNode(</span><br><span class="line">    ...(vnodeArgsTransformer</span><br><span class="line">      ? vnodeArgsTransformer(args, currentRenderingInstance)</span><br><span class="line">      : args)</span><br><span class="line">  ) <span class="comment">// 这里相当于调用的是 _createVNode(...args)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// VNode类型会有一个 __v_isVNode这个属性为true</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">isVNode</span>(<span class="params">value: <span class="built_in">any</span></span>): <span class="title">value</span> <span class="title">is</span> <span class="title">VNode</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> value ? value.__v_isVNode === <span class="literal">true</span> : <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 传入的值是function 并且有 __vccOpts 这个属性 该方法在packages/runtime-core/src/component.ts里面</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">isClassComponent</span>(<span class="params">value: unknown</span>): <span class="title">value</span> <span class="title">is</span> <span class="title">ClassComponent</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> isFunction(value) &amp;&amp; <span class="string">&#x27;__vccOpts&#x27;</span> <span class="keyword">in</span> value</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 取出 键值key 对应的值 如果不为null 则返回 否则返回null</span></span><br><span class="line"><span class="keyword">const</span> normalizeKey = (&#123; key &#125;: VNodeProps): VNode[<span class="string">&#x27;key&#x27;</span>] =&gt;</span><br><span class="line">  key != <span class="literal">null</span> ? key : <span class="literal">null</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 取出 键值ref 对应的值 如果为null, 返回null, 不为null 且 是字符串或者是一个Ref 或者是一个方法, 返回一个对象, 否则返回本身</span></span><br><span class="line"><span class="keyword">const</span> normalizeRef = (&#123; ref &#125;: VNodeProps): VNodeNormalizedRefAtom | <span class="function"><span class="params">null</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (ref != <span class="literal">null</span></span><br><span class="line">    ? isString(ref) || isRef(ref) || isFunction(ref)</span><br><span class="line">      ? &#123; <span class="attr">i</span>: currentRenderingInstance, <span class="attr">r</span>: ref &#125;</span><br><span class="line">      : ref</span><br><span class="line">    : <span class="literal">null</span>) <span class="keyword">as</span> <span class="built_in">any</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 正常化子节点</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">normalizeChildren</span>(<span class="params">vnode: VNode, children: unknown</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> <span class="keyword">type</span> = <span class="number">0</span></span><br><span class="line">  <span class="keyword">const</span> &#123; shapeFlag &#125; = vnode <span class="comment">// 取出 shapeFlag</span></span><br><span class="line">  <span class="keyword">if</span> (children == <span class="literal">null</span>) &#123; <span class="comment">// 传入的children为null</span></span><br><span class="line">    children = <span class="literal">null</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isArray(children)) &#123; </span><br><span class="line">    <span class="comment">// 省略部分代码</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 重新赋值</span></span><br><span class="line">  vnode.children = children <span class="keyword">as</span> VNodeNormalizedChildren</span><br><span class="line">  <span class="comment">// 改变vnode shapeFlag</span></span><br><span class="line">  vnode.shapeFlag |= <span class="keyword">type</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 参数有6个 type与后面生成的shapeFlag有关, props是传入的属性, children是子元素/子组件数组, patchFlag 和patch有关, dynamicProps动态属性数组, 是否是blockNode</span></span><br><span class="line"><span class="comment">// 我们mount 传入进来的其实是那个 rootComponent 也就是我们传入createApp里面的那个对象 不过处理后 里面多了一个template属性 里面是我们的app的根元素</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_createVNode</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">type</span>: VNodeTypes | ClassComponent | <span class="keyword">typeof</span> NULL_DYNAMIC_COMPONENT,</span></span></span><br><span class="line"><span class="params"><span class="function">  props: (Data &amp; VNodeProps) | <span class="literal">null</span> = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  children: unknown = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  patchFlag: <span class="built_in">number</span> = <span class="number">0</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  dynamicProps: <span class="built_in">string</span>[] | <span class="literal">null</span> = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  isBlockNode = <span class="literal">false</span></span></span></span><br><span class="line"><span class="params"><span class="function"></span>): <span class="title">VNode</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 遇到type不传 或者 类型是Symbol类型的 发出警告</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">type</span> || <span class="keyword">type</span> === NULL_DYNAMIC_COMPONENT) &#123;</span><br><span class="line">    <span class="keyword">if</span> (__DEV__ &amp;&amp; !<span class="keyword">type</span>) &#123;</span><br><span class="line">      warn(<span class="string">`Invalid vnode type when creating vnode: <span class="subst">$&#123;<span class="keyword">type</span>&#125;</span>.`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">type</span> = Comment <span class="comment">// 并标记为 注释类型</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 判断是否是VNode</span></span><br><span class="line">  <span class="keyword">if</span> (isVNode(<span class="keyword">type</span>)) &#123;</span><br><span class="line">    <span class="comment">// createVNode receiving an existing vnode. This happens in cases like</span></span><br><span class="line">    <span class="comment">// &lt;component :is=&quot;vnode&quot;/&gt;</span></span><br><span class="line">    <span class="comment">// #2078 make sure to merge refs during the clone instead of overwriting it</span></span><br><span class="line">    <span class="keyword">const</span> cloned = cloneVNode(<span class="keyword">type</span>, props, <span class="literal">true</span> <span class="comment">/* mergeRef: true */</span>)</span><br><span class="line">    <span class="keyword">if</span> (children) &#123;</span><br><span class="line">      normalizeChildren(cloned, children)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cloned</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> 	<span class="comment">// 判断是否是classComponent</span></span><br><span class="line">  <span class="comment">// class component normalization.</span></span><br><span class="line">  <span class="keyword">if</span> (isClassComponent(<span class="keyword">type</span>)) &#123;</span><br><span class="line">    <span class="keyword">type</span> = <span class="keyword">type</span>.__vccOpts</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// props存在 则进入里面 </span></span><br><span class="line">  <span class="comment">// class &amp; style normalization.</span></span><br><span class="line">  <span class="keyword">if</span> (props) &#123;</span><br><span class="line">    <span class="comment">// for reactive or proxy objects, we need to clone it to enable mutation.</span></span><br><span class="line">    <span class="keyword">if</span> (isProxy(props) || InternalObjectKey <span class="keyword">in</span> props) &#123;</span><br><span class="line">      props = extend(&#123;&#125;, props)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> &#123; <span class="attr">class</span>: klass, style &#125; = props</span><br><span class="line">    <span class="keyword">if</span> (klass &amp;&amp; !isString(klass)) &#123;</span><br><span class="line">      props.class = normalizeClass(klass)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (isObject(style)) &#123;</span><br><span class="line">      <span class="comment">// reactive state objects need to be cloned since they are likely to be</span></span><br><span class="line">      <span class="comment">// mutated</span></span><br><span class="line">      <span class="keyword">if</span> (isProxy(style) &amp;&amp; !isArray(style)) &#123;</span><br><span class="line">        style = extend(&#123;&#125;, style)</span><br><span class="line">      &#125;</span><br><span class="line">      props.style = normalizeStyle(style)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 根据type 来生成shapeFlag</span></span><br><span class="line">  <span class="comment">// encode the vnode type information into a bitmap</span></span><br><span class="line">  <span class="keyword">const</span> shapeFlag = isString(<span class="keyword">type</span>)</span><br><span class="line">    ? ShapeFlags.ELEMENT <span class="comment">// 元素 1</span></span><br><span class="line">    : __FEATURE_SUSPENSE__ &amp;&amp; isSuspense(<span class="keyword">type</span>) </span><br><span class="line">      ? ShapeFlags.SUSPENSE <span class="comment">// suspense 128</span></span><br><span class="line">      : isTeleport(<span class="keyword">type</span>)</span><br><span class="line">        ? ShapeFlags.TELEPORT <span class="comment">// teleport 64</span></span><br><span class="line">        : isObject(<span class="keyword">type</span>)</span><br><span class="line">          ? ShapeFlags.STATEFUL_COMPONENT <span class="comment">// 有状态的组件 4</span></span><br><span class="line">          : isFunction(<span class="keyword">type</span>)</span><br><span class="line">            ? ShapeFlags.FUNCTIONAL_COMPONENT <span class="comment">// 函数组件 2</span></span><br><span class="line">            : <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// shapeFlag &amp; ShapeFlags.STATEFUL_COMPONENT 结果不为0 且不为响应式</span></span><br><span class="line">  <span class="keyword">if</span> (__DEV__ &amp;&amp; shapeFlag &amp; ShapeFlags.STATEFUL_COMPONENT &amp;&amp; isProxy(<span class="keyword">type</span>)) &#123;</span><br><span class="line">    <span class="keyword">type</span> = toRaw(<span class="keyword">type</span>)</span><br><span class="line">    warn(</span><br><span class="line">      <span class="string">`Vue received a Component which was made a reactive object. This can `</span> +</span><br><span class="line">        <span class="string">`lead to unnecessary performance overhead, and should be avoided by `</span> +</span><br><span class="line">        <span class="string">`marking the component with \`markRaw\` or using \`shallowRef\` `</span> +</span><br><span class="line">        <span class="string">`instead of \`ref\`.`</span>,</span><br><span class="line">      <span class="string">`\nComponent that was made reactive: `</span>,</span><br><span class="line">      <span class="keyword">type</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建VNode</span></span><br><span class="line">  <span class="keyword">const</span> vnode: VNode = &#123;</span><br><span class="line">    <span class="attr">__v_isVNode</span>: <span class="literal">true</span>, <span class="comment">// 判断是否是VNode的标记</span></span><br><span class="line">    [ReactiveFlags.SKIP]: <span class="literal">true</span>, <span class="comment">// 后面跳过 reactive 会用到这个属性 标识VNode不是observable</span></span><br><span class="line">    <span class="keyword">type</span>,</span><br><span class="line">    props, <span class="comment">// 属性信息</span></span><br><span class="line">    <span class="attr">key</span>: props &amp;&amp; normalizeKey(props),  <span class="comment">// 特殊 attribute 主要用在 Vue 的虚拟 DOM 算法</span></span><br><span class="line">    <span class="attr">ref</span>: props &amp;&amp; normalizeRef(props),  <span class="comment">// 被用来给元素或子组件注册引用信息。</span></span><br><span class="line">    <span class="attr">scopeId</span>: currentScopeId, <span class="comment">// SFC only</span></span><br><span class="line">    <span class="attr">children</span>: <span class="literal">null</span>, <span class="comment">// 保存子节点</span></span><br><span class="line">    <span class="attr">component</span>: <span class="literal">null</span>, <span class="comment">// 指向VNode对应的组件实例</span></span><br><span class="line">    <span class="attr">suspense</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">ssContent</span>: <span class="literal">null</span>, </span><br><span class="line">    <span class="attr">ssFallback</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">dirs</span>: <span class="literal">null</span>, <span class="comment">// 保存应用在VNode的指令信息</span></span><br><span class="line">    <span class="attr">transition</span>: <span class="literal">null</span>, <span class="comment">// 存储过渡效果信息</span></span><br><span class="line">    <span class="attr">el</span>: <span class="literal">null</span>, <span class="comment">// element </span></span><br><span class="line">    <span class="attr">anchor</span>: <span class="literal">null</span>, <span class="comment">// fragment 锚点</span></span><br><span class="line">    <span class="attr">target</span>: <span class="literal">null</span>, <span class="comment">// teleport 目标节点</span></span><br><span class="line">    <span class="attr">targetAnchor</span>: <span class="literal">null</span>,  <span class="comment">// teleport 目标锚点</span></span><br><span class="line">    <span class="attr">staticCount</span>: <span class="number">0</span>, <span class="comment">// 静态节点个数</span></span><br><span class="line">    shapeFlag, </span><br><span class="line">    patchFlag,</span><br><span class="line">    dynamicProps,</span><br><span class="line">    <span class="attr">dynamicChildren</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">appContext</span>: <span class="literal">null</span> <span class="comment">// 上下文</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 验证key</span></span><br><span class="line">  <span class="comment">// validate key</span></span><br><span class="line">  <span class="keyword">if</span> (__DEV__ &amp;&amp; vnode.key !== vnode.key) &#123;</span><br><span class="line">    warn(<span class="string">`VNode created with invalid key (NaN). VNode type:`</span>, vnode.type)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  normalizeChildren(vnode, children)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// normalize suspense children</span></span><br><span class="line">  <span class="keyword">if</span> (__FEATURE_SUSPENSE__ &amp;&amp; shapeFlag &amp; ShapeFlags.SUSPENSE) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; content, fallback &#125; = normalizeSuspenseChildren(vnode)</span><br><span class="line">    vnode.ssContent = content</span><br><span class="line">    vnode.ssFallback = fallback</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// currentBlock不存在 所以不会执行这里</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    shouldTrack &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">    <span class="comment">// avoid a block node from tracking itself</span></span><br><span class="line">    !isBlockNode &amp;&amp;</span><br><span class="line">    <span class="comment">// has current parent block</span></span><br><span class="line">    currentBlock &amp;&amp;</span><br><span class="line">    <span class="comment">// presence of a patch flag indicates this node needs patching on updates.</span></span><br><span class="line">    <span class="comment">// component nodes also should always be patched, because even if the</span></span><br><span class="line">    <span class="comment">// component doesn&#x27;t need to update, it needs to persist the instance on to</span></span><br><span class="line">    <span class="comment">// the next vnode so that it can be properly unmounted later.</span></span><br><span class="line">    (patchFlag &gt; <span class="number">0</span> || shapeFlag &amp; ShapeFlags.COMPONENT) &amp;&amp;</span><br><span class="line">    <span class="comment">// the EVENTS flag is only for hydration and if it is the only flag, the</span></span><br><span class="line">    <span class="comment">// vnode should not be considered dynamic due to handler caching.</span></span><br><span class="line">    patchFlag !== PatchFlags.HYDRATE_EVENTS</span><br><span class="line">  ) &#123;</span><br><span class="line">    currentBlock.push(vnode)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 返回vnode</span></span><br><span class="line">  <span class="keyword">return</span> vnode</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="render"><a href="#render" class="headerlink" title="render"></a>render</h4><p><code>packages/runtime-core/src/renderer.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 传入两个参数 一个vnode 一个根节点</span></span><br><span class="line"><span class="keyword">const</span> render: RootRenderFunction = <span class="function">(<span class="params">vnode, container</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (vnode == <span class="literal">null</span>) &#123; <span class="comment">// 没有传第一个</span></span><br><span class="line">    <span class="keyword">if</span> (container._vnode) &#123; <span class="comment">// container有_vnode属性</span></span><br><span class="line">      unmount(container._vnode, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">true</span>) <span class="comment">// 卸载</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 执行patch方法 render方法执行的patch 第一个参数是为null的</span></span><br><span class="line">    patch(container._vnode || <span class="literal">null</span>, vnode, container) </span><br><span class="line">  &#125;</span><br><span class="line">  flushPostFlushCbs()</span><br><span class="line">  container._vnode = vnode <span class="comment">// 完成的vnode 挂载在 container _vnode上</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> patch: PatchFn = <span class="function">(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    n1,</span></span></span><br><span class="line"><span class="params"><span class="function">    n2,</span></span></span><br><span class="line"><span class="params"><span class="function">    container,</span></span></span><br><span class="line"><span class="params"><span class="function">    anchor = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    parentComponent = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    parentSuspense = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    isSVG = <span class="literal">false</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    optimized = <span class="literal">false</span></span></span></span><br><span class="line"><span class="params"><span class="function">  </span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// patching &amp; not same type, unmount old tree</span></span><br><span class="line">  	<span class="comment">// n1 存在 且n1, n2 不是相同type的 直接卸载n1</span></span><br><span class="line">    <span class="keyword">if</span> (n1 &amp;&amp; !isSameVNodeType(n1, n2)) &#123;</span><br><span class="line">      anchor = getNextHostNode(n1)</span><br><span class="line">      unmount(n1, parentComponent, parentSuspense, <span class="literal">true</span>)</span><br><span class="line">      n1 = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  	<span class="comment">// 如果 n2.patchFlag === -1</span></span><br><span class="line">    <span class="keyword">if</span> (n2.patchFlag === PatchFlags.BAIL) &#123;</span><br><span class="line">      optimized = <span class="literal">false</span> </span><br><span class="line">      n2.dynamicChildren = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">		</span><br><span class="line">  	<span class="comment">// 获取 type ref shapeFlag</span></span><br><span class="line">    <span class="keyword">const</span> &#123; <span class="keyword">type</span>, ref, shapeFlag &#125; = n2</span><br><span class="line">    <span class="keyword">switch</span> (<span class="keyword">type</span>) &#123;</span><br><span class="line">      <span class="keyword">case</span> Text: <span class="comment">// 处理文本节点</span></span><br><span class="line">        processText(n1, n2, container, anchor)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> Comment: <span class="comment">// 处理注释节点</span></span><br><span class="line">        processCommentNode(n1, n2, container, anchor)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> Static: <span class="comment">// 处理静态节点</span></span><br><span class="line">        <span class="keyword">if</span> (n1 == <span class="literal">null</span>) &#123;</span><br><span class="line">          mountStaticNode(n2, container, anchor, isSVG)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          patchStaticNode(n1, n2, container, isSVG)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> Fragment: <span class="comment">// 处理Fragment节点</span></span><br><span class="line">        processFragment(</span><br><span class="line">          n1,</span><br><span class="line">          n2,</span><br><span class="line">          container,</span><br><span class="line">          anchor,</span><br><span class="line">          parentComponent,</span><br><span class="line">          parentSuspense,</span><br><span class="line">          isSVG,</span><br><span class="line">          optimized</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="attr">default</span>:</span><br><span class="line">        <span class="keyword">if</span> (shapeFlag &amp; ShapeFlags.ELEMENT) &#123; <span class="comment">// 处理元素节点</span></span><br><span class="line">          processElement(</span><br><span class="line">            n1,</span><br><span class="line">            n2,</span><br><span class="line">            container,</span><br><span class="line">            anchor,</span><br><span class="line">            parentComponent,</span><br><span class="line">            parentSuspense,</span><br><span class="line">            isSVG,</span><br><span class="line">            optimized</span><br><span class="line">          )</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shapeFlag &amp; ShapeFlags.COMPONENT) &#123; <span class="comment">// 处理组件 ShapeFlags.COMPONENT是6  4 &amp; 6 为4 不为0满足 调用processComponent()方法</span></span><br><span class="line">          processComponent(</span><br><span class="line">            n1,</span><br><span class="line">            n2,</span><br><span class="line">            container,</span><br><span class="line">            anchor,</span><br><span class="line">            parentComponent,</span><br><span class="line">            parentSuspense,</span><br><span class="line">            isSVG,</span><br><span class="line">            optimized</span><br><span class="line">          )</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shapeFlag &amp; ShapeFlags.TELEPORT) &#123; <span class="comment">// 处理teleport</span></span><br><span class="line">          ;(<span class="keyword">type</span> <span class="keyword">as</span> <span class="keyword">typeof</span> TeleportImpl).process(</span><br><span class="line">            n1 <span class="keyword">as</span> TeleportVNode,</span><br><span class="line">            n2 <span class="keyword">as</span> TeleportVNode,</span><br><span class="line">            container,</span><br><span class="line">            anchor,</span><br><span class="line">            parentComponent,</span><br><span class="line">            parentSuspense,</span><br><span class="line">            isSVG,</span><br><span class="line">            optimized,</span><br><span class="line">            internals</span><br><span class="line">          )</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__FEATURE_SUSPENSE__ &amp;&amp; shapeFlag &amp; ShapeFlags.SUSPENSE) &#123; <span class="comment">// 处理 suspense</span></span><br><span class="line">          ;(<span class="keyword">type</span> <span class="keyword">as</span> <span class="keyword">typeof</span> SuspenseImpl).process(</span><br><span class="line">            n1,</span><br><span class="line">            n2,</span><br><span class="line">            container,</span><br><span class="line">            anchor,</span><br><span class="line">            parentComponent,</span><br><span class="line">            parentSuspense,</span><br><span class="line">            isSVG,</span><br><span class="line">            optimized,</span><br><span class="line">            internals</span><br><span class="line">          )</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          warn(<span class="string">&#x27;Invalid VNode type:&#x27;</span>, <span class="keyword">type</span>, <span class="string">`(<span class="subst">$&#123;<span class="keyword">typeof</span> <span class="keyword">type</span>&#125;</span>)`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> processComponent = <span class="function">(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    n1: VNode | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    n2: VNode,</span></span></span><br><span class="line"><span class="params"><span class="function">    container: RendererElement,</span></span></span><br><span class="line"><span class="params"><span class="function">    anchor: RendererNode | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    parentComponent: ComponentInternalInstance | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    parentSuspense: SuspenseBoundary | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    isSVG: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    optimized: <span class="built_in">boolean</span></span></span></span><br><span class="line"><span class="params"><span class="function">  </span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// n1不存在执行的是挂载</span></span><br><span class="line">    <span class="keyword">if</span> (n1 == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 如果是keep-alive组件</span></span><br><span class="line">      <span class="keyword">if</span> (n2.shapeFlag &amp; ShapeFlags.COMPONENT_KEPT_ALIVE) &#123;</span><br><span class="line">        ;(parentComponent!.ctx <span class="keyword">as</span> KeepAliveContext).activate(</span><br><span class="line">          n2,</span><br><span class="line">          container,</span><br><span class="line">          anchor,</span><br><span class="line">          isSVG,</span><br><span class="line">          optimized</span><br><span class="line">        )</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 执行挂载组件方法</span></span><br><span class="line">        mountComponent(</span><br><span class="line">          n2,</span><br><span class="line">          container,</span><br><span class="line">          anchor,</span><br><span class="line">          parentComponent,</span><br><span class="line">          parentSuspense,</span><br><span class="line">          isSVG,</span><br><span class="line">          optimized</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 存在走的是更新</span></span><br><span class="line">      updateComponent(n1, n2, optimized)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">const</span> mountComponent: MountComponentFn = <span class="function">(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    initialVNode,</span></span></span><br><span class="line"><span class="params"><span class="function">    container,</span></span></span><br><span class="line"><span class="params"><span class="function">    anchor,</span></span></span><br><span class="line"><span class="params"><span class="function">    parentComponent,</span></span></span><br><span class="line"><span class="params"><span class="function">    parentSuspense,</span></span></span><br><span class="line"><span class="params"><span class="function">    isSVG,</span></span></span><br><span class="line"><span class="params"><span class="function">    optimized</span></span></span><br><span class="line"><span class="params"><span class="function">  </span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 初始化instance 并赋值给component属性</span></span><br><span class="line">    <span class="keyword">const</span> instance: ComponentInternalInstance = (initialVNode.component = createComponentInstance(</span><br><span class="line">      initialVNode,</span><br><span class="line">      parentComponent,</span><br><span class="line">      parentSuspense</span><br><span class="line">    ))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 开发环境 且 存在__hmrId</span></span><br><span class="line">    <span class="keyword">if</span> (__DEV__ &amp;&amp; instance.type.__hmrId) &#123;</span><br><span class="line">      registerHMR(instance)</span><br><span class="line">    &#125;</span><br><span class="line">		</span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      pushWarningContext(initialVNode) <span class="comment">// 推荐栈内</span></span><br><span class="line">      startMeasure(instance, <span class="string">`mount`</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// inject renderer internals for keepAlive</span></span><br><span class="line">    <span class="comment">// 处理keepalive</span></span><br><span class="line">    <span class="keyword">if</span> (isKeepAlive(initialVNode)) &#123;</span><br><span class="line">      ;(instance.ctx <span class="keyword">as</span> KeepAliveContext).renderer = internals</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// resolve props and slots for setup context</span></span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      startMeasure(instance, <span class="string">`init`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    setupComponent(instance)</span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      endMeasure(instance, <span class="string">`init`</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// setup() is async. This component relies on async logic to be resolved</span></span><br><span class="line">    <span class="comment">// before proceeding</span></span><br><span class="line">    <span class="keyword">if</span> (__FEATURE_SUSPENSE__ &amp;&amp; instance.asyncDep) &#123;</span><br><span class="line">      parentSuspense &amp;&amp; parentSuspense.registerDep(instance, setupRenderEffect)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Give it a placeholder if this is not hydration</span></span><br><span class="line">      <span class="comment">// TODO handle self-defined fallback</span></span><br><span class="line">      <span class="keyword">if</span> (!initialVNode.el) &#123;</span><br><span class="line">        <span class="keyword">const</span> placeholder = (instance.subTree = createVNode(Comment))</span><br><span class="line">        processCommentNode(<span class="literal">null</span>, placeholder, container!, anchor)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    setupRenderEffect(</span><br><span class="line">      instance,</span><br><span class="line">      initialVNode,</span><br><span class="line">      container,</span><br><span class="line">      anchor,</span><br><span class="line">      parentSuspense,</span><br><span class="line">      isSVG,</span><br><span class="line">      optimized</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      popWarningContext() <span class="comment">// 将当前的VNode弹出堆</span></span><br><span class="line">      endMeasure(instance, <span class="string">`mount`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h4 id="createComponentInstance"><a href="#createComponentInstance" class="headerlink" title="createComponentInstance"></a>createComponentInstance</h4><p><code>packages/runtime-core/src/component.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createComponentInstance</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  vnode: VNode,</span></span></span><br><span class="line"><span class="params"><span class="function">  parent: ComponentInternalInstance | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  suspense: SuspenseBoundary | <span class="literal">null</span></span></span></span><br><span class="line"><span class="params"><span class="function"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">type</span> = vnode.type <span class="keyword">as</span> ConcreteComponent <span class="comment">// 获取type</span></span><br><span class="line">  <span class="comment">// inherit parent app context - or - if root, adopt from root vnode</span></span><br><span class="line">  <span class="comment">// 如果 parent不存在 则赋值vnode的appContext 如果也没有则为 emptyAppContext</span></span><br><span class="line">  <span class="keyword">const</span> appContext = (parent ? parent.appContext : vnode.appContext) || emptyAppContext</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化instance</span></span><br><span class="line">  <span class="keyword">const</span> instance: ComponentInternalInstance = &#123;</span><br><span class="line">    <span class="attr">uid</span>: uid++,</span><br><span class="line">    vnode,</span><br><span class="line">    <span class="keyword">type</span>,</span><br><span class="line">    parent,</span><br><span class="line">    appContext,</span><br><span class="line">    <span class="attr">root</span>: <span class="literal">null</span>!, <span class="comment">// to be immediately set</span></span><br><span class="line">    next: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">subTree</span>: <span class="literal">null</span>!, <span class="comment">// will be set synchronously right after creation 创建后立即同步设置</span></span><br><span class="line">    update: <span class="literal">null</span>!, <span class="comment">// will be set synchronously right after creation 创建后立即同步设置</span></span><br><span class="line">    render: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">proxy</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">exposed</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">withProxy</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">effects</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">provides</span>: parent ? parent.provides : <span class="built_in">Object</span>.create(appContext.provides), <span class="comment">// parent的不存在 就用appContext的</span></span><br><span class="line">    <span class="attr">accessCache</span>: <span class="literal">null</span>!,</span><br><span class="line">    renderCache: [], <span class="comment">// renderCache数组</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// local resovled assets</span></span><br><span class="line">    <span class="attr">components</span>: <span class="literal">null</span>, </span><br><span class="line">    <span class="attr">directives</span>: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// resolved props and emits options</span></span><br><span class="line">    <span class="attr">propsOptions</span>: normalizePropsOptions(<span class="keyword">type</span>, appContext),</span><br><span class="line">    <span class="attr">emitsOptions</span>: normalizeEmitsOptions(<span class="keyword">type</span>, appContext),</span><br><span class="line"></span><br><span class="line">    <span class="comment">// emit</span></span><br><span class="line">    <span class="attr">emit</span>: <span class="literal">null</span> <span class="keyword">as</span> <span class="built_in">any</span>, <span class="comment">// to be set immediately</span></span><br><span class="line">    <span class="attr">emitted</span>: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// state</span></span><br><span class="line">    <span class="attr">ctx</span>: EMPTY_OBJ, <span class="comment">// 上下文对象</span></span><br><span class="line">    <span class="attr">data</span>: EMPTY_OBJ, </span><br><span class="line">    <span class="attr">props</span>: EMPTY_OBJ, <span class="comment">// 属性</span></span><br><span class="line">    <span class="attr">attrs</span>: EMPTY_OBJ, <span class="comment">// 属性</span></span><br><span class="line">    <span class="attr">slots</span>: EMPTY_OBJ, <span class="comment">// 插槽</span></span><br><span class="line">    <span class="attr">refs</span>: EMPTY_OBJ, <span class="comment">// ref</span></span><br><span class="line">    <span class="attr">setupState</span>: EMPTY_OBJ, </span><br><span class="line">    <span class="attr">setupContext</span>: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// suspense related</span></span><br><span class="line">    suspense,</span><br><span class="line">    <span class="attr">suspenseId</span>: suspense ? suspense.pendingId : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">asyncDep</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">asyncResolved</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// lifecycle hooks</span></span><br><span class="line">    <span class="comment">// not using enums here because it results in computed properties</span></span><br><span class="line">    <span class="attr">isMounted</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">isUnmounted</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">isDeactivated</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">bc</span>: <span class="literal">null</span>, <span class="comment">//beforeCreate</span></span><br><span class="line">    <span class="attr">c</span>: <span class="literal">null</span>, <span class="comment">// created</span></span><br><span class="line">    <span class="attr">bm</span>: <span class="literal">null</span>, <span class="comment">// beforeMount</span></span><br><span class="line">    <span class="attr">m</span>: <span class="literal">null</span>, <span class="comment">// mounted</span></span><br><span class="line">    <span class="attr">bu</span>: <span class="literal">null</span>, <span class="comment">// beforeUpdate</span></span><br><span class="line">    <span class="attr">u</span>: <span class="literal">null</span>, <span class="comment">// updated</span></span><br><span class="line">    <span class="attr">um</span>: <span class="literal">null</span>, <span class="comment">// unmounted</span></span><br><span class="line">    <span class="attr">bum</span>: <span class="literal">null</span>, <span class="comment">// beforeUnmount</span></span><br><span class="line">    <span class="attr">da</span>: <span class="literal">null</span>, <span class="comment">// deactivated</span></span><br><span class="line">    <span class="attr">a</span>: <span class="literal">null</span>, <span class="comment">// activated </span></span><br><span class="line">    <span class="attr">rtg</span>: <span class="literal">null</span>, <span class="comment">// errorCaptured</span></span><br><span class="line">    <span class="attr">rtc</span>: <span class="literal">null</span>, <span class="comment">// renderTracked</span></span><br><span class="line">    <span class="attr">ec</span>: <span class="literal">null</span> <span class="comment">// errorCaptured</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123; <span class="comment">// 开发环境下 执行 createRenderContext方法</span></span><br><span class="line">    instance.ctx = createRenderContext(instance) <span class="comment">// ctx上就有了 $watch $data方法 还有了globalProperties上的属性</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    instance.ctx = &#123; <span class="attr">_</span>: instance &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  instance.root = parent ? parent.root : instance <span class="comment">// 如果parent存在 则为parent的root 否则挂载自己的instance</span></span><br><span class="line">  instance.emit = emit.bind(<span class="literal">null</span>, instance) <span class="comment">// 改变this指向instance</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__DEV__ || __FEATURE_PROD_DEVTOOLS__) &#123;</span><br><span class="line">    devtoolsComponentAdded(instance)</span><br><span class="line">  &#125;</span><br><span class="line">	<span class="comment">// 返回实例</span></span><br><span class="line">  <span class="keyword">return</span> instance</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="normalizePropsOptions"><a href="#normalizePropsOptions" class="headerlink" title="normalizePropsOptions"></a>normalizePropsOptions</h5><p><code>packages/runtime-core/src/componentProps.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">normalizePropsOptions</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  comp: ConcreteComponent,</span></span></span><br><span class="line"><span class="params"><span class="function">  appContext: AppContext,</span></span></span><br><span class="line"><span class="params"><span class="function">  asMixin = <span class="literal">false</span></span></span></span><br><span class="line"><span class="params"><span class="function"></span>): <span class="title">NormalizedPropsOptions</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 只有在执行了app.mixin方法后 appContext.deopt才为true</span></span><br><span class="line">  <span class="comment">// 如果appContext.deopt为false 同时 comp存在__props属性 直接返回</span></span><br><span class="line">  <span class="keyword">if</span> (!appContext.deopt &amp;&amp; comp.__props) &#123;</span><br><span class="line">    <span class="keyword">return</span> comp.__props</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> raw = comp.props <span class="comment">// 取出props</span></span><br><span class="line">  <span class="keyword">const</span> normalized: NormalizedPropsOptions[<span class="number">0</span>] = &#123;&#125; <span class="comment">// </span></span><br><span class="line">  <span class="keyword">const</span> needCastKeys: NormalizedPropsOptions[<span class="number">1</span>] = [] <span class="comment">// 需要改变的键值</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// apply mixin/extends props</span></span><br><span class="line">  <span class="keyword">let</span> hasExtends = <span class="literal">false</span> <span class="comment">// 是否扩展</span></span><br><span class="line">  <span class="keyword">if</span> (__FEATURE_OPTIONS_API__ &amp;&amp; !isFunction(comp)) &#123;</span><br><span class="line">    <span class="comment">// 声明一个扩展属性方法</span></span><br><span class="line">    <span class="keyword">const</span> extendProps = <span class="function">(<span class="params">raw: ComponentOptions</span>) =&gt;</span> &#123;</span><br><span class="line">      hasExtends = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">const</span> [props, keys] = normalizePropsOptions(raw, appContext, <span class="literal">true</span>)</span><br><span class="line">      extend(normalized, props)</span><br><span class="line">      <span class="keyword">if</span> (keys) needCastKeys.push(...keys)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// asMixin 为false 且 appContext.mixins数组里面有mixin</span></span><br><span class="line">    <span class="keyword">if</span> (!asMixin &amp;&amp; appContext.mixins.length) &#123;</span><br><span class="line">      appContext.mixins.forEach(extendProps)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 有extends属性</span></span><br><span class="line">    <span class="keyword">if</span> (comp.extends) &#123;</span><br><span class="line">      <span class="comment">// 执行</span></span><br><span class="line">      extendProps(comp.extends)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 有mixins属性</span></span><br><span class="line">    <span class="keyword">if</span> (comp.mixins) &#123;</span><br><span class="line">      comp.mixins.forEach(extendProps)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">	</span><br><span class="line">  <span class="comment">// 如果props不存在 且 没有扩展 则复制为空数组</span></span><br><span class="line">  <span class="keyword">if</span> (!raw &amp;&amp; !hasExtends) &#123;</span><br><span class="line">    <span class="keyword">return</span> (comp.__props = EMPTY_ARR <span class="keyword">as</span> <span class="built_in">any</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isArray(raw)) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; raw.length; i++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (__DEV__ &amp;&amp; !isString(raw[i])) &#123;</span><br><span class="line">        warn(<span class="string">`props must be strings when using array syntax.`</span>, raw[i])</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> normalizedKey = camelize(raw[i])</span><br><span class="line">      <span class="keyword">if</span> (validatePropName(normalizedKey)) &#123;</span><br><span class="line">        normalized[normalizedKey] = EMPTY_OBJ</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (raw) &#123;</span><br><span class="line">    <span class="keyword">if</span> (__DEV__ &amp;&amp; !isObject(raw)) &#123;</span><br><span class="line">      warn(<span class="string">`invalid props options`</span>, raw)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> raw) &#123;</span><br><span class="line">      <span class="keyword">const</span> normalizedKey = camelize(key)</span><br><span class="line">      <span class="keyword">if</span> (validatePropName(normalizedKey)) &#123;</span><br><span class="line">        <span class="keyword">const</span> opt = raw[key]</span><br><span class="line">        <span class="keyword">const</span> prop: NormalizedProp = (normalized[normalizedKey] =</span><br><span class="line">          isArray(opt) || isFunction(opt) ? &#123; <span class="attr">type</span>: opt &#125; : opt)</span><br><span class="line">        <span class="keyword">if</span> (prop) &#123;</span><br><span class="line">          <span class="keyword">const</span> booleanIndex = getTypeIndex(<span class="built_in">Boolean</span>, prop.type)</span><br><span class="line">          <span class="keyword">const</span> stringIndex = getTypeIndex(<span class="built_in">String</span>, prop.type)</span><br><span class="line">          prop[BooleanFlags.shouldCast] = booleanIndex &gt; -<span class="number">1</span></span><br><span class="line">          prop[BooleanFlags.shouldCastTrue] =</span><br><span class="line">            stringIndex &lt; <span class="number">0</span> || booleanIndex &lt; stringIndex</span><br><span class="line">          <span class="comment">// if the prop needs boolean casting or default value</span></span><br><span class="line">          <span class="keyword">if</span> (booleanIndex &gt; -<span class="number">1</span> || hasOwn(prop, <span class="string">&#x27;default&#x27;</span>)) &#123;</span><br><span class="line">            needCastKeys.push(normalizedKey)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (comp.__props = [normalized, needCastKeys])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="normalizeEmitsOptions"><a href="#normalizeEmitsOptions" class="headerlink" title="normalizeEmitsOptions"></a>normalizeEmitsOptions</h5><p><code>packages/runtime-core/src/componentEmits.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">normalizeEmitsOptions</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  comp: ConcreteComponent,</span></span></span><br><span class="line"><span class="params"><span class="function">  appContext: AppContext,</span></span></span><br><span class="line"><span class="params"><span class="function">  asMixin = <span class="literal">false</span></span></span></span><br><span class="line"><span class="params"><span class="function"></span>): <span class="title">ObjectEmitsOptions</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!appContext.deopt &amp;&amp; comp.__emits !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> comp.__emits</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> raw = comp.emits <span class="comment">// 获取emits</span></span><br><span class="line">  <span class="keyword">let</span> normalized: ObjectEmitsOptions = &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// apply mixin/extends props</span></span><br><span class="line">  <span class="keyword">let</span> hasExtends = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">if</span> (__FEATURE_OPTIONS_API__ &amp;&amp; !isFunction(comp)) &#123;</span><br><span class="line">    <span class="keyword">const</span> extendEmits = <span class="function">(<span class="params">raw: ComponentOptions</span>) =&gt;</span> &#123;</span><br><span class="line">      hasExtends = <span class="literal">true</span></span><br><span class="line">      extend(normalized, normalizeEmitsOptions(raw, appContext, <span class="literal">true</span>))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!asMixin &amp;&amp; appContext.mixins.length) &#123;</span><br><span class="line">      appContext.mixins.forEach(extendEmits)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (comp.extends) &#123;</span><br><span class="line">      extendEmits(comp.extends)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (comp.mixins) &#123;</span><br><span class="line">      comp.mixins.forEach(extendEmits)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 赋值为null</span></span><br><span class="line">  <span class="keyword">if</span> (!raw &amp;&amp; !hasExtends) &#123;</span><br><span class="line">    <span class="keyword">return</span> (comp.__emits = <span class="literal">null</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isArray(raw)) &#123;</span><br><span class="line">    raw.forEach(<span class="function"><span class="params">key</span> =&gt;</span> (normalized[key] = <span class="literal">null</span>))</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    extend(normalized, raw)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (comp.__emits = normalized)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="createRenderContext"><a href="#createRenderContext" class="headerlink" title="createRenderContext"></a>createRenderContext</h5><p><code>packages/runtime-core/src/componentPublicInstance.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> publicPropertiesMap: PublicPropertiesMap = extend(<span class="built_in">Object</span>.create(<span class="literal">null</span>), &#123;</span><br><span class="line">  <span class="attr">$</span>: <span class="function"><span class="params">i</span> =&gt;</span> i,</span><br><span class="line">  <span class="attr">$el</span>: <span class="function"><span class="params">i</span> =&gt;</span> i.vnode.el,</span><br><span class="line">  <span class="attr">$data</span>: <span class="function"><span class="params">i</span> =&gt;</span> i.data,</span><br><span class="line">  <span class="attr">$props</span>: <span class="function"><span class="params">i</span> =&gt;</span> (__DEV__ ? shallowReadonly(i.props) : i.props),</span><br><span class="line">  <span class="attr">$attrs</span>: <span class="function"><span class="params">i</span> =&gt;</span> (__DEV__ ? shallowReadonly(i.attrs) : i.attrs),</span><br><span class="line">  <span class="attr">$slots</span>: <span class="function"><span class="params">i</span> =&gt;</span> (__DEV__ ? shallowReadonly(i.slots) : i.slots),</span><br><span class="line">  <span class="attr">$refs</span>: <span class="function"><span class="params">i</span> =&gt;</span> (__DEV__ ? shallowReadonly(i.refs) : i.refs),</span><br><span class="line">  <span class="attr">$parent</span>: <span class="function"><span class="params">i</span> =&gt;</span> getPublicInstance(i.parent),</span><br><span class="line">  <span class="attr">$root</span>: <span class="function"><span class="params">i</span> =&gt;</span> i.root &amp;&amp; i.root.proxy,</span><br><span class="line">  <span class="attr">$emit</span>: <span class="function"><span class="params">i</span> =&gt;</span> i.emit,</span><br><span class="line">  <span class="attr">$options</span>: <span class="function"><span class="params">i</span> =&gt;</span> (__FEATURE_OPTIONS_API__ ? resolveMergedOptions(i) : i.type),</span><br><span class="line">  <span class="attr">$forceUpdate</span>: <span class="function"><span class="params">i</span> =&gt;</span> <span class="function">() =&gt;</span> queueJob(i.update),</span><br><span class="line">  <span class="attr">$nextTick</span>: <span class="function"><span class="params">i</span> =&gt;</span> nextTick.bind(i.proxy!),</span><br><span class="line">  <span class="attr">$watch</span>: <span class="function"><span class="params">i</span> =&gt;</span> (__FEATURE_OPTIONS_API__ ? instanceWatch.bind(i) : NOOP)</span><br><span class="line">&#125; <span class="keyword">as</span> PublicPropertiesMap)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createRenderContext</span>(<span class="params">instance: ComponentInternalInstance</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> target: Record&lt;<span class="built_in">string</span>, <span class="built_in">any</span>&gt; = &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// expose internal instance for proxy handlers</span></span><br><span class="line">  <span class="comment">// target._ 获取 当前的instance</span></span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(target, <span class="string">`_`</span>, &#123;</span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">get</span>: <span class="function">() =&gt;</span> instance</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// expose public properties</span></span><br><span class="line">  <span class="comment">// 给tagert上挂载上 map中的键值对应的方法</span></span><br><span class="line">  <span class="built_in">Object</span>.keys(publicPropertiesMap).forEach(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">Object</span>.defineProperty(target, key, &#123;</span><br><span class="line">      <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">enumerable</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">get</span>: <span class="function">() =&gt;</span> publicPropertiesMap[key](instance),</span><br><span class="line">      <span class="comment">// intercepted by the proxy so no need for implementation,</span></span><br><span class="line">      <span class="comment">// but needed to prevent set errors</span></span><br><span class="line">      <span class="attr">set</span>: NOOP</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// expose global properties</span></span><br><span class="line">  <span class="comment">// 取出 globalProperties 挂载在target上</span></span><br><span class="line">  <span class="keyword">const</span> &#123; globalProperties &#125; = instance.appContext.config</span><br><span class="line">  <span class="built_in">Object</span>.keys(globalProperties).forEach(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">Object</span>.defineProperty(target, key, &#123;</span><br><span class="line">      <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">enumerable</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">get</span>: <span class="function">() =&gt;</span> globalProperties[key],</span><br><span class="line">      <span class="attr">set</span>: NOOP</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> target <span class="keyword">as</span> ComponentRenderContext</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="setupComponent"><a href="#setupComponent" class="headerlink" title="setupComponent"></a>setupComponent</h4><p><code>packages/runtime-core/src/component.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">setupComponent</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  instance: ComponentInternalInstance,</span></span></span><br><span class="line"><span class="params"><span class="function">  isSSR = <span class="literal">false</span></span></span></span><br><span class="line"><span class="params"><span class="function"></span>) </span>&#123;</span><br><span class="line">  isInSSRComponentSetup = isSSR <span class="comment">// 是否是SSR</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 取出props children shapeFlag</span></span><br><span class="line">  <span class="keyword">const</span> &#123; props, children, shapeFlag &#125; = instance.vnode</span><br><span class="line">  <span class="keyword">const</span> isStateful = shapeFlag &amp; ShapeFlags.STATEFUL_COMPONENT <span class="comment">// 这里是 4 &amp; 4 = 4</span></span><br><span class="line">  initProps(instance, props, isStateful, isSSR) <span class="comment">// 初始化props</span></span><br><span class="line">  initSlots(instance, children) <span class="comment">// 初始化slots</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 有状态的 所以执行 setupStatefulComponent</span></span><br><span class="line">  <span class="keyword">const</span> setupResult = isStateful</span><br><span class="line">    ? setupStatefulComponent(instance, isSSR)</span><br><span class="line">    : <span class="literal">undefined</span></span><br><span class="line">  isInSSRComponentSetup = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">return</span> setupResult </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="initProps"><a href="#initProps" class="headerlink" title="initProps"></a>initProps</h5><p><code>packages/runtime-core/src/componentProps.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">initProps</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  instance: ComponentInternalInstance,</span></span></span><br><span class="line"><span class="params"><span class="function">  rawProps: Data | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  isStateful: <span class="built_in">number</span>, <span class="comment">// result of bitwise flag comparison</span></span></span></span><br><span class="line"><span class="params"><span class="function">  isSSR = <span class="literal">false</span></span></span></span><br><span class="line"><span class="params"><span class="function"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> props: Data = &#123;&#125; <span class="comment">// 放props</span></span><br><span class="line">  <span class="keyword">const</span> attrs: Data = &#123;&#125; <span class="comment">// 放attrs</span></span><br><span class="line">  def(attrs, InternalObjectKey, <span class="number">1</span>) <span class="comment">// attrs: &#123; __vInternal: 1 &#125;</span></span><br><span class="line">  setFullProps(instance, rawProps, props, attrs)</span><br><span class="line">  <span class="comment">// validation</span></span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123; <span class="comment">// 开发环境下 验证props</span></span><br><span class="line">    validateProps(props, instance)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isStateful) &#123; <span class="comment">// 是否是有状态的</span></span><br><span class="line">    <span class="comment">// stateful</span></span><br><span class="line">    instance.props = isSSR ? props : shallowReactive(props) <span class="comment">// 会用shallowReactive方法 这里后面 分析响应式的再说吧</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!instance.type.props) &#123;</span><br><span class="line">      <span class="comment">// functional w/ optional props, props === attrs</span></span><br><span class="line">      instance.props = attrs</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// functional w/ declared props</span></span><br><span class="line">      instance.props = props</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  instance.attrs = attrs</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setFullProps</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  instance: ComponentInternalInstance,</span></span></span><br><span class="line"><span class="params"><span class="function">  rawProps: Data | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  props: Data,</span></span></span><br><span class="line"><span class="params"><span class="function">  attrs: Data</span></span></span><br><span class="line"><span class="params"><span class="function"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [options, needCastKeys] = instance.propsOptions <span class="comment">// 取出</span></span><br><span class="line">  <span class="keyword">if</span> (rawProps) &#123; <span class="comment">// 存在</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> rawProps) &#123;</span><br><span class="line">      <span class="keyword">const</span> value = rawProps[key]</span><br><span class="line">      <span class="comment">// key, ref are reserved and never passed down</span></span><br><span class="line">      <span class="comment">// key, ref, onVnodeBeforeMount, onVnodeMounted, onVnodeBeforeUpdate, onVnodeUpdated, onVnodeBeforeUnmount, onVnodeUnmounted 这样的key会跳过</span></span><br><span class="line">      <span class="keyword">if</span> (isReservedProp(key)) &#123;</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// prop option names are camelized during normalization, so to support</span></span><br><span class="line">      <span class="comment">// kebab -&gt; camel conversion here we need to camelize the key.</span></span><br><span class="line">      <span class="keyword">let</span> camelKey</span><br><span class="line">      <span class="comment">// 处理 props:[&quot;xxx&quot;]这样的</span></span><br><span class="line">      <span class="keyword">if</span> (options &amp;&amp; hasOwn(options, (camelKey = camelize(key)))) &#123;</span><br><span class="line">        props[camelKey] = value</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isEmitListener(instance.emitsOptions, key)) &#123; <span class="comment">// 处理emit的事件名</span></span><br><span class="line">        <span class="comment">// Any non-declared (either as a prop or an emitted event) props are put</span></span><br><span class="line">        <span class="comment">// into a separate `attrs` object for spreading. Make sure to preserve</span></span><br><span class="line">        <span class="comment">// original key casing</span></span><br><span class="line">        attrs[key] = value</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (needCastKeys) &#123;</span><br><span class="line">    <span class="keyword">const</span> rawCurrentProps = toRaw(props)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; needCastKeys.length; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> key = needCastKeys[i]</span><br><span class="line">      props[key] = resolvePropValue(</span><br><span class="line">        options!,</span><br><span class="line">        rawCurrentProps,</span><br><span class="line">        key,</span><br><span class="line">        rawCurrentProps[key],</span><br><span class="line">        instance</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="initSlots"><a href="#initSlots" class="headerlink" title="initSlots"></a>initSlots</h5><p><code>packages/runtime-core/src/componentSlots.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> initSlots = <span class="function">(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  instance: ComponentInternalInstance,</span></span></span><br><span class="line"><span class="params"><span class="function">  children: VNodeNormalizedChildren</span></span></span><br><span class="line"><span class="params"><span class="function"></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 满足则继续 ShapeFlags.SLOTS_CHILDREN为32</span></span><br><span class="line">  <span class="keyword">if</span> (instance.vnode.shapeFlag &amp; ShapeFlags.SLOTS_CHILDREN) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">type</span> = (children <span class="keyword">as</span> RawSlots)._</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">type</span>) &#123;</span><br><span class="line">      instance.slots = children <span class="keyword">as</span> InternalSlots</span><br><span class="line">      <span class="comment">// make compiler marker non-enumerable</span></span><br><span class="line">      def(children <span class="keyword">as</span> InternalSlots, <span class="string">&#x27;_&#x27;</span>, <span class="keyword">type</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      normalizeObjectSlots(children <span class="keyword">as</span> RawSlots, (instance.slots = &#123;&#125;))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    instance.slots = &#123;&#125; <span class="comment">// 赋值为空</span></span><br><span class="line">    <span class="keyword">if</span> (children) &#123;</span><br><span class="line">      normalizeVNodeSlots(instance, children)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  def(instance.slots, InternalObjectKey, <span class="number">1</span>); <span class="comment">// &#123; __vInternal: 1 &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="setupStatefulComponent"><a href="#setupStatefulComponent" class="headerlink" title="setupStatefulComponent"></a>setupStatefulComponent</h5><p><code>packages/runtime-core/src/components.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setupStatefulComponent</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  instance: ComponentInternalInstance,</span></span></span><br><span class="line"><span class="params"><span class="function">  isSSR: <span class="built_in">boolean</span></span></span></span><br><span class="line"><span class="params"><span class="function"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> Component = instance.type <span class="keyword">as</span> ComponentOptions <span class="comment">// 获取type</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    <span class="comment">// 开发环境下 如果我们传入的&#123; name:xxx, setup()&#123;&#125; &#125; 这个对象有name属性 , 这个name的值不能是内置的component/slot 或者是html标签或者svg</span></span><br><span class="line">    <span class="keyword">if</span> (Component.name) &#123;</span><br><span class="line">      validateComponentName(Component.name, instance.appContext.config)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (Component.components) &#123;</span><br><span class="line">      <span class="keyword">const</span> names = <span class="built_in">Object</span>.keys(Component.components)</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; names.length; i++) &#123;</span><br><span class="line">        validateComponentName(names[i], instance.appContext.config)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果有directives 验证每个directive是否是内置的指令</span></span><br><span class="line">    <span class="keyword">if</span> (Component.directives) &#123;</span><br><span class="line">      <span class="keyword">const</span> names = <span class="built_in">Object</span>.keys(Component.directives)</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; names.length; i++) &#123;</span><br><span class="line">        validateDirectiveName(names[i])</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 0. create render proxy property access cache</span></span><br><span class="line">  <span class="comment">// 创建渲染代理属性访问缓存</span></span><br><span class="line">  instance.accessCache = <span class="built_in">Object</span>.create(<span class="literal">null</span>)</span><br><span class="line">  <span class="comment">// 1. create public instance / render proxy</span></span><br><span class="line">  <span class="comment">// also mark it raw so it&#x27;s never observed </span></span><br><span class="line">  <span class="comment">// 创建公共实例/渲染代理</span></span><br><span class="line">  <span class="comment">// PublicInstanceProxyHandlers 里面有三个方法 get / set / has</span></span><br><span class="line">  instance.proxy = <span class="keyword">new</span> <span class="built_in">Proxy</span>(instance.ctx, PublicInstanceProxyHandlers)</span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123; <span class="comment">// 开发环境下调用的</span></span><br><span class="line">    exposePropsOnRenderContext(instance)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 2. call setup()</span></span><br><span class="line">  <span class="keyword">const</span> &#123; setup &#125; = Component <span class="comment">// 取出setup方法</span></span><br><span class="line">  <span class="keyword">if</span> (setup) &#123;</span><br><span class="line">    <span class="comment">// 这里就是我们 传入的setup(props, ctx) &#123;  &#125; 这样访问的时候 才需要访问ctx上下文 这时的length肯定会大于1 才会去执行createSetupContext创建ctx,  否则赋值为null</span></span><br><span class="line">    <span class="keyword">const</span> setupContext = (instance.setupContext =</span><br><span class="line">      setup.length &gt; <span class="number">1</span> ? createSetupContext(instance) : <span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line">    currentInstance = instance <span class="comment">// 赋值当前实例</span></span><br><span class="line">    pauseTracking() <span class="comment">// 暂停追踪</span></span><br><span class="line">    <span class="keyword">const</span> setupResult = callWithErrorHandling(</span><br><span class="line">      setup,</span><br><span class="line">      instance,</span><br><span class="line">      ErrorCodes.SETUP_FUNCTION, <span class="comment">// 0</span></span><br><span class="line">      [__DEV__ ? shallowReadonly(instance.props) : instance.props, setupContext] <span class="comment">// 开发环境下会将实例上的props shallowReadonly一下 具体过程我后面分析reactive时再来</span></span><br><span class="line">    )</span><br><span class="line">    resetTracking() <span class="comment">// 重置跟踪</span></span><br><span class="line">    currentInstance = <span class="literal">null</span> <span class="comment">// 重置当前实例为null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isPromise(setupResult)) &#123; <span class="comment">// 判断这个结果是不是一个promise</span></span><br><span class="line">      <span class="keyword">if</span> (isSSR) &#123; <span class="comment">// 是不是SSR下</span></span><br><span class="line">        <span class="comment">// return the promise so server-renderer can wait on it</span></span><br><span class="line">        <span class="keyword">return</span> setupResult.then(<span class="function">(<span class="params">resolvedResult: unknown</span>) =&gt;</span> &#123;</span><br><span class="line">          handleSetupResult(instance, resolvedResult, isSSR)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__FEATURE_SUSPENSE__) &#123;</span><br><span class="line">        <span class="comment">// async setup returned Promise.</span></span><br><span class="line">        <span class="comment">// bail here and wait for re-entry.</span></span><br><span class="line">        instance.asyncDep = setupResult</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        warn(</span><br><span class="line">          <span class="string">`setup() returned a Promise, but the version of Vue you are using `</span> +</span><br><span class="line">            <span class="string">`does not support it yet.`</span></span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     	<span class="comment">// 执行 handleSetupResult</span></span><br><span class="line">      handleSetupResult(instance, setupResult, isSSR)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    finishComponentSetup(instance, isSSR)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="exposePropsOnRenderContext"><a href="#exposePropsOnRenderContext" class="headerlink" title="exposePropsOnRenderContext"></a>exposePropsOnRenderContext</h6><p><code>packages/runtime-core/src/component.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">exposePropsOnRenderContext</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  instance: ComponentInternalInstance</span></span></span><br><span class="line"><span class="params"><span class="function"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;</span><br><span class="line">    ctx,</span><br><span class="line">    <span class="attr">propsOptions</span>: [propsOptions]</span><br><span class="line">  &#125; = instance</span><br><span class="line">  <span class="keyword">if</span> (propsOptions) &#123; <span class="comment">// 存在就挂载在上下文上</span></span><br><span class="line">    <span class="built_in">Object</span>.keys(propsOptions).forEach(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">Object</span>.defineProperty(ctx, key, &#123;</span><br><span class="line">        <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">get</span>: <span class="function">() =&gt;</span> instance.props[key],</span><br><span class="line">        <span class="attr">set</span>: NOOP</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="callWithErrorHandling"><a href="#callWithErrorHandling" class="headerlink" title="callWithErrorHandling"></a>callWithErrorHandling</h6><p><code>packages/runtime-core/src/errorHanding.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">callWithErrorHandling</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  fn: <span class="built_in">Function</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  instance: ComponentInternalInstance | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">type</span>: ErrorTypes,</span></span></span><br><span class="line"><span class="params"><span class="function">  args?: unknown[]</span></span></span><br><span class="line"><span class="params"><span class="function"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> res <span class="comment">// 初始化一个结果</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    res = args ? fn(...args) : fn() <span class="comment">// 执行 setup函数</span></span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    handleError(err, instance, <span class="keyword">type</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res <span class="comment">// 返回setup函数结果 这里返回结果就是setup return出来的</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="handleSetupResult"><a href="#handleSetupResult" class="headerlink" title="handleSetupResult"></a>handleSetupResult</h6><p><code>packages/runtime-core/src/component.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">handleSetupResult</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  instance: ComponentInternalInstance,</span></span></span><br><span class="line"><span class="params"><span class="function">  setupResult: unknown,</span></span></span><br><span class="line"><span class="params"><span class="function">  isSSR: <span class="built_in">boolean</span></span></span></span><br><span class="line"><span class="params"><span class="function"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (isFunction(setupResult)) &#123; <span class="comment">// setup返回的是一个render 函数</span></span><br><span class="line">    <span class="keyword">if</span> (__NODE_JS__ &amp;&amp; (instance.type <span class="keyword">as</span> ComponentOptions).__ssrInlineRender) &#123; <span class="comment">// 满足nodejs环境 并有__ssrInlineRender属性 为 true</span></span><br><span class="line">      instance.ssrRender = setupResult <span class="comment">// 赋值给ssrRender</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      instance.render = setupResult <span class="keyword">as</span> InternalRenderFunction <span class="comment">// 否则赋值给render</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isObject(setupResult)) &#123; <span class="comment">// 是对象</span></span><br><span class="line">    <span class="keyword">if</span> (__DEV__ &amp;&amp; isVNode(setupResult)) &#123; <span class="comment">// 开发环境下返回的是一个VNode 叫你返回render</span></span><br><span class="line">      warn(</span><br><span class="line">        <span class="string">`setup() should not return VNodes directly - `</span> +</span><br><span class="line">          <span class="string">`return a render function instead.`</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// setup returned bindings.</span></span><br><span class="line">    <span class="comment">// assuming a render function compiled from template is present.</span></span><br><span class="line">    <span class="keyword">if</span> (__DEV__ || __FEATURE_PROD_DEVTOOLS__) &#123; <span class="comment">// 开发环境下 赋值给 devtoolsRawSetupState</span></span><br><span class="line">      instance.devtoolsRawSetupState = setupResult</span><br><span class="line">    &#125;</span><br><span class="line">    instance.setupState = proxyRefs(setupResult) <span class="comment">// proxyRefs 也留到后面将的时候再来吧 返回的是一个proxy对象</span></span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123; <span class="comment">// 开发环境下</span></span><br><span class="line">      exposeSetupStateOnRenderContext(instance)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__ &amp;&amp; setupResult !== <span class="literal">undefined</span>) &#123; <span class="comment">// 不是对象不是方法 警告</span></span><br><span class="line">    warn(</span><br><span class="line">      <span class="string">`setup() should return an object. Received: <span class="subst">$&#123;</span></span></span><br><span class="line"><span class="subst"><span class="string">        setupResult === <span class="literal">null</span> ? <span class="string">&#x27;null&#x27;</span> : <span class="keyword">typeof</span> setupResult</span></span></span><br><span class="line"><span class="subst"><span class="string">      &#125;</span>`</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  finishComponentSetup(instance, isSSR)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>exposeSetupStateOnRenderContext</strong></p>
<p><code>packages/runtime-core/src/componentPublicInstance.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">exposeSetupStateOnRenderContext</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  instance: ComponentInternalInstance</span></span></span><br><span class="line"><span class="params"><span class="function"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; ctx, setupState &#125; = instance</span><br><span class="line">  <span class="built_in">Object</span>.keys(toRaw(setupState)).forEach(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (key[<span class="number">0</span>] === <span class="string">&#x27;$&#x27;</span> || key[<span class="number">0</span>] === <span class="string">&#x27;_&#x27;</span>) &#123; <span class="comment">// 如果定义了 _ 或者 $ 开头的属性名 警告</span></span><br><span class="line">      warn(</span><br><span class="line">        <span class="string">`setup() return property <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(</span></span></span><br><span class="line"><span class="subst"><span class="string">          key</span></span></span><br><span class="line"><span class="subst"><span class="string">        )&#125;</span> should not start with &quot;$&quot; or &quot;_&quot; `</span> +</span><br><span class="line">          <span class="string">`which are reserved prefixes for Vue internals.`</span></span><br><span class="line">      )</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将属性挂载在 上下文ctx上面</span></span><br><span class="line">    <span class="built_in">Object</span>.defineProperty(ctx, key, &#123;</span><br><span class="line">      <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">get</span>: <span class="function">() =&gt;</span> setupState[key],</span><br><span class="line">      <span class="attr">set</span>: NOOP</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>finishComponentSetup</strong></p>
<p><code>packages/runtime-core/src/component.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">finishComponentSetup</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  instance: ComponentInternalInstance,</span></span></span><br><span class="line"><span class="params"><span class="function">  isSSR: <span class="built_in">boolean</span></span></span></span><br><span class="line"><span class="params"><span class="function"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> Component = instance.type <span class="keyword">as</span> ComponentOptions</span><br><span class="line"></span><br><span class="line">  <span class="comment">// template / render function normalization </span></span><br><span class="line">  <span class="comment">// node环境 且 是SSR</span></span><br><span class="line">  <span class="keyword">if</span> (__NODE_JS__ &amp;&amp; isSSR) &#123;</span><br><span class="line">    <span class="keyword">if</span> (Component.render) &#123;</span><br><span class="line">      instance.render = Component.render <span class="keyword">as</span> InternalRenderFunction</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!instance.render) &#123; <span class="comment">// 如果setup没有返回一个函数 instance.render就是null</span></span><br><span class="line">    <span class="comment">// could be set from setup()</span></span><br><span class="line">    <span class="keyword">if</span> (compile &amp;&amp; Component.template &amp;&amp; !Component.render) &#123; <span class="comment">// complie方法存在 且template属性存在 且没有render方法</span></span><br><span class="line">      <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        startMeasure(instance, <span class="string">`compile`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 通过template 生成render方法 compile 过程后面来分析</span></span><br><span class="line">      Component.render = compile(Component.template, &#123;</span><br><span class="line">        <span class="attr">isCustomElement</span>: instance.appContext.config.isCustomElement,</span><br><span class="line">        <span class="attr">delimiters</span>: Component.delimiters</span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        endMeasure(instance, <span class="string">`compile`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将生成的render方法 赋值给实例上的render</span></span><br><span class="line">    instance.render = (Component.render || NOOP) <span class="keyword">as</span> InternalRenderFunction</span><br><span class="line"></span><br><span class="line">    <span class="comment">// _rc 代表着这个render 是在runtime compile时生成的</span></span><br><span class="line">    <span class="keyword">if</span> (instance.render._rc) &#123;</span><br><span class="line">      instance.withProxy = <span class="keyword">new</span> <span class="built_in">Proxy</span>(</span><br><span class="line">        instance.ctx,</span><br><span class="line">        RuntimeCompiledPublicInstanceProxyHandlers</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 处理optionApi的逻辑 重点是applyOptions方法</span></span><br><span class="line">  <span class="keyword">if</span> (__FEATURE_OPTIONS_API__) &#123;</span><br><span class="line">    currentInstance = instance <span class="comment">// 当前实例置为instance</span></span><br><span class="line">    pauseTracking() <span class="comment">// 暂停追踪</span></span><br><span class="line">    applyOptions(instance, Component) </span><br><span class="line">    resetTracking() <span class="comment">// 重新追踪</span></span><br><span class="line">    currentInstance = <span class="literal">null</span> <span class="comment">// 重置当前实例</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// warn missing template/render</span></span><br><span class="line">  <span class="keyword">if</span> (__DEV__ &amp;&amp; !Component.render &amp;&amp; instance.render === NOOP) &#123;</span><br><span class="line">    <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">    <span class="keyword">if</span> (!compile &amp;&amp; Component.template) &#123;</span><br><span class="line">      warn(</span><br><span class="line">        <span class="string">`Component provided template option but `</span> +</span><br><span class="line">          <span class="string">`runtime compilation is not supported in this build of Vue.`</span> +</span><br><span class="line">          (__ESM_BUNDLER__</span><br><span class="line">            ? <span class="string">` Configure your bundler to alias &quot;vue&quot; to &quot;vue/dist/vue.esm-bundler.js&quot;.`</span></span><br><span class="line">            : __ESM_BROWSER__</span><br><span class="line">              ? <span class="string">` Use &quot;vue.esm-browser.js&quot; instead.`</span></span><br><span class="line">              : __GLOBAL__</span><br><span class="line">                ? <span class="string">` Use &quot;vue.global.js&quot; instead.`</span></span><br><span class="line">                : <span class="string">``</span>) <span class="comment">/* should not happen */</span></span><br><span class="line">      )</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      warn(<span class="string">`Component is missing template or render function.`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>applyOptions</strong></p>
<p><code>packages/runtime-core/src/componentOptions.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">applyOptions</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  instance: ComponentInternalInstance,</span></span></span><br><span class="line"><span class="params"><span class="function">  options: ComponentOptions, <span class="comment">// 传入的&#123; data()&#123;&#125;, methods, ...&#125;</span></span></span></span><br><span class="line"><span class="params"><span class="function">  deferredData: DataFn[] = [],</span></span></span><br><span class="line"><span class="params"><span class="function">  deferredWatch: ComponentWatchOptions[] = [],</span></span></span><br><span class="line"><span class="params"><span class="function">  deferredProvide: (Data | <span class="built_in">Function</span>)[] = [],</span></span></span><br><span class="line"><span class="params"><span class="function">  asMixin: <span class="built_in">boolean</span> = <span class="literal">false</span> <span class="comment">// 是否是mixin</span></span></span></span><br><span class="line"><span class="params"><span class="function"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;</span><br><span class="line">    <span class="comment">// composition</span></span><br><span class="line">    mixins, </span><br><span class="line">    <span class="attr">extends</span>: extendsOptions,</span><br><span class="line">    <span class="comment">// state</span></span><br><span class="line">    <span class="attr">data</span>: dataOptions,</span><br><span class="line">    <span class="attr">computed</span>: computedOptions,</span><br><span class="line">    methods,</span><br><span class="line">    <span class="attr">watch</span>: watchOptions,</span><br><span class="line">    <span class="attr">provide</span>: provideOptions,</span><br><span class="line">    <span class="attr">inject</span>: injectOptions,</span><br><span class="line">    <span class="comment">// assets</span></span><br><span class="line">    components,</span><br><span class="line">    directives,</span><br><span class="line">    <span class="comment">// lifecycle</span></span><br><span class="line">    beforeMount,</span><br><span class="line">    mounted,</span><br><span class="line">    beforeUpdate,</span><br><span class="line">    updated,</span><br><span class="line">    activated,</span><br><span class="line">    deactivated,</span><br><span class="line">    beforeDestroy,</span><br><span class="line">    beforeUnmount,</span><br><span class="line">    destroyed,</span><br><span class="line">    unmounted,</span><br><span class="line">    render,</span><br><span class="line">    renderTracked,</span><br><span class="line">    renderTriggered,</span><br><span class="line">    errorCaptured,</span><br><span class="line">    <span class="comment">// public API</span></span><br><span class="line">    expose</span><br><span class="line">  &#125; = options <span class="comment">// 取出那么多东西...</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> publicThis = instance.proxy! <span class="comment">// 取出代理的实例</span></span><br><span class="line">  <span class="keyword">const</span> ctx = instance.ctx <span class="comment">// 取出上下文对象</span></span><br><span class="line">  <span class="keyword">const</span> globalMixins = instance.appContext.mixins <span class="comment">// 取出全局的mixins</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 是mixin 且 option中 render 存在 且实例上的render 是NOOP, 将options中的render作为 实例的render</span></span><br><span class="line">  <span class="keyword">if</span> (asMixin &amp;&amp; render &amp;&amp; instance.render === NOOP) &#123;</span><br><span class="line">    instance.render = render <span class="keyword">as</span> InternalRenderFunction</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// applyOptions is called non-as-mixin once per instance</span></span><br><span class="line">  <span class="keyword">if</span> (!asMixin) &#123; <span class="comment">// 不是mixin</span></span><br><span class="line">    isInBeforeCreate = <span class="literal">true</span> <span class="comment">// 是在处于beforeCreate的状态</span></span><br><span class="line">    <span class="comment">// 调用beforeCreate 生命钩子函数</span></span><br><span class="line">    callSyncHook(</span><br><span class="line">      <span class="string">&#x27;beforeCreate&#x27;</span>,</span><br><span class="line">      LifecycleHooks.BEFORE_CREATE,</span><br><span class="line">      options,</span><br><span class="line">      instance,</span><br><span class="line">      globalMixins</span><br><span class="line">    ) <span class="comment">// 先调用全局的mixin里面的bc 然后调用组件里面的extends/mixins里面的bc, 最后调用自己写的bc</span></span><br><span class="line">    isInBeforeCreate = <span class="literal">false</span> <span class="comment">// beforeCreate过程结束</span></span><br><span class="line">    <span class="comment">// global mixins are applied first</span></span><br><span class="line">    applyMixins(</span><br><span class="line">      instance,</span><br><span class="line">      globalMixins,</span><br><span class="line">      deferredData,</span><br><span class="line">      deferredWatch,</span><br><span class="line">      deferredProvide</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">	</span><br><span class="line">  <span class="comment">// extending a base component...</span></span><br><span class="line">  <span class="comment">// 组件本身上如果有extends 执行 applyOptions asMixin参数为true</span></span><br><span class="line">  <span class="keyword">if</span> (extendsOptions) &#123;</span><br><span class="line">    applyOptions(</span><br><span class="line">      instance,</span><br><span class="line">      extendsOptions,</span><br><span class="line">      deferredData,</span><br><span class="line">      deferredWatch,</span><br><span class="line">      deferredProvide,</span><br><span class="line">      <span class="literal">true</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 组件自己的 mixins</span></span><br><span class="line">  <span class="keyword">if</span> (mixins) &#123;</span><br><span class="line">    applyMixins(instance, mixins, deferredData, deferredWatch, deferredProvide)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> checkDuplicateProperties = __DEV__ ? createDuplicateChecker() : <span class="literal">null</span> <span class="comment">// 开发环境下生成 重复key的检查函数</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123; <span class="comment">// 开发环境下</span></span><br><span class="line">    <span class="keyword">const</span> [propsOptions] = instance.propsOptions <span class="comment">// 取出属性</span></span><br><span class="line">    <span class="keyword">if</span> (propsOptions) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> propsOptions) &#123;</span><br><span class="line">        checkDuplicateProperties!(OptionTypes.PROPS, key) <span class="comment">// 检验属性里面的key是否已经被定义了</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 尤大大给的3 兼容 2 这些属性的初始化顺序</span></span><br><span class="line">  <span class="comment">// options initialization order (to be consistent with Vue 2):</span></span><br><span class="line">  <span class="comment">// - props (already done outside of this function)</span></span><br><span class="line">  <span class="comment">// - inject</span></span><br><span class="line">  <span class="comment">// - methods</span></span><br><span class="line">  <span class="comment">// - data (deferred since it relies on `this` access)</span></span><br><span class="line">  <span class="comment">// - computed</span></span><br><span class="line">  <span class="comment">// - watch (deferred since it relies on `this` access)</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 存在inject</span></span><br><span class="line">  <span class="keyword">if</span> (injectOptions) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isArray(injectOptions)) &#123; <span class="comment">// 是数组</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; injectOptions.length; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> key = injectOptions[i]</span><br><span class="line">        ctx[key] = inject(key) <span class="comment">// 通过inject 挂载在上下文</span></span><br><span class="line">        <span class="keyword">if</span> (__DEV__) &#123; <span class="comment">// 开发环境下 </span></span><br><span class="line">          checkDuplicateProperties!(OptionTypes.INJECT, key) <span class="comment">// 检验key是否定义了</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> injectOptions) &#123; <span class="comment">// 取出key</span></span><br><span class="line">        <span class="keyword">const</span> opt = injectOptions[key]</span><br><span class="line">        <span class="keyword">if</span> (isObject(opt)) &#123; <span class="comment">// 判断是不是对象</span></span><br><span class="line">          ctx[key] = inject(</span><br><span class="line">            opt.from || key,</span><br><span class="line">            opt.default,</span><br><span class="line">            <span class="literal">true</span> <span class="comment">/* treat default function as factory */</span></span><br><span class="line">          ) <span class="comment">// 通过inject 挂载在上下文</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          ctx[key] = inject(opt) <span class="comment">// 通过inject 挂载在上下文</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          checkDuplicateProperties!(OptionTypes.INJECT, key) <span class="comment">// 检验key是否定义了</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果有methods</span></span><br><span class="line">  <span class="keyword">if</span> (methods) &#123; </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> methods) &#123;</span><br><span class="line">      <span class="keyword">const</span> methodHandler = (methods <span class="keyword">as</span> MethodOptions)[key] <span class="comment">// 获取</span></span><br><span class="line">      <span class="keyword">if</span> (isFunction(methodHandler)) &#123; <span class="comment">// 是不是函数</span></span><br><span class="line">        ctx[key] = methodHandler.bind(publicThis) <span class="comment">// 修改this</span></span><br><span class="line">        <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          checkDuplicateProperties!(OptionTypes.METHODS, key) <span class="comment">// 检验key是否定义了</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        warn(</span><br><span class="line">          <span class="string">`Method &quot;<span class="subst">$&#123;key&#125;</span>&quot; has type &quot;<span class="subst">$&#123;<span class="keyword">typeof</span> methodHandler&#125;</span>&quot; in the component definition. `</span> +</span><br><span class="line">            <span class="string">`Did you reference the function correctly?`</span></span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!asMixin) &#123;</span><br><span class="line">    <span class="keyword">if</span> (deferredData.length) &#123; <span class="comment">// deferredData 里面放的是 dataFn(data() &#123; return &#123;xxx: &quot;xxx&quot;&#125; &#125;)这样的</span></span><br><span class="line">      deferredData.forEach(<span class="function"><span class="params">dataFn</span> =&gt;</span> resolveData(instance, dataFn, publicThis))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (dataOptions) &#123;</span><br><span class="line">      <span class="comment">// @ts-ignore dataOptions is not fully type safe</span></span><br><span class="line">      resolveData(instance, dataOptions, publicThis) <span class="comment">// 这是用户自己写的data() &#123; return &#123; xxx: &quot;xxx&quot; &#125; &#125;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      <span class="keyword">const</span> rawData = toRaw(instance.data) <span class="comment">// 取出实例上的data</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> rawData) &#123;</span><br><span class="line">        checkDuplicateProperties!(OptionTypes.DATA, key) <span class="comment">// 验证是否定义了</span></span><br><span class="line">        <span class="comment">// expose data on ctx during dev</span></span><br><span class="line">        <span class="keyword">if</span> (key[<span class="number">0</span>] !== <span class="string">&#x27;$&#x27;</span> &amp;&amp; key[<span class="number">0</span>] !== <span class="string">&#x27;_&#x27;</span>) &#123; <span class="comment">// 不能是以 $ 或者 _ 打头的key</span></span><br><span class="line">          <span class="built_in">Object</span>.defineProperty(ctx, key, &#123;</span><br><span class="line">            <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">get</span>: <span class="function">() =&gt;</span> rawData[key],</span><br><span class="line">            <span class="attr">set</span>: NOOP</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dataOptions) &#123; <span class="comment">// push 进 deferredData</span></span><br><span class="line">    deferredData.push(dataOptions <span class="keyword">as</span> DataFn)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 存在computed</span></span><br><span class="line">  <span class="keyword">if</span> (computedOptions) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> computedOptions) &#123;</span><br><span class="line">      <span class="keyword">const</span> opt = (computedOptions <span class="keyword">as</span> ComputedOptions)[key] <span class="comment">// 拿到计算属性</span></span><br><span class="line">      <span class="comment">// 获取get</span></span><br><span class="line">      <span class="keyword">const</span> get = isFunction(opt) </span><br><span class="line">        ? opt.bind(publicThis, publicThis) <span class="comment">// 是函数 绑定 publicThis, 传入publicThis</span></span><br><span class="line">        : isFunction(opt.get) <span class="comment">// 如果get属性是函数</span></span><br><span class="line">          ? opt.get.bind(publicThis, publicThis) <span class="comment">// 绑定 publicThis, 传入publicThis</span></span><br><span class="line">          : NOOP <span class="comment">// 返回一个空函数 () =&gt; &#123;&#125;</span></span><br><span class="line">      <span class="keyword">if</span> (__DEV__ &amp;&amp; get === NOOP) &#123; <span class="comment">// 没有getter</span></span><br><span class="line">        warn(<span class="string">`Computed property &quot;<span class="subst">$&#123;key&#125;</span>&quot; has no getter.`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 获取set</span></span><br><span class="line">      <span class="keyword">const</span> set =</span><br><span class="line">        !isFunction(opt) &amp;&amp; isFunction(opt.set)</span><br><span class="line">          ? opt.set.bind(publicThis) <span class="comment">// 不是函数 set且是方法</span></span><br><span class="line">          : __DEV__ <span class="comment">// 开发环境下设置默认的 函数</span></span><br><span class="line">            ? <span class="function">() =&gt;</span> &#123;</span><br><span class="line">                warn(</span><br><span class="line">                  <span class="string">`Write operation failed: computed property &quot;<span class="subst">$&#123;key&#125;</span>&quot; is readonly.`</span></span><br><span class="line">                )</span><br><span class="line">              &#125;</span><br><span class="line">            : NOOP</span><br><span class="line">      <span class="comment">// emmm 后面分析 vue3 computed的实现</span></span><br><span class="line">      <span class="keyword">const</span> c = computed(&#123;</span><br><span class="line">        get,</span><br><span class="line">        set</span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="comment">// 挂载在ctx上</span></span><br><span class="line">      <span class="built_in">Object</span>.defineProperty(ctx, key, &#123;</span><br><span class="line">        <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">get</span>: <span class="function">() =&gt;</span> c.value,</span><br><span class="line">        <span class="attr">set</span>: <span class="function"><span class="params">v</span> =&gt;</span> (c.value = v)</span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        checkDuplicateProperties!(OptionTypes.COMPUTED, key) <span class="comment">// 验证是否定义了</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// watch</span></span><br><span class="line">  <span class="keyword">if</span> (watchOptions) &#123; </span><br><span class="line">    deferredWatch.push(watchOptions)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!asMixin &amp;&amp; deferredWatch.length) &#123;</span><br><span class="line">    deferredWatch.forEach(<span class="function"><span class="params">watchOptions</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> watchOptions) &#123;</span><br><span class="line">        <span class="comment">// 创建watch emmm 后面分析</span></span><br><span class="line">        createWatcher(watchOptions[key], ctx, publicThis, key)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// provide</span></span><br><span class="line">  <span class="keyword">if</span> (provideOptions) &#123;</span><br><span class="line">    deferredProvide.push(provideOptions)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!asMixin &amp;&amp; deferredProvide.length) &#123;</span><br><span class="line">    deferredProvide.forEach(<span class="function"><span class="params">provideOptions</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> provides = isFunction(provideOptions)</span><br><span class="line">        ? provideOptions.call(publicThis) <span class="comment">// 是方法 就执行改变this后的结果</span></span><br><span class="line">        : provideOptions</span><br><span class="line">      <span class="built_in">Reflect</span>.ownKeys(provides).forEach(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">        provide(key, provides[key]) <span class="comment">// 循环provide</span></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// asset options.</span></span><br><span class="line">  <span class="comment">// To reduce memory usage, only components with mixins or extends will have</span></span><br><span class="line">  <span class="comment">// resolved asset registry attached to instance.</span></span><br><span class="line">  <span class="comment">// 解析 mixin中的component, directive</span></span><br><span class="line">  <span class="keyword">if</span> (asMixin) &#123;</span><br><span class="line">    <span class="keyword">if</span> (components) &#123; <span class="comment">// 整合到实例的components里面</span></span><br><span class="line">      extend(</span><br><span class="line">        instance.components ||</span><br><span class="line">          (instance.components = extend(</span><br><span class="line">            &#123;&#125;,</span><br><span class="line">            (instance.type <span class="keyword">as</span> ComponentOptions).components</span><br><span class="line">          ) <span class="keyword">as</span> Record&lt;<span class="built_in">string</span>, ConcreteComponent&gt;),</span><br><span class="line">        components</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (directives) &#123; <span class="comment">// 整合到实例的directives里面</span></span><br><span class="line">      extend(</span><br><span class="line">        instance.directives ||</span><br><span class="line">          (instance.directives = extend(</span><br><span class="line">            &#123;&#125;,</span><br><span class="line">            (instance.type <span class="keyword">as</span> ComponentOptions).directives</span><br><span class="line">          )),</span><br><span class="line">        directives</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// lifecycle options</span></span><br><span class="line">  <span class="keyword">if</span> (!asMixin) &#123; <span class="comment">// 执行created钩子 顺序和 bc那里一样的</span></span><br><span class="line">    callSyncHook(</span><br><span class="line">      <span class="string">&#x27;created&#x27;</span>,</span><br><span class="line">      LifecycleHooks.CREATED,</span><br><span class="line">      options,</span><br><span class="line">      instance,</span><br><span class="line">      globalMixins</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 存在 beforeMount 钩子</span></span><br><span class="line">  <span class="keyword">if</span> (beforeMount) &#123; <span class="comment">// 当做回调函数 放入 onBeforeMount 钩子</span></span><br><span class="line">    onBeforeMount(beforeMount.bind(publicThis))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 存在 mounted 钩子</span></span><br><span class="line">  <span class="keyword">if</span> (mounted) &#123; <span class="comment">// 当做回调函数 放入 onMounted 钩子</span></span><br><span class="line">    onMounted(mounted.bind(publicThis))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 存在 beforeUpdate 钩子</span></span><br><span class="line">  <span class="keyword">if</span> (beforeUpdate) &#123; <span class="comment">// 当做回调函数 放入 onBeforeUpdate 钩子</span></span><br><span class="line">    onBeforeUpdate(beforeUpdate.bind(publicThis))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 存在 updated 钩子</span></span><br><span class="line">  <span class="keyword">if</span> (updated) &#123; <span class="comment">// 当做回调函数 放入 onUpdated 钩子</span></span><br><span class="line">    onUpdated(updated.bind(publicThis))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 存在 activated 钩子</span></span><br><span class="line">  <span class="keyword">if</span> (activated) &#123; <span class="comment">// 当做回调函数 放入 onActivated 钩子</span></span><br><span class="line">    onActivated(activated.bind(publicThis))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 存在 deactivated 钩子</span></span><br><span class="line">  <span class="keyword">if</span> (deactivated) &#123; <span class="comment">// 当做回调函数 放入 onDeactivated 钩子</span></span><br><span class="line">    onDeactivated(deactivated.bind(publicThis))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 存在 errorCaptured 钩子</span></span><br><span class="line">  <span class="keyword">if</span> (errorCaptured) &#123; <span class="comment">// 当做回调函数 放入 onErrorCaptured 钩子</span></span><br><span class="line">    onErrorCaptured(errorCaptured.bind(publicThis))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 存在 renderTracked 钩子</span></span><br><span class="line">  <span class="keyword">if</span> (renderTracked) &#123; <span class="comment">// 当做回调函数 放入 onRenderTracked 钩子</span></span><br><span class="line">    onRenderTracked(renderTracked.bind(publicThis))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 存在 renderTriggered 钩子</span></span><br><span class="line">  <span class="keyword">if</span> (renderTriggered) &#123; <span class="comment">// 当做回调函数 放入 onRenderTriggered 钩子</span></span><br><span class="line">    onRenderTriggered(renderTriggered.bind(publicThis))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 开发环境下 有 beforeDestroy 警告一下</span></span><br><span class="line">  <span class="keyword">if</span> (__DEV__ &amp;&amp; beforeDestroy) &#123;</span><br><span class="line">    warn(<span class="string">`\`beforeDestroy\` has been renamed to \`beforeUnmount\`.`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 存在 beforeUnmount 钩子</span></span><br><span class="line">  <span class="keyword">if</span> (beforeUnmount) &#123; <span class="comment">// 当做回调函数 放入 onBeforeUnmount 钩子</span></span><br><span class="line">    onBeforeUnmount(beforeUnmount.bind(publicThis))</span><br><span class="line">&#125;</span><br><span class="line">  <span class="comment">// 开发环境下 有 destroyed 警告一下</span></span><br><span class="line"><span class="keyword">if</span> (__DEV__ &amp;&amp; destroyed) &#123;</span><br><span class="line">    warn(<span class="string">`\`destroyed\` has been renamed to \`unmounted\`.`</span>)</span><br><span class="line">&#125;</span><br><span class="line">  <span class="comment">// 存在 unmounted 钩子</span></span><br><span class="line">  <span class="keyword">if</span> (unmounted) &#123;  <span class="comment">// 当做回调函数 放入 onUnmounted 钩子</span></span><br><span class="line">    onUnmounted(unmounted.bind(publicThis))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 存在expose</span></span><br><span class="line">  <span class="keyword">if</span> (isArray(expose)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!asMixin) &#123; <span class="comment">// 不是mixin</span></span><br><span class="line">      <span class="keyword">if</span> (expose.length) &#123;</span><br><span class="line">        <span class="keyword">const</span> exposed = instance.exposed || (instance.exposed = proxyRefs(&#123;&#125;)) <span class="comment">// 取出实例上的expose</span></span><br><span class="line">        expose.forEach(<span class="function"><span class="params">key</span> =&gt;</span> &#123; <span class="comment">// 遍历expose</span></span><br><span class="line">          exposed[key] = toRef(publicThis, key <span class="keyword">as</span> <span class="built_in">any</span>) <span class="comment">// 将 publicThis 上的key 对应的值 放到exposed对应的key值上</span></span><br><span class="line">        &#125;)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!instance.exposed) &#123; <span class="comment">// 实例上不存在</span></span><br><span class="line">        instance.exposed = EMPTY_OBJ <span class="comment">// 赋值为空对象</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      warn(<span class="string">`The \`expose\` option is ignored when used in mixins.`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>callSyncHook, callHookFromExtends, callHookFromMixins</strong></p>
<p><code>packages/runtime-core/src/componentOptions.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">callSyncHook</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  name: <span class="string">&#x27;beforeCreate&#x27;</span> | <span class="string">&#x27;created&#x27;</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">type</span>: LifecycleHooks,</span></span></span><br><span class="line"><span class="params"><span class="function">  options: ComponentOptions,</span></span></span><br><span class="line"><span class="params"><span class="function">  instance: ComponentInternalInstance,</span></span></span><br><span class="line"><span class="params"><span class="function">  globalMixins: ComponentOptions[]</span></span></span><br><span class="line"><span class="params"><span class="function"></span>) </span>&#123;</span><br><span class="line">  callHookFromMixins(name, <span class="keyword">type</span>, globalMixins, instance) <span class="comment">// 先从全局的mixin开始</span></span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="attr">extends</span>: base, mixins &#125; = options <span class="comment">// 取出 optionApi 中的 extends(base) 和 mixins</span></span><br><span class="line">  <span class="keyword">if</span> (base) &#123; <span class="comment">// 存在 调用 callHookFromExtends</span></span><br><span class="line">    callHookFromExtends(name, <span class="keyword">type</span>, base, instance)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (mixins) &#123; <span class="comment">// 存在调用  callHookFromMixins</span></span><br><span class="line">    callHookFromMixins(name, <span class="keyword">type</span>, mixins, instance)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> selfHook = options[name] <span class="comment">// 获取用户自己写的 beforeCreate / created</span></span><br><span class="line">  <span class="keyword">if</span> (selfHook) &#123; <span class="comment">// 存在 就调用</span></span><br><span class="line">    callWithAsyncErrorHandling(selfHook.bind(instance.proxy!), instance, <span class="keyword">type</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">callHookFromExtends</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  name: <span class="string">&#x27;beforeCreate&#x27;</span> | <span class="string">&#x27;created&#x27;</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">type</span>: LifecycleHooks,</span></span></span><br><span class="line"><span class="params"><span class="function">  base: ComponentOptions,</span></span></span><br><span class="line"><span class="params"><span class="function">  instance: ComponentInternalInstance</span></span></span><br><span class="line"><span class="params"><span class="function"></span>) </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (base.extends) &#123; <span class="comment">// 如果带有extends 则执行 callHookFromExtends</span></span><br><span class="line">    callHookFromExtends(name, <span class="keyword">type</span>, base.extends, instance)</span><br><span class="line">&#125;</span><br><span class="line">  <span class="comment">// 拿到 全局中的mixin的 beforeCreate/created 方法</span></span><br><span class="line"><span class="keyword">const</span> baseHook = base[name]</span><br><span class="line">  <span class="keyword">if</span> (baseHook) &#123; <span class="comment">// 存在 则调用 callWithAsyncErrorHandling</span></span><br><span class="line">    callWithAsyncErrorHandling(baseHook.bind(instance.proxy!), instance, <span class="keyword">type</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">callHookFromMixins</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  name: <span class="string">&#x27;beforeCreate&#x27;</span> | <span class="string">&#x27;created&#x27;</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">type</span>: LifecycleHooks,</span></span></span><br><span class="line"><span class="params"><span class="function">  mixins: ComponentOptions[],</span></span></span><br><span class="line"><span class="params"><span class="function">  instance: ComponentInternalInstance</span></span></span><br><span class="line"><span class="params"><span class="function"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; mixins.length; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> chainedMixins = mixins[i].mixins</span><br><span class="line">    <span class="keyword">if</span> (chainedMixins) &#123;</span><br><span class="line">      callHookFromMixins(name, <span class="keyword">type</span>, chainedMixins, instance)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> fn = mixins[i][name]</span><br><span class="line">    <span class="keyword">if</span> (fn) &#123;</span><br><span class="line">      callWithAsyncErrorHandling(fn.bind(instance.proxy!), instance, <span class="keyword">type</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">    </span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p><strong>callWithAsyncErrorHandling,  handleError,  logError</strong></p>
<p>  <code>packages/runtime-core/src/errorHandling.ts</code></p>
<pre><code><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">callWithAsyncErrorHandling</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    fn: <span class="built_in">Function</span> | <span class="built_in">Function</span>[],</span></span></span><br><span class="line"><span class="params"><span class="function">    instance: ComponentInternalInstance | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">type</span>: ErrorTypes,</span></span></span><br><span class="line"><span class="params"><span class="function">    args?: unknown[]</span></span></span><br><span class="line"><span class="params"><span class="function">  </span>): <span class="title">any</span>[] </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isFunction(fn)) &#123; <span class="comment">// 如果是函数</span></span><br><span class="line">      <span class="keyword">const</span> res = callWithErrorHandling(fn, instance, <span class="keyword">type</span>, args) <span class="comment">// 拿到结果</span></span><br><span class="line">      <span class="keyword">if</span> (res &amp;&amp; isPromise(res)) &#123; <span class="comment">// 结果存在且是promise 成功捕获错误会调用 handleError</span></span><br><span class="line">        res.catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">          handleError(err, instance, <span class="keyword">type</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> res <span class="comment">// 返回执行结果</span></span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 说明传过来的是一个函数数组</span></span><br><span class="line">    <span class="keyword">const</span> values = [] <span class="comment">// 结果数组</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; fn.length; i++) &#123;</span><br><span class="line">      values.push(callWithAsyncErrorHandling(fn[i], instance, <span class="keyword">type</span>, args)) <span class="comment">// 执行结果push进 values数组</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> values <span class="comment">// 返回结果数组</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">handleError</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    err: unknown,</span></span></span><br><span class="line"><span class="params"><span class="function">    instance: ComponentInternalInstance | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">type</span>: ErrorTypes,</span></span></span><br><span class="line"><span class="params"><span class="function">    throwInDev = <span class="literal">true</span></span></span></span><br><span class="line"><span class="params"><span class="function">  </span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> contextVNode = instance ? instance.vnode : <span class="literal">null</span> <span class="comment">// 拿到当前的VNode</span></span><br><span class="line">    <span class="keyword">if</span> (instance) &#123; <span class="comment">// 存在</span></span><br><span class="line">      <span class="keyword">let</span> cur = instance.parent</span><br><span class="line">      <span class="comment">// the exposed instance is the render proxy to keep it consistent with 2.x</span></span><br><span class="line">      <span class="keyword">const</span> exposedInstance = instance.proxy</span><br><span class="line">      <span class="comment">// in production the hook receives only the error code</span></span><br><span class="line">      <span class="keyword">const</span> errorInfo = __DEV__ ? ErrorTypeStrings[<span class="keyword">type</span>] : <span class="keyword">type</span></span><br><span class="line">      <span class="keyword">while</span> (cur) &#123;</span><br><span class="line">        <span class="keyword">const</span> errorCapturedHooks = cur.ec <span class="comment">// 获取errorCapture数组</span></span><br><span class="line">        <span class="keyword">if</span> (errorCapturedHooks) &#123; <span class="comment">//存在</span></span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; errorCapturedHooks.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (</span><br><span class="line">              errorCapturedHooks[i](err, exposedInstance, errorInfo) === <span class="literal">false</span> <span class="comment">// 执行如果返回结果是false</span></span><br><span class="line">            ) &#123;</span><br><span class="line">              <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        cur = cur.parent <span class="comment">// 向上寻找</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// app-level handling</span></span><br><span class="line">      <span class="keyword">const</span> appErrorHandler = instance.appContext.config.errorHandler <span class="comment">// 用户自己定义的错误handler</span></span><br><span class="line">      <span class="keyword">if</span> (appErrorHandler) &#123; <span class="comment">// 存在 </span></span><br><span class="line">        <span class="comment">// 执行用户自己定义的handler</span></span><br><span class="line">        callWithErrorHandling(</span><br><span class="line">          appErrorHandler,</span><br><span class="line">          <span class="literal">null</span>,</span><br><span class="line">          ErrorCodes.APP_ERROR_HANDLER,</span><br><span class="line">          [err, exposedInstance, errorInfo]</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    logError(err, <span class="keyword">type</span>, contextVNode, throwInDev) <span class="comment">// 调用logError</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">logError</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    err: unknown,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">type</span>: ErrorTypes,</span></span></span><br><span class="line"><span class="params"><span class="function">    contextVNode: VNode | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    throwInDev = <span class="literal">true</span></span></span></span><br><span class="line"><span class="params"><span class="function">  </span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      <span class="keyword">const</span> info = ErrorTypeStrings[<span class="keyword">type</span>]</span><br><span class="line">      <span class="keyword">if</span> (contextVNode) &#123;</span><br><span class="line">        pushWarningContext(contextVNode)</span><br><span class="line">      &#125;</span><br><span class="line">      warn(<span class="string">`Unhandled error<span class="subst">$&#123;info ? <span class="string">` during execution of <span class="subst">$&#123;info&#125;</span>`</span> : <span class="string">``</span>&#125;</span>`</span>)</span><br><span class="line">      <span class="keyword">if</span> (contextVNode) &#123;</span><br><span class="line">        popWarningContext()</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// crash in dev by default so it&#x27;s more noticeable</span></span><br><span class="line">      <span class="keyword">if</span> (throwInDev) &#123;</span><br><span class="line">        <span class="keyword">throw</span> err</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!__TEST__) &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(err)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// recover in prod to reduce the impact on end-user</span></span><br><span class="line">      <span class="built_in">console</span>.error(err)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></code></pre></li>
</ul>
</li>
</ul>
<pre><code>- **applyMixins**

  `packages/runtime-core/compoentOptions.ts`

  <figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">applyMixins</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  instance: ComponentInternalInstance,</span></span></span><br><span class="line"><span class="params"><span class="function">  mixins: ComponentOptions[],</span></span></span><br><span class="line"><span class="params"><span class="function">  deferredData: DataFn[],</span></span></span><br><span class="line"><span class="params"><span class="function">  deferredWatch: ComponentWatchOptions[],</span></span></span><br><span class="line"><span class="params"><span class="function">  deferredProvide: (Data | <span class="built_in">Function</span>)[]</span></span></span><br><span class="line"><span class="params"><span class="function"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 遍历全局或者组件上的mixins中的每一项 分别调用applyOptions 并且 asMixin这个参数是true</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; mixins.length; i++) &#123;</span><br><span class="line">    applyOptions(</span><br><span class="line">      instance,</span><br><span class="line">      mixins[i],</span><br><span class="line">      deferredData,</span><br><span class="line">      deferredWatch,</span><br><span class="line">      deferredProvide,</span><br><span class="line">      <span class="literal">true</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

- **createDuplicateChecker**

  `packages/runtime-core/src/componentOptions.ts`

  <figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createDuplicateChecker</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> cache = <span class="built_in">Object</span>.create(<span class="literal">null</span>) <span class="comment">// 利用闭包创建一个缓存</span></span><br><span class="line">  <span class="comment">// 返回一个方法 type 指的 Props, Data, Computed, Methods, Inject, 检验key是否被定义了</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params"><span class="keyword">type</span>: OptionTypes, key: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (cache[key]) &#123;</span><br><span class="line">      warn(<span class="string">`<span class="subst">$&#123;<span class="keyword">type</span>&#125;</span> property &quot;<span class="subst">$&#123;key&#125;</span>&quot; is already defined in <span class="subst">$&#123;cache[key]&#125;</span>.`</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      cache[key] = <span class="keyword">type</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

- **inject**

  `packages/rumtime-core/src/apiInject.ts`

  <figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">inject</span>&lt;<span class="title">T</span>&gt;(<span class="params">key: InjectionKey&lt;T&gt; | <span class="built_in">string</span></span>): <span class="title">T</span> | <span class="title">undefined</span> // 只传入一个参数 <span class="title">key</span></span></span><br><span class="line"><span class="function"><span class="title">export</span> <span class="function"><span class="keyword">function</span> <span class="title">inject</span>&lt;<span class="title">T</span>&gt;(<span class="params"></span></span></span></span><br><span class="line"><span class="params"><span class="function"><span class="function">  key: InjectionKey&lt;T&gt; | <span class="built_in">string</span>,</span></span></span></span><br><span class="line"><span class="params"><span class="function"><span class="function">  defaultValue: T,</span></span></span></span><br><span class="line"><span class="params"><span class="function"><span class="function">  treatDefaultAsFactory?: <span class="literal">false</span></span></span></span></span><br><span class="line"><span class="params"><span class="function"><span class="function"></span>): <span class="title">T</span> // <span class="title">key</span>, 默认值, 是否是为工厂</span></span></span><br><span class="line"><span class="function"><span class="function"><span class="title">export</span> <span class="function"><span class="keyword">function</span> <span class="title">inject</span>&lt;<span class="title">T</span>&gt;(<span class="params"></span></span></span></span></span><br><span class="line"><span class="params"><span class="function"><span class="function"><span class="function">  key: InjectionKey&lt;T&gt; | <span class="built_in">string</span>,</span></span></span></span></span><br><span class="line"><span class="params"><span class="function"><span class="function"><span class="function">  defaultValue: T | (() =&gt; T),</span></span></span></span></span><br><span class="line"><span class="params"><span class="function"><span class="function"><span class="function">  treatDefaultAsFactory: <span class="literal">true</span></span></span></span></span></span><br><span class="line"><span class="params"><span class="function"><span class="function"><span class="function"></span>): <span class="title">T</span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="title">export</span> <span class="function"><span class="keyword">function</span> <span class="title">inject</span>(<span class="params"></span></span></span></span></span></span><br><span class="line"><span class="params"><span class="function"><span class="function"><span class="function"><span class="function">  key: InjectionKey&lt;<span class="built_in">any</span>&gt; | <span class="built_in">string</span>,</span></span></span></span></span></span><br><span class="line"><span class="params"><span class="function"><span class="function"><span class="function"><span class="function">  defaultValue?: unknown,</span></span></span></span></span></span><br><span class="line"><span class="params"><span class="function"><span class="function"><span class="function"><span class="function">  treatDefaultAsFactory = <span class="literal">false</span></span></span></span></span></span></span><br><span class="line"><span class="params"><span class="function"><span class="function"><span class="function"><span class="function"></span>) </span>&#123;</span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function">  // <span class="title">fallback</span> <span class="title">to</span> `<span class="title">currentRenderingInstance</span>` <span class="title">so</span> <span class="title">that</span> <span class="title">this</span> <span class="title">can</span> <span class="title">be</span> <span class="title">called</span> <span class="title">in</span> <span class="title">a</span> <span class="title">functional</span> <span class="title">component</span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function">  // 获取实例</span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function">  <span class="title">const</span> <span class="title">instance</span> = <span class="title">currentInstance</span> || <span class="title">currentRenderingInstance</span> // 当前实例没有 就取当前正在<span class="title">render</span>的实例</span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function">  <span class="title">if</span> (<span class="params">instance</span>) </span>&#123;</span></span></span><br><span class="line"><span class="function"><span class="function">    // #2400</span></span></span><br><span class="line"><span class="function"><span class="function">    // <span class="title">to</span> <span class="title">support</span> `<span class="title">app</span>.<span class="title">use</span>` <span class="title">plugins</span>,</span></span></span><br><span class="line"><span class="function"><span class="function">    // <span class="title">fallback</span> <span class="title">to</span> <span class="title">appContext</span>&#x27;<span class="title">s</span> `<span class="title">provides</span>` <span class="title">if</span> <span class="title">the</span> <span class="title">intance</span> <span class="title">is</span> <span class="title">at</span> <span class="title">root</span></span></span></span><br><span class="line"><span class="function"><span class="function">    <span class="title">const</span> <span class="title">provides</span> =</span></span></span><br><span class="line"><span class="function"><span class="function">      <span class="title">instance</span>.<span class="title">parent</span> == <span class="title">null</span> </span></span></span><br><span class="line"><span class="function"><span class="function">        ? <span class="title">instance</span>.<span class="title">vnode</span>.<span class="title">appContext</span> &amp;&amp; <span class="title">instance</span>.<span class="title">vnode</span>.<span class="title">appContext</span>.<span class="title">provides</span> // 是根节点则取出<span class="title">provides</span></span></span></span><br><span class="line"><span class="function"><span class="function">        : <span class="title">instance</span>.<span class="title">parent</span>.<span class="title">provides</span> // 否则就是往<span class="title">parent</span>去寻找</span></span></span><br><span class="line"><span class="function"><span class="function"></span></span></span><br><span class="line"><span class="function"><span class="function">    <span class="title">if</span> (<span class="params">provides &amp;&amp; (key <span class="keyword">as</span> <span class="built_in">string</span> | symbol) <span class="keyword">in</span> provides</span>) </span>&#123; // <span class="title">provides</span>存在 且 传入的<span class="title">key</span>也是 <span class="title">provides</span>的键</span></span><br><span class="line"><span class="function">      // <span class="title">TS</span> <span class="title">doesn</span>&#x27;<span class="title">t</span> <span class="title">allow</span> <span class="title">symbol</span> <span class="title">as</span> <span class="title">index</span> <span class="title">type</span></span></span><br><span class="line"><span class="function">      <span class="title">return</span> <span class="title">provides</span>[<span class="title">key</span> <span class="title">as</span> <span class="title">string</span>]</span></span><br><span class="line"><span class="function">    &#125; <span class="title">else</span> <span class="title">if</span> (<span class="params"><span class="built_in">arguments</span>.length &gt; <span class="number">1</span></span>) </span>&#123; <span class="comment">// 传入的参数不止一个</span></span><br><span class="line">      <span class="comment">// 第三个参数为true且第二个参数是函数</span></span><br><span class="line">      <span class="keyword">return</span> treatDefaultAsFactory &amp;&amp; isFunction(defaultValue)</span><br><span class="line">        ? defaultValue() <span class="comment">// 直接返回defalutValue的调用结果</span></span><br><span class="line">        : defaultValue <span class="comment">// 否则返回第二个参数</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      warn(<span class="string">`injection &quot;<span class="subst">$&#123;<span class="built_in">String</span>(key)&#125;</span>&quot; not found.`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    warn(<span class="string">`inject() can only be used inside setup() or functional components.`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

- **resolveData**

  `packages/runtime-core/src/componentOptions.ts`

  <figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolveData</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  instance: ComponentInternalInstance,</span></span></span><br><span class="line"><span class="params"><span class="function">  dataFn: DataFn,</span></span></span><br><span class="line"><span class="params"><span class="function">  publicThis: ComponentPublicInstance</span></span></span><br><span class="line"><span class="params"><span class="function"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (__DEV__ &amp;&amp; !isFunction(dataFn)) &#123; <span class="comment">// 不是函数</span></span><br><span class="line">    warn(</span><br><span class="line">      <span class="string">`The data option must be a function. `</span> +</span><br><span class="line">        <span class="string">`Plain object usage is no longer supported.`</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> data = dataFn.call(publicThis, publicThis) <span class="comment">// 执行dataFn</span></span><br><span class="line">  <span class="keyword">if</span> (__DEV__ &amp;&amp; isPromise(data)) &#123; <span class="comment">// 如果是promise</span></span><br><span class="line">    warn(</span><br><span class="line">      <span class="string">`data() returned a Promise - note data() cannot be async; If you `</span> +</span><br><span class="line">        <span class="string">`intend to perform data fetching before component renders, use `</span> +</span><br><span class="line">        <span class="string">`async setup() + &lt;Suspense&gt;.`</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!isObject(data)) &#123; <span class="comment">// 如果不是对象</span></span><br><span class="line">    __DEV__ &amp;&amp; warn(<span class="string">`data() should return an object.`</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (instance.data === EMPTY_OBJ) &#123; <span class="comment">// 如果是空对象</span></span><br><span class="line">    instance.data = reactive(data)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// existing data: this is a mixin or extends.</span></span><br><span class="line">    <span class="comment">// 扩展到实例的data上</span></span><br><span class="line">    extend(instance.data, data)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

- **provide**

  `packages/rumtime-core/src/apiInject.ts`

  <figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">provide</span>&lt;<span class="title">T</span>&gt;(<span class="params">key: InjectionKey&lt;T&gt; | <span class="built_in">string</span> | <span class="built_in">number</span>, value: T</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!currentInstance) &#123;</span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      warn(<span class="string">`provide() can only be used inside setup().`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> provides = currentInstance.provides</span><br><span class="line">    <span class="comment">// by default an instance inherits its parent&#x27;s provides object</span></span><br><span class="line">    <span class="comment">// but when it needs to provide values of its own, it creates its</span></span><br><span class="line">    <span class="comment">// own provides object using parent provides object as prototype.</span></span><br><span class="line">    <span class="comment">// this way in `inject` we can simply look up injections from direct</span></span><br><span class="line">    <span class="comment">// parent and let the prototype chain do the work.</span></span><br><span class="line">    <span class="keyword">const</span> parentProvides =</span><br><span class="line">      currentInstance.parent &amp;&amp; currentInstance.parent.provides</span><br><span class="line">    <span class="keyword">if</span> (parentProvides === provides) &#123;</span><br><span class="line">      provides = currentInstance.provides = <span class="built_in">Object</span>.create(parentProvides)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// TS doesn&#x27;t allow symbol as index type</span></span><br><span class="line">    provides[key <span class="keyword">as</span> <span class="built_in">string</span>] = value</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></code></pre><h4 id="setupRenderEffect"><a href="#setupRenderEffect" class="headerlink" title="setupRenderEffect"></a>setupRenderEffect</h4><p><code>packages/runtime-core/src/rendered.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> setupRenderEffect: SetupRenderEffectFn = <span class="function">(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  instance,</span></span></span><br><span class="line"><span class="params"><span class="function">  initialVNode,</span></span></span><br><span class="line"><span class="params"><span class="function">  container,</span></span></span><br><span class="line"><span class="params"><span class="function">  anchor,</span></span></span><br><span class="line"><span class="params"><span class="function">  parentSuspense,</span></span></span><br><span class="line"><span class="params"><span class="function">  isSVG,</span></span></span><br><span class="line"><span class="params"><span class="function">  optimized</span></span></span><br><span class="line"><span class="params"><span class="function"></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// create reactive effect for rendering</span></span><br><span class="line">  <span class="comment">// 给实例的update属性赋值 effect方法后面再来看</span></span><br><span class="line">  instance.update = effect(<span class="function"><span class="keyword">function</span> <span class="title">componentEffect</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!instance.isMounted) &#123; <span class="comment">// 实例还没有挂载</span></span><br><span class="line">      <span class="keyword">let</span> vnodeHook: VNodeHook | <span class="literal">null</span> | <span class="literal">undefined</span></span><br><span class="line">      <span class="keyword">const</span> &#123; el, props &#125; = initialVNode </span><br><span class="line">      <span class="keyword">const</span> &#123; bm, m, parent &#125; = instance <span class="comment">// 取出beforeMount mounted</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 存在调用beforeMount钩子</span></span><br><span class="line">      <span class="keyword">if</span> (bm) &#123;</span><br><span class="line">        invokeArrayFns(bm) <span class="comment">// 这个方法 里面就是 循环 fnsArr 挨个调用</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// onVnodeBeforeMount</span></span><br><span class="line">      <span class="keyword">if</span> ((vnodeHook = props &amp;&amp; props.onVnodeBeforeMount)) &#123;</span><br><span class="line">        invokeVNodeHook(vnodeHook, parent, initialVNode)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// render</span></span><br><span class="line">      <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        startMeasure(instance, <span class="string">`render`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 执行 renderComponentRoot 创建子树</span></span><br><span class="line">      <span class="keyword">const</span> subTree = (instance.subTree = renderComponentRoot(instance))</span><br><span class="line">      <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        endMeasure(instance, <span class="string">`render`</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 存在el 且 要注水</span></span><br><span class="line">      <span class="keyword">if</span> (el &amp;&amp; hydrateNode) &#123;</span><br><span class="line">        <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          startMeasure(instance, <span class="string">`hydrate`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// vnode has adopted host node - perform hydration instead of mount.</span></span><br><span class="line">        hydrateNode(</span><br><span class="line">          initialVNode.el <span class="keyword">as</span> Node,</span><br><span class="line">          subTree,</span><br><span class="line">          instance,</span><br><span class="line">          parentSuspense</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          endMeasure(instance, <span class="string">`hydrate`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          startMeasure(instance, <span class="string">`patch`</span>)</span><br><span class="line">        &#125; <span class="comment">// 开始patch 不过这次会进 processFragment </span></span><br><span class="line">        patch(</span><br><span class="line">          <span class="literal">null</span>,</span><br><span class="line">          subTree,</span><br><span class="line">          container,</span><br><span class="line">          anchor,</span><br><span class="line">          instance,</span><br><span class="line">          parentSuspense,</span><br><span class="line">          isSVG</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          endMeasure(instance, <span class="string">`patch`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        initialVNode.el = subTree.el</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// mounted hook</span></span><br><span class="line">      <span class="keyword">if</span> (m) &#123;</span><br><span class="line">        queuePostRenderEffect(m, parentSuspense)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// onVnodeMounted</span></span><br><span class="line">      <span class="keyword">if</span> ((vnodeHook = props &amp;&amp; props.onVnodeMounted)) &#123;</span><br><span class="line">        <span class="keyword">const</span> scopedInitialVNode = initialVNode</span><br><span class="line">        queuePostRenderEffect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          invokeVNodeHook(vnodeHook!, parent, scopedInitialVNode)</span><br><span class="line">        &#125;, parentSuspense)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// activated hook for keep-alive roots.</span></span><br><span class="line">      <span class="comment">// #1742 activated hook must be accessed after first render</span></span><br><span class="line">      <span class="comment">// since the hook may be injected by a child keep-alive</span></span><br><span class="line">      <span class="keyword">const</span> &#123; a &#125; = instance <span class="comment">// keepAlive activated钩子</span></span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        a &amp;&amp;</span><br><span class="line">        initialVNode.shapeFlag &amp; ShapeFlags.COMPONENT_SHOULD_KEEP_ALIVE</span><br><span class="line">      ) &#123;</span><br><span class="line">        queuePostRenderEffect(a, parentSuspense)</span><br><span class="line">      &#125;</span><br><span class="line">      instance.isMounted = <span class="literal">true</span> <span class="comment">// 挂载完毕</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// #2458: deference mount-only object parameters to prevent memleaks</span></span><br><span class="line">      initialVNode = container = anchor = <span class="literal">null</span> <span class="keyword">as</span> <span class="built_in">any</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 更新组件</span></span><br><span class="line">      <span class="comment">// updateComponent</span></span><br><span class="line">      <span class="comment">// This is triggered by mutation of component&#x27;s own state (next: null)</span></span><br><span class="line">      <span class="comment">// OR parent calling processComponent (next: VNode)</span></span><br><span class="line">      <span class="keyword">let</span> &#123; next, bu, u, parent, vnode &#125; = instance</span><br><span class="line">      <span class="keyword">let</span> originNext = next</span><br><span class="line">      <span class="keyword">let</span> vnodeHook: VNodeHook | <span class="literal">null</span> | <span class="literal">undefined</span></span><br><span class="line">      <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        pushWarningContext(next || instance.vnode)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (next) &#123;</span><br><span class="line">        next.el = vnode.el</span><br><span class="line">        updateComponentPreRender(instance, next, optimized)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        next = vnode</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// beforeUpdate hook</span></span><br><span class="line">      <span class="keyword">if</span> (bu) &#123;</span><br><span class="line">        invokeArrayFns(bu)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// onVnodeBeforeUpdate</span></span><br><span class="line">      <span class="keyword">if</span> ((vnodeHook = next.props &amp;&amp; next.props.onVnodeBeforeUpdate)) &#123;</span><br><span class="line">        invokeVNodeHook(vnodeHook, parent, next, vnode)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// render</span></span><br><span class="line">      <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        startMeasure(instance, <span class="string">`render`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> nextTree = renderComponentRoot(instance)</span><br><span class="line">      <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        endMeasure(instance, <span class="string">`render`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> prevTree = instance.subTree</span><br><span class="line">      instance.subTree = nextTree</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        startMeasure(instance, <span class="string">`patch`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      patch(</span><br><span class="line">        prevTree,</span><br><span class="line">        nextTree,</span><br><span class="line">        <span class="comment">// parent may have changed if it&#x27;s in a teleport</span></span><br><span class="line">        hostParentNode(prevTree.el!)!,</span><br><span class="line">        <span class="comment">// anchor may have changed if it&#x27;s in a fragment</span></span><br><span class="line">        getNextHostNode(prevTree),</span><br><span class="line">        instance,</span><br><span class="line">        parentSuspense,</span><br><span class="line">        isSVG</span><br><span class="line">      )</span><br><span class="line">      <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        endMeasure(instance, <span class="string">`patch`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      next.el = nextTree.el</span><br><span class="line">      <span class="keyword">if</span> (originNext === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// self-triggered update. In case of HOC, update parent component</span></span><br><span class="line">        <span class="comment">// vnode el. HOC is indicated by parent instance&#x27;s subTree pointing</span></span><br><span class="line">        <span class="comment">// to child component&#x27;s vnode</span></span><br><span class="line">        updateHOCHostEl(instance, nextTree.el)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// updated hook</span></span><br><span class="line">      <span class="keyword">if</span> (u) &#123;</span><br><span class="line">        queuePostRenderEffect(u, parentSuspense)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// onVnodeUpdated</span></span><br><span class="line">      <span class="keyword">if</span> ((vnodeHook = next.props &amp;&amp; next.props.onVnodeUpdated)) &#123;</span><br><span class="line">        queuePostRenderEffect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          invokeVNodeHook(vnodeHook!, parent, next!, vnode)</span><br><span class="line">        &#125;, parentSuspense)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (__DEV__ || __FEATURE_PROD_DEVTOOLS__) &#123;</span><br><span class="line">        devtoolsComponentUpdated(instance)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        popWarningContext()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, __DEV__ ? createDevEffectOptions(instance) : prodEffectOptions)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="createDevEffectOptions"><a href="#createDevEffectOptions" class="headerlink" title="createDevEffectOptions"></a>createDevEffectOptions</h5><p><code>packages/runtime-core/src/renderer.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createDevEffectOptions</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  instance: ComponentInternalInstance</span></span></span><br><span class="line"><span class="params"><span class="function"></span>): <span class="title">ReactiveEffectOptions</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">scheduler</span>: queueJob,</span><br><span class="line">    <span class="attr">allowRecurse</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">onTrack</span>: instance.rtc ? <span class="function"><span class="params">e</span> =&gt;</span> invokeArrayFns(instance.rtc!, e) : <span class="built_in">void</span> <span class="number">0</span>,</span><br><span class="line">    <span class="attr">onTrigger</span>: instance.rtg ? <span class="function"><span class="params">e</span> =&gt;</span> invokeArrayFns(instance.rtg!, e) : <span class="built_in">void</span> <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="renderComponentRoot"><a href="#renderComponentRoot" class="headerlink" title="renderComponentRoot"></a>renderComponentRoot</h5><p><code>packages/runtime-core/src/componentRenderUtils.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">renderComponentRoot</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  instance: ComponentInternalInstance</span></span></span><br><span class="line"><span class="params"><span class="function"></span>): <span class="title">VNode</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;</span><br><span class="line">    <span class="attr">type</span>: Component,</span><br><span class="line">    vnode,</span><br><span class="line">    proxy,</span><br><span class="line">    withProxy,</span><br><span class="line">    props,</span><br><span class="line">    <span class="attr">propsOptions</span>: [propsOptions],</span><br><span class="line">    slots,</span><br><span class="line">    attrs,</span><br><span class="line">    emit,</span><br><span class="line">    render,</span><br><span class="line">    renderCache,</span><br><span class="line">    data,</span><br><span class="line">    setupState,</span><br><span class="line">    ctx</span><br><span class="line">  &#125; = instance</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> result</span><br><span class="line">  currentRenderingInstance = instance <span class="comment">// 当前render的实例</span></span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    accessedAttrs = <span class="literal">false</span> <span class="comment">// 访问属性为 false</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> fallthroughAttrs</span><br><span class="line">    <span class="keyword">if</span> (vnode.shapeFlag &amp; ShapeFlags.STATEFUL_COMPONENT) &#123; <span class="comment">// 有状态的组件</span></span><br><span class="line">      <span class="comment">// withProxy is a proxy with a different `has` trap only for</span></span><br><span class="line">      <span class="comment">// runtime-compiled render functions using `with` block.</span></span><br><span class="line">      <span class="keyword">const</span> proxyToUse = withProxy || proxy</span><br><span class="line">      result = normalizeVNode(</span><br><span class="line">        <span class="comment">// 先执行之前生成的render函数</span></span><br><span class="line">        render!.call(</span><br><span class="line">          proxyToUse,</span><br><span class="line">          proxyToUse!,</span><br><span class="line">          renderCache,</span><br><span class="line">          props,</span><br><span class="line">          setupState,</span><br><span class="line">          data,</span><br><span class="line">          ctx</span><br><span class="line">        )</span><br><span class="line">      )</span><br><span class="line">      fallthroughAttrs = attrs</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// 函数组件</span></span><br><span class="line">      <span class="comment">// 省略代码</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// attr merging</span></span><br><span class="line">    <span class="comment">// in dev mode, comments are preserved, and it&#x27;s possible for a template</span></span><br><span class="line">    <span class="comment">// to have comments along side the root element which makes it a fragment</span></span><br><span class="line">    <span class="keyword">let</span> root = result</span><br><span class="line">    <span class="keyword">let</span> setRoot: (<span class="function">(<span class="params">root: VNode</span>) =&gt;</span> <span class="built_in">void</span>) | <span class="literal">undefined</span> = <span class="literal">undefined</span> <span class="comment">// setRoot方法</span></span><br><span class="line">    <span class="keyword">if</span> (__DEV__ &amp;&amp; result.patchFlag &amp; PatchFlags.DEV_ROOT_FRAGMENT) &#123; <span class="comment">// DEV_ROOT_FRAGMENT 2048 开发环境</span></span><br><span class="line">      ;[root, setRoot] = getChildRoot(result)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// inheritAttrs 不为false</span></span><br><span class="line">    <span class="keyword">if</span> (Component.inheritAttrs !== <span class="literal">false</span> &amp;&amp; fallthroughAttrs) &#123;</span><br><span class="line">      <span class="keyword">const</span> keys = <span class="built_in">Object</span>.keys(fallthroughAttrs) <span class="comment">// Object.keys不能拿出 enumerable为false的key</span></span><br><span class="line">      <span class="keyword">const</span> &#123; shapeFlag &#125; = root</span><br><span class="line">      <span class="keyword">if</span> (keys.length) &#123;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">          shapeFlag &amp; ShapeFlags.ELEMENT ||</span><br><span class="line">          shapeFlag &amp; ShapeFlags.COMPONENT</span><br><span class="line">        ) &#123; <span class="comment">// 元素或者组件</span></span><br><span class="line">          <span class="keyword">if</span> (propsOptions &amp;&amp; keys.some(isModelListener)) &#123; <span class="comment">// 存在属性 且还有 &quot;onUpdate:&quot;开头的</span></span><br><span class="line">            <span class="comment">// If a v-model listener (onUpdate:xxx) has a corresponding declared</span></span><br><span class="line">            <span class="comment">// prop, it indicates this component expects to handle v-model and</span></span><br><span class="line">            <span class="comment">// it should not fallthrough.</span></span><br><span class="line">            <span class="comment">// related: #1543, #1643, #1989</span></span><br><span class="line">            <span class="comment">// filterModelListeners 筛选出 attrs中存在&quot;onUpdate:&quot;开头的 或者 key.slice(0, 9)还存在props里面的</span></span><br><span class="line">            fallthroughAttrs = filterModelListeners(</span><br><span class="line">              fallthroughAttrs,</span><br><span class="line">              propsOptions</span><br><span class="line">            )</span><br><span class="line">          &#125;</span><br><span class="line">          root = cloneVNode(root, fallthroughAttrs)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__ &amp;&amp; !accessedAttrs &amp;&amp; root.type !== Comment) &#123;</span><br><span class="line">          <span class="keyword">const</span> allAttrs = <span class="built_in">Object</span>.keys(attrs)</span><br><span class="line">          <span class="keyword">const</span> eventAttrs: <span class="built_in">string</span>[] = []</span><br><span class="line">          <span class="keyword">const</span> extraAttrs: <span class="built_in">string</span>[] = []</span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = allAttrs.length; i &lt; l; i++) &#123;</span><br><span class="line">            <span class="keyword">const</span> key = allAttrs[i]</span><br><span class="line">            <span class="keyword">if</span> (isOn(key)) &#123; <span class="comment">// 检验是不是on开头的key</span></span><br><span class="line">              <span class="comment">// ignore v-model handlers when they fail to fallthrough</span></span><br><span class="line">              <span class="keyword">if</span> (!isModelListener(key)) &#123; <span class="comment">// 但不是 &quot;onUpdate:&quot;开头的</span></span><br><span class="line">                <span class="comment">// remove `on`, lowercase first letter to reflect event casing</span></span><br><span class="line">                <span class="comment">// accurately</span></span><br><span class="line">                eventAttrs.push(key[<span class="number">2</span>].toLowerCase() + key.slice(<span class="number">3</span>)) <span class="comment">// push进eventAttrs</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              extraAttrs.push(key) <span class="comment">// 移入extraAttrs</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (extraAttrs.length) &#123;</span><br><span class="line">            warn(</span><br><span class="line">              <span class="string">`Extraneous non-props attributes (`</span> +</span><br><span class="line">                <span class="string">`<span class="subst">$&#123;extraAttrs.join(<span class="string">&#x27;, &#x27;</span>)&#125;</span>) `</span> +</span><br><span class="line">                <span class="string">`were passed to component but could not be automatically inherited `</span> +</span><br><span class="line">                <span class="string">`because component renders fragment or text root nodes.`</span></span><br><span class="line">            )</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (eventAttrs.length) &#123;</span><br><span class="line">            warn(</span><br><span class="line">              <span class="string">`Extraneous non-emits event listeners (`</span> +</span><br><span class="line">                <span class="string">`<span class="subst">$&#123;eventAttrs.join(<span class="string">&#x27;, &#x27;</span>)&#125;</span>) `</span> +</span><br><span class="line">                <span class="string">`were passed to component but could not be automatically inherited `</span> +</span><br><span class="line">                <span class="string">`because component renders fragment or text root nodes. `</span> +</span><br><span class="line">                <span class="string">`If the listener is intended to be a component custom event listener only, `</span> +</span><br><span class="line">                <span class="string">`declare it using the &quot;emits&quot; option.`</span></span><br><span class="line">            )</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// inherit directives 存在指令</span></span><br><span class="line">    <span class="keyword">if</span> (vnode.dirs) &#123;</span><br><span class="line">      <span class="keyword">if</span> (__DEV__ &amp;&amp; !isElementRoot(root)) &#123;</span><br><span class="line">        warn(</span><br><span class="line">          <span class="string">`Runtime directive used on component with non-element root node. `</span> +</span><br><span class="line">            <span class="string">`The directives will not function as intended.`</span></span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">      root.dirs = root.dirs ? root.dirs.concat(vnode.dirs) : vnode.dirs</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// inherit transition data </span></span><br><span class="line">    <span class="keyword">if</span> (vnode.transition) &#123;</span><br><span class="line">      <span class="keyword">if</span> (__DEV__ &amp;&amp; !isElementRoot(root)) &#123;</span><br><span class="line">        warn(</span><br><span class="line">          <span class="string">`Component inside &lt;Transition&gt; renders non-element root node `</span> +</span><br><span class="line">            <span class="string">`that cannot be animated.`</span></span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">      root.transition = vnode.transition</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (__DEV__ &amp;&amp; setRoot) &#123;</span><br><span class="line">      setRoot(root)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      result = root</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    handleError(err, instance, ErrorCodes.RENDER_FUNCTION)</span><br><span class="line">    result = createVNode(Comment)</span><br><span class="line">  &#125;</span><br><span class="line">  currentRenderingInstance = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="normalizeVNode"><a href="#normalizeVNode" class="headerlink" title="normalizeVNode"></a>normalizeVNode</h6><p><code>packages/runtime-core/src/vnode.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">normalizeVNode</span>(<span class="params">child: VNodeChild</span>): <span class="title">VNode</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (child == <span class="literal">null</span> || <span class="keyword">typeof</span> child === <span class="string">&#x27;boolean&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">// empty placeholder 创建注释节点</span></span><br><span class="line">    <span class="keyword">return</span> createVNode(Comment)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isArray(child)) &#123;</span><br><span class="line">    <span class="comment">// fragment fragment节点</span></span><br><span class="line">    <span class="keyword">return</span> createVNode(Fragment, <span class="literal">null</span>, child)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> child === <span class="string">&#x27;object&#x27;</span>) &#123; <span class="comment">// 已经是一个vnode了</span></span><br><span class="line">    <span class="comment">// already vnode, this should be the most common since compiled templates</span></span><br><span class="line">    <span class="comment">// always produce all-vnode children arrays</span></span><br><span class="line">    <span class="keyword">return</span> child.el === <span class="literal">null</span> ? child : cloneVNode(child)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// strings and numbers 文本节点</span></span><br><span class="line">    <span class="keyword">return</span> createVNode(Text, <span class="literal">null</span>, <span class="built_in">String</span>(child))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="processFragment"><a href="#processFragment" class="headerlink" title="processFragment"></a>processFragment</h5><p><code>packages/runtime-core/src/renderer.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> processFragment = <span class="function">(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  n1: VNode | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  n2: VNode,</span></span></span><br><span class="line"><span class="params"><span class="function">  container: RendererElement,</span></span></span><br><span class="line"><span class="params"><span class="function">  anchor: RendererNode | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  parentComponent: ComponentInternalInstance | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  parentSuspense: SuspenseBoundary | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  isSVG: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  optimized: <span class="built_in">boolean</span></span></span></span><br><span class="line"><span class="params"><span class="function"></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> fragmentStartAnchor = (n2.el = n1 ? n1.el : hostCreateText(<span class="string">&#x27;&#x27;</span>))!</span><br><span class="line">  <span class="keyword">const</span> fragmentEndAnchor = (n2.anchor = n1 ? n1.anchor : hostCreateText(<span class="string">&#x27;&#x27;</span>))!</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> &#123; patchFlag, dynamicChildren &#125; = n2</span><br><span class="line">  <span class="keyword">if</span> (patchFlag &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    optimized = <span class="literal">true</span> <span class="comment">// 可以优化</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__DEV__ &amp;&amp; isHmrUpdating) &#123;</span><br><span class="line">    <span class="comment">// HMR updated, force full diff</span></span><br><span class="line">    patchFlag = <span class="number">0</span></span><br><span class="line">    optimized = <span class="literal">false</span></span><br><span class="line">    dynamicChildren = <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (n1 == <span class="literal">null</span>) &#123; <span class="comment">// 不存在n1</span></span><br><span class="line">    hostInsert(fragmentStartAnchor, container, anchor) <span class="comment">// 在container里面插入text文本节点</span></span><br><span class="line">    hostInsert(fragmentEndAnchor, container, anchor) <span class="comment">// 在container里面插入text文本节点</span></span><br><span class="line">    <span class="comment">// a fragment can only have array children</span></span><br><span class="line">    <span class="comment">// since they are either generated by the compiler, or implicitly created</span></span><br><span class="line">    <span class="comment">// from arrays.</span></span><br><span class="line">    <span class="comment">// fragment 只能有数组children </span></span><br><span class="line">    mountChildren(</span><br><span class="line">      n2.children <span class="keyword">as</span> VNodeArrayChildren,</span><br><span class="line">      container,</span><br><span class="line">      fragmentEndAnchor,</span><br><span class="line">      parentComponent,</span><br><span class="line">      parentSuspense,</span><br><span class="line">      isSVG,</span><br><span class="line">      optimized</span><br><span class="line">    )</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      patchFlag &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">      patchFlag &amp; PatchFlags.STABLE_FRAGMENT &amp;&amp;</span><br><span class="line">      dynamicChildren &amp;&amp;</span><br><span class="line">      <span class="comment">// #2715 the previous fragment could&#x27;ve been a BAILed one as a result</span></span><br><span class="line">      <span class="comment">// of renderSlot() with no valid children</span></span><br><span class="line">      n1.dynamicChildren</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="comment">// a stable fragment (template root or &lt;template v-for&gt;) doesn&#x27;t need to</span></span><br><span class="line">      <span class="comment">// patch children order, but it may contain dynamicChildren.</span></span><br><span class="line">      patchBlockChildren(</span><br><span class="line">        n1.dynamicChildren,</span><br><span class="line">        dynamicChildren,</span><br><span class="line">        container,</span><br><span class="line">        parentComponent,</span><br><span class="line">        parentSuspense,</span><br><span class="line">        isSVG</span><br><span class="line">      )</span><br><span class="line">      <span class="keyword">if</span> (__DEV__ &amp;&amp; parentComponent &amp;&amp; parentComponent.type.__hmrId) &#123;</span><br><span class="line">        traverseStaticChildren(n1, n2)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">        <span class="comment">// #2080 if the stable fragment has a key, it&#x27;s a &lt;template v-for&gt; that may</span></span><br><span class="line">        <span class="comment">//  get moved around. Make sure all root level vnodes inherit el.</span></span><br><span class="line">        <span class="comment">// #2134 or if it&#x27;s a component root, it may also get moved around</span></span><br><span class="line">        <span class="comment">// as the component is being moved.</span></span><br><span class="line">        n2.key != <span class="literal">null</span> ||</span><br><span class="line">        (parentComponent &amp;&amp; n2 === parentComponent.subTree)</span><br><span class="line">      ) &#123;</span><br><span class="line">        traverseStaticChildren(n1, n2, <span class="literal">true</span> <span class="comment">/* shallow */</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// keyed / unkeyed, or manual fragments.</span></span><br><span class="line">      <span class="comment">// for keyed &amp; unkeyed, since they are compiler generated from v-for,</span></span><br><span class="line">      <span class="comment">// each child is guaranteed to be a block so the fragment will never</span></span><br><span class="line">      <span class="comment">// have dynamicChildren.</span></span><br><span class="line">      patchChildren(</span><br><span class="line">        n1,</span><br><span class="line">        n2,</span><br><span class="line">        container,</span><br><span class="line">        fragmentEndAnchor,</span><br><span class="line">        parentComponent,</span><br><span class="line">        parentSuspense,</span><br><span class="line">        isSVG,</span><br><span class="line">        optimized</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="mountChildren"><a href="#mountChildren" class="headerlink" title="mountChildren"></a>mountChildren</h6><p><code>packages/runtime-core/src/renderer.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// mountChildren 循环调用 patch方法 挂载完子节点后 </span></span><br><span class="line"><span class="keyword">const</span> mountChildren: MountChildrenFn = <span class="function">(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    children,</span></span></span><br><span class="line"><span class="params"><span class="function">    container,</span></span></span><br><span class="line"><span class="params"><span class="function">    anchor,</span></span></span><br><span class="line"><span class="params"><span class="function">    parentComponent,</span></span></span><br><span class="line"><span class="params"><span class="function">    parentSuspense,</span></span></span><br><span class="line"><span class="params"><span class="function">    isSVG,</span></span></span><br><span class="line"><span class="params"><span class="function">    optimized,</span></span></span><br><span class="line"><span class="params"><span class="function">    start = <span class="number">0</span></span></span></span><br><span class="line"><span class="params"><span class="function">  </span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 循环调用patch 中间根据 optimized 是调用 cloneIfMounted 还是  normalizeVNode</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = start; i &lt; children.length; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> child = (children[i] = optimized</span><br><span class="line">        ? cloneIfMounted(children[i] <span class="keyword">as</span> VNode) <span class="comment">// cloneIfMounted 方法 判断的是如果挂载了 el是有值的 </span></span><br><span class="line">        : normalizeVNode(children[i]))</span><br><span class="line">      patch(</span><br><span class="line">        <span class="literal">null</span>,</span><br><span class="line">        child,</span><br><span class="line">        container,</span><br><span class="line">        anchor,</span><br><span class="line">        parentComponent,</span><br><span class="line">        parentSuspense,</span><br><span class="line">        isSVG,</span><br><span class="line">        optimized</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>


</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Decade W</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://blog.decade.run/2021/04/06/vue3-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E4%B8%80/">http://blog.decade.run/2021/04/06/vue3-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E4%B8%80/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://blog.decade.run" target="_blank">王小明</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/learn/">learn</a><a class="post-meta__tags" href="/tags/vue/">vue</a></div><div class="post_share"><div class="social-share" data-image="/img/coverimg/vue.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/" target="_blank"><img class="post-qr-code-img" src="/"/></a><div class="post-qr-code-desc"></div></li><li class="reward-item"><a href="/" target="_blank"><img class="post-qr-code-img" src="/"/></a><div class="post-qr-code-desc"></div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/04/09/vite-%E6%96%87%E6%A1%A3%E5%AD%A6%E4%B9%A0/"><img class="prev-cover" src="/img/coverimg/vue.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">vite 文档学习</div></div></a></div><div class="next-post pull-right"><a href="/2021/02/24/JavaScript%E9%AB%98%E7%BA%A7%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E7%AC%AC%E5%9B%9B%E7%89%88-%E7%AC%AC%E5%8D%81%E4%BA%8C%E7%AB%A0-%E7%AC%94%E8%AE%B0/"><img class="next-cover" src="/img/post.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">JavaScript高级程序设计第四版-第十二章-笔记</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2021/06/11/defineAsyncComponent/" title="defineAsyncComponent"><img class="cover" src="/img/coverimg/vue.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-06-11</div><div class="title">defineAsyncComponent</div></div></a></div><div><a href="/2021/04/28/vue3-源码阅读-三/" title="vue3 源码阅读 watch"><img class="cover" src="/img/coverimg/vue.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-28</div><div class="title">vue3 源码阅读 watch</div></div></a></div><div><a href="/2021/04/17/vue3-源码阅读-二/" title="vue3-源码阅读 reactive模块"><img class="cover" src="/img/coverimg/vue.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-17</div><div class="title">vue3-源码阅读 reactive模块</div></div></a></div><div><a href="/2020/09/23/quick-start-vue3-1/" title="quick start vue3 - 1"><img class="cover" src="/img/coverimg/vue.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-09-23</div><div class="title">quick start vue3 - 1</div></div></a></div><div><a href="/2020/09/22/vue-skill/" title="vue-skill-1"><img class="cover" src="/img/coverimg/vue.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-09-22</div><div class="title">vue-skill-1</div></div></a></div><div><a href="/2020/09/14/use-vue3-0/" title="use-vue3.0"><img class="cover" src="/img/coverimg/vue.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-09-14</div><div class="title">use-vue3.0</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Decade W</div><div class="author-info__description">博客,记录,生活,学习,成长</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">59</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">21</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">18</div></a></div></div><a class="button--animated" id="card-info-btn" href="https://blog.decade.run/"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/WangMaoquan" target="_blank" title="Github"><i class="fa fa-github"></i></a><a class="social-icon" href="/shixindonga@gmail.com" target="_blank" title="Email"><i class="fa fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fa fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%8E%E5%88%9B%E5%BB%BA%E5%88%B0%E6%8C%82%E8%BD%BD%E5%AE%8C%E6%88%90"><span class="toc-number">1.</span> <span class="toc-text">从创建到挂载完成</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#createApp"><span class="toc-number">1.1.</span> <span class="toc-text">createApp</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#createRenderer"><span class="toc-number">1.1.1.</span> <span class="toc-text">createRenderer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#createAppAPI"><span class="toc-number">1.1.2.</span> <span class="toc-text">createAppAPI</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mount"><span class="toc-number">1.2.</span> <span class="toc-text">mount</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#createVNode"><span class="toc-number">1.2.1.</span> <span class="toc-text">createVNode</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#render"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">render</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#createComponentInstance"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">createComponentInstance</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#normalizePropsOptions"><span class="toc-number">1.2.1.2.1.</span> <span class="toc-text">normalizePropsOptions</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#normalizeEmitsOptions"><span class="toc-number">1.2.1.2.2.</span> <span class="toc-text">normalizeEmitsOptions</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#createRenderContext"><span class="toc-number">1.2.1.2.3.</span> <span class="toc-text">createRenderContext</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#setupComponent"><span class="toc-number">1.2.1.3.</span> <span class="toc-text">setupComponent</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#initProps"><span class="toc-number">1.2.1.3.1.</span> <span class="toc-text">initProps</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#initSlots"><span class="toc-number">1.2.1.3.2.</span> <span class="toc-text">initSlots</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#setupStatefulComponent"><span class="toc-number">1.2.1.3.3.</span> <span class="toc-text">setupStatefulComponent</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#exposePropsOnRenderContext"><span class="toc-number">1.2.1.3.3.1.</span> <span class="toc-text">exposePropsOnRenderContext</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#callWithErrorHandling"><span class="toc-number">1.2.1.3.3.2.</span> <span class="toc-text">callWithErrorHandling</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#handleSetupResult"><span class="toc-number">1.2.1.3.3.3.</span> <span class="toc-text">handleSetupResult</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#setupRenderEffect"><span class="toc-number">1.2.1.4.</span> <span class="toc-text">setupRenderEffect</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#createDevEffectOptions"><span class="toc-number">1.2.1.4.1.</span> <span class="toc-text">createDevEffectOptions</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#renderComponentRoot"><span class="toc-number">1.2.1.4.2.</span> <span class="toc-text">renderComponentRoot</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#normalizeVNode"><span class="toc-number">1.2.1.4.2.1.</span> <span class="toc-text">normalizeVNode</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#processFragment"><span class="toc-number">1.2.1.4.3.</span> <span class="toc-text">processFragment</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#mountChildren"><span class="toc-number">1.2.1.4.3.1.</span> <span class="toc-text">mountChildren</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2021/06/11/defineAsyncComponent/" title="defineAsyncComponent"><img src="/img/coverimg/vue.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="defineAsyncComponent"/></a><div class="content"><a class="title" href="/2021/06/11/defineAsyncComponent/" title="defineAsyncComponent">defineAsyncComponent</a><time datetime="2021-06-11T12:32:27.000Z" title="发表于 2021-06-11 20:32:27">2021-06-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/06/01/%E9%9D%A2%E8%AF%95%E9%A2%98/" title="面试题"><img src="/img/post.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="面试题"/></a><div class="content"><a class="title" href="/2021/06/01/%E9%9D%A2%E8%AF%95%E9%A2%98/" title="面试题">面试题</a><time datetime="2021-06-01T14:37:33.000Z" title="发表于 2021-06-01 22:37:33">2021-06-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/05/30/webpack%E6%90%AD%E5%BB%BAvue3/" title="webpack搭建vue3 chat"><img src="/img/coverimg/webpack.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="webpack搭建vue3 chat"/></a><div class="content"><a class="title" href="/2021/05/30/webpack%E6%90%AD%E5%BB%BAvue3/" title="webpack搭建vue3 chat">webpack搭建vue3 chat</a><time datetime="2021-05-29T18:34:56.000Z" title="发表于 2021-05-30 02:34:56">2021-05-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/05/18/diff/" title="diff"><img src="/img/post.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="diff"/></a><div class="content"><a class="title" href="/2021/05/18/diff/" title="diff">diff</a><time datetime="2021-05-17T17:29:19.000Z" title="发表于 2021-05-18 01:29:19">2021-05-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/05/09/Vue-Router-api/" title="Vue-Router api"><img src="/img/coverimg/vue.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Vue-Router api"/></a><div class="content"><a class="title" href="/2021/05/09/Vue-Router-api/" title="Vue-Router api">Vue-Router api</a><time datetime="2021-05-09T12:33:58.000Z" title="发表于 2021-05-09 20:33:58">2021-05-09</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By Decade W</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi,  welcome  to  my  <a  href="http://blog.decade.run/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><div class="js-pjax"></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/lib/autoload.js" async></script></body></html>